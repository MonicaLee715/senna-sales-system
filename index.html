<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Senna Sales System</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
nav { margin-bottom: 20px; }
nav button { margin-right: 10px; padding: 5px 10px; }
section { display: none; }
section.active { display: block; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
table, th, td { border: 1px solid #ccc; }
th, td { padding: 5px; text-align: left; }
img.product-img { width: 80px; height: 80px; object-fit: contain; cursor: pointer; }
div.product-card { border:1px solid #ccc; padding:5px; margin:5px; display:inline-block; width:120px; text-align:center; cursor:pointer; }
</style>
</head>
<body>

<h1>Senna Sales System</h1>

<nav>
  <button onclick="showSection('sales')">销售</button>
  <button onclick="showSection('inventory')">库存情况</button>
  <button onclick="showSection('records')">销售记录</button>
</nav>

<!-- 销售页面 -->
<section id="sales">
  <h2>销售页面</h2>
  <div id="productList"></div>
</section>

<!-- 库存情况页面 -->
<section id="inventory">
  <h2>库存情况</h2>
  <table id="inventoryTable">
    <thead>
      <tr><th>产品系列</th><th>颜色</th><th>库存</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <h3>新增库存</h3>
  <label>产品变体ID：<input type="text" id="newVariantId"></label>
  <label>数量：<input type="number" id="newStock" value="0"></label>
  <button onclick="addStock()">提交</button>
</section>

<!-- 销售记录页面 -->
<section id="records">
  <h2>销售记录</h2>
  <label>客户：
    <select id="customerSelect"></select>
  </label>
  <label>起始日期：<input type="date" id="startDate"></label>
  <label>结束日期：<input type="date" id="endDate"></label>
  <button onclick="loadSalesRecords()">查询</button>

  <table id="salesTable">
    <thead>
      <tr>
        <th>销售ID</th>
        <th>日期</th>
        <th>产品变体</th>
        <th>数量</th>
        <th>单价</th>
        <th>总金额</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbz8GIoUqiQdjXIuYFkgEVwTLmYcX2bapf2IL7VR4TBPQg76FUn83C-ZeGqhmkWoxkED2A/exec';

// 页面切换
function showSection(id) {
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (id === 'sales') loadProducts();
  if (id === 'inventory') loadInventory();
  if (id === 'records') loadCustomers();
}

// --------------------
// 1️⃣ 销售页面
// --------------------
function loadProducts() {
  fetch(`${API_URL}?action=getProducts`)
    .then(r => r.json())
    .then(res => {
      const list = document.getElementById('productList');
      list.innerHTML = '';
      res.data.forEach(product => {
        const div = document.createElement('div');
        div.className = 'product-card';
        div.innerHTML = `
          <img class="product-img" src="${product.product_image}" alt="${product.model_name}">
          <div>${product.model_name}</div>
        `;
        div.onclick = () => selectVariantAndSell(product.model_id, product.model_name);
        list.appendChild(div);
      });
    });
}

// 点击产品系列后，选择变体下单
function selectVariantAndSell(model_id, model_name) {
  fetch(`${API_URL}?action=getProductVariants&model_id=${model_id}`)
    .then(r => r.json())
    .then(res => {
      if (res.data.length === 0) { alert('暂无可售变体'); return; }
      let msg = `选择变体下单:\n`;
      res.data.forEach((v, i) => {
        msg += `${i+1}: ${v.color} (库存: ${v.stock}, 价格: ${v.price})\n`;
      });
      const choice = prompt(msg + '输入编号:');
      const index = parseInt(choice) - 1;
      if (isNaN(index) || index < 0 || index >= res.data.length) return;
      const variant = res.data[index];

      const qty = parseInt(prompt(`输入购买数量 (库存: ${variant.stock}):`));
      if (isNaN(qty) || qty <= 0) return;
      if (qty > variant.stock) { alert('库存不足'); return; }

      let price = parseFloat(prompt(`输入单价 (默认: ${variant.price}):`, variant.price));
      if (isNaN(price) || price <= 0) price = variant.price;

      // 默认取第一个客户
      fetch(`${API_URL}?action=getCustomers`)
        .then(r => r.json())
        .then(custRes => {
          if (!custRes.data || custRes.data.length === 0) { alert('无客户信息'); return; }
          const customer_id = custRes.data[0].customer_id;

          fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({
              action: 'createSale',
              customer_id,
              variant_id: variant.variant_id,
              quantity: qty,
              unit_price: price
            }),
            headers: { 'Content-Type': 'application/json' }
          })
          .then(r => r.json())
          .then(res => {
            alert(res.message);
            loadInventory();
          });
        });
    });
}

// --------------------
// 2️⃣ 库存情况页面
// --------------------
function loadInventory() {
  const tbody = document.querySelector('#inventoryTable tbody');
  tbody.innerHTML = '';
  fetch(`${API_URL}?action=getProducts`)
    .then(r => r.json())
    .then(res => {
      res.data.forEach(product => {
        fetch(`${API_URL}?action=getProductVariants&model_id=${product.model_id}`)
          .then(r => r.json())
          .then(variants => {
            variants.data.forEach(v => {
              const row = document.createElement('tr');
              row.innerHTML = `<td>${product.model_name}</td><td>${v.color}</td><td>${v.stock}</td>`;
              tbody.appendChild(row);
            });
          });
      });
    });
}

// 新增库存
function addStock() {
  const variant_id = document.getElementById('newVariantId').value;
  const adjustment = parseInt(document.getElementById('newStock').value);
  if (!variant_id || isNaN(adjustment)) { alert('请填写正确数据'); return; }
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ action:'updateStock', variant_id, adjustment, operation:'increase' }),
    headers: { 'Content-Type': 'application/json' }
  })
  .then(r => r.json())
  .then(res => {
    alert(res.message);
    loadInventory();
  });
}

// --------------------
// 3️⃣ 销售记录页面
// --------------------
function loadCustomers() {
  const sel = document.getElementById('customerSelect');
  sel.innerHTML = '';
  fetch(`${API_URL}?action=getCustomers`)
    .then(r => r.json())
    .then(res => {
      res.data.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.customer_id;
        opt.textContent = c.name;
        sel.appendChild(opt);
      });
    });
}

function loadSalesRecords() {
  const customerId = document.getElementById('customerSelect').value;
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  fetch(`${API_URL}?action=getSalesRecords`)
    .then(r => r.json())
    .then(res => {
      const data = res.data.filter(s => s.customer_id === customerId &&
        (!startDate || s.date >= startDate) && (!endDate || s.date <= endDate));
      const tbody = document.querySelector('#salesTable tbody');
      tbody.innerHTML = '';
      data.forEach(s => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${s.sale_id}</td>
          <td>${s.date}</td>
          <td>${s.variant_id}</td>
          <td>${s.quantity}</td>
          <td>${s.unit_price}</td>
          <td>${s.total_amount}</td>
        `;
        tbody.appendChild(row);
      });
    });
}

// 默认显示销售页面
showSection('sales');
</script>

</body>
</html>
