<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>赛娜眼镜进销存</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@latest/dist/jsQR.js"></script>
    <style>
        /* 基础重置和变量定义 */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-bg: #f5f5f5;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-muted: #666666;
            --border-color: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
            padding-bottom: 80px;
        }

        /* 顶部导航 */
        .app-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 15px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .icon-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.1rem;
            padding: 5px;
            cursor: pointer;
        }

        /* 主内容区 */
        .app-main {
            margin-top: 60px;
            padding: 15px;
            min-height: calc(100vh - 140px);
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }
   
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 底部导航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid var(--border-color);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-muted);
            font-size: 0.8rem;
            padding: 5px 10px;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 80px;
        }

        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        /* 卡片样式 */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
        }

        /* 页面管理 */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
            text-align: left;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: var(--card-bg);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-block {
            width: 100%;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-warning {
            background: var(--warning-color);
            color: #000;
        }

        .btn-danger {
            background: var(--danger-color);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

/* 产品选择按钮 */
.product-select-btn {
    background: var(--light-bg);
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 12px;  /* 从20px改为12px */
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 12px;  /* 从15px改为12px */
}

.product-select-btn:hover {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.1);
}

.product-select-btn i {
    font-size: 1.2rem;  /* 从2rem改为1.2rem */
    color: var(--text-muted);
    margin-bottom: 5px;  /* 从8px改为5px */
}

.selected-product {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 12px;  /* 从15px改为12px */
    margin-bottom: 12px;  /* 从15px改为12px */
    border-left: 4px solid var(--primary-color);
}
        
/* === 新增的紧凑布局样式 === */
.selected-product-header {
    display: flex;
    align-items: center;
    gap: 10px;
}
        .stock-low {
    color: var(--danger-color);
}

.stock-warning {
    color: var(--warning-color);
}

.stock-normal {
    color: var(--success-color);
}


.add-item-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
}

.add-item-section h4 {
    margin-bottom: 15px;
    color: var(--text-color);
}


        /* 颜色选择 */

        .color-option.selected {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.15);
    font-weight: 600;
    color: var(--primary-color);
    box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
}
/* === 已选产品预览样式 === */
.selected-product-preview {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    border: 1px solid var(--border-color);
}

.preview-header h4 {
    margin-bottom: 10px;
    color: var(--text-color);
    font-size: 0.95rem;
    font-weight: 600;
}

.preview-content {
    display: flex;
    align-items: center;
    gap: 12px;
}

.preview-image {
    width: 45px;
    height: 45px;
    background: #e9ecef;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    color: var(--primary-color);
    flex-shrink: 0;
    overflow: hidden;  /* 确保图片不溢出 */
}

/* 确保图片在预览区域正确显示 */
.preview-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

.preview-info {
    flex: 1;
}

.preview-info h5 {
    margin-bottom: 4px;
    color: var(--text-color);
    font-size: 0.9rem;
    font-weight: 600;
}

.preview-info p {
    color: var(--text-muted);
    font-size: 0.8rem;
    margin: 0;
}
        /* 销售表单样式 */
        .sale-form {
            margin-top: 10px;
        }

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .item-list {
            margin-top: 20px;
        }

        .item-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-info h4 {
            margin-bottom: 5px;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qty-btn {
            background: #ddd;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
        }

        .total-section {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-body {
            padding: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        /* 产品选择网格 */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .product-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .product-card.selected {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        .product-image {
            width: 60px;
            height: 60px;
            background: #f0f0f0;
            border-radius: 6px;
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--text-muted);
        }

        .product-name {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .product-price {
            font-size: 0.8rem;
            color: var(--success-color);
            font-weight: 600;
        }

        .product-stock {
            font-size: 0.7rem;
            color: var(--text-muted);
        }



        /* 消息提示 */
        .message {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

       
        /* 添加在CSS文件的适当位置 */
.summary-item {
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    transition: transform 0.3s ease;
}

.summary-item:hover {
    transform: translateY(-2px);
}

.stock-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: var(--primary-color);
}
   
/* 新增颜色表单样式 */
.add-color-form {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    border: 1px solid var(--border-color);
}

.color-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 10px;
}

.color-form-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.color-form-actions .btn {
    flex: 1;
}

        /* 响应式设计 */
        @media (max-width: 768px) {
            .app-main {
                padding: 10px;
            }
            
            .card {
                padding: 12px;
            }
            
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        @media (max-width: 480px) {
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
        }
       /* ====== 销售单据样式美化 (细节优化版) ====== */
.receipt {
    max-width: 360px;
    margin: 0 auto;
    background: white;
    border-radius: 10px;
    padding: 18px;
    box-shadow: 0 3px 15px rgba(0, 0, 0, 0.07);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    color: #333;
    line-height: 1.4;
    border: 1px solid #eaeaea;
    font-size: 14px;
}

/* 顶部标题区 - 统一样式 */
.receipt-header {
    text-align: center;
    padding-bottom: 15px;
    margin-bottom: 18px;
    border-bottom: 2px solid #667eea;
    display: flex;
    justify-content: center;
    align-items: baseline;
    flex-wrap: nowrap;
    gap: 6px;
}

/* 统一标题文字样式 */
.receipt-title, 
.receipt-header > div:last-child {
    font-size: 20px; /* 统一字号 */
    font-weight: 700;
    color: #2d3748;
    letter-spacing: 0.5px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    white-space: nowrap;
}

/* 单据信息区 */
.receipt-info {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    margin-bottom: 14px;
    padding: 12px 14px;
    background: #f8f9fa;
    border-radius: 7px;
    border-left: 3px solid #4fd1c7;
    font-size: 13.5px;
}

.receipt-info > div {
    color: #555;
    margin: 3px 0;
    font-weight: 500;
}

.receipt-info > div:first-child {
    color: #2d3748;
    font-weight: 600;
}

/* 客户信息 */
.receipt-info:last-of-type {
    background: #edf2f7;
    border-left-color: #4299e1;
    padding: 12px 14px;
    font-size: 14px;
}

.receipt-info:last-of-type > div {
    font-weight: 600;
    color: #2d3748;
}

/* 分隔线 */
.receipt-divider {
    height: 1px;
    background: linear-gradient(to right, transparent, #ddd, transparent);
    margin: 18px 0;
}

/* 商品明细区域 - 加大字体 */
.receipt-items {
    margin: 18px 0;
}

.receipt-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0; /* 增加行间距配合更大字体 */
    border-bottom: 1px dashed #e0e0e0;
}

.receipt-item:last-child {
    border-bottom: none;
}

.receipt-item-name {
    flex: 2;
    font-weight: 600;
    color: #2d3748;
    font-size: 14.5px; /* 商品名进一步加大 */
}

.receipt-item-details {
    flex: 1;
    text-align: right;
    color: #666;
    font-size: 14px; /* 价格信息进一步加大 */
    font-weight: 500;
}

/* 总计金额 - 缩小占比 */
.receipt-total {
    text-align: center;
    font-size: 18px; /* 适当缩小字号 */
    font-weight: 700;
    color: #2d3748;
    padding: 14px 16px; /* 减少垂直内边距 */
    margin: 18px 0;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}

.receipt-balance div {
    margin: 5px 0;
    font-weight: 500;
}

.receipt-balance div:last-child {
    color: #c2410c;
    font-weight: 700;
}

/* 底部品牌信息 */
.receipt-footer {
    text-align: center;
    padding-top: 16px;
    margin-top: 20px;
    border-top: 1px solid #eee;
    color: #888;
    font-size: 12.5px;
    font-weight: 500;
    letter-spacing: 0.5px;
}
        /* 新增扫码动画效果 */
@keyframes scan {
    0% {
        top: 0;
        opacity: 1;
    }
    50% {
        top: calc(100% - 2px);
        opacity: 1;
    }
    51% {
        opacity: 0;
    }
    100% {
        top: 0;
        opacity: 0;
    }
}

/* 扫码框闪烁效果 */
@keyframes blink {
    0%, 100% { border-color: #4CAF50; }
    50% { border-color: #8BC34A; }
}

.scan-box {
    animation: blink 1.5s infinite;
}

/* 指导文本 */
.scan-guide {
    position: absolute;
    bottom: -30px;
    left: 0;
    width: 100%;
    text-align: center;
    color: white;
    font-size: 14px;
    text-shadow: 0 1px 3px rgba(0,0,0,0.7);
}
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <header class="app-header">
        <div class="header-content">
            <h1 class="app-title" id="pageTitle">扫码</h1>
            <div class="header-actions">
                <button class="icon-btn" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="app-main">
        <!-- 加载状态 -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>系统初始化中...</p>
            <div id="initDebug" class="debug-info"></div>
        </div>
        
        <!-- 动态内容区 -->
        <div id="content" style="display: none;">
<!-- 库存管理页面 -->
<div id="scan-page" class="page active">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">库存管理</h3>
            <button class="btn btn-warning" id="manualInputBtn" style="padding: 8px 12px;">
                <i class="fas fa-keyboard"></i>手动输入
            </button>
        </div>
        
        <div class="scan-section" style="text-align: center; padding: 20px;">
            <!-- 扫码区域 -->
            <div class="scan-area" style="margin-bottom: 20px;">
                <div class="feature-icon">
                    <i class="fas fa-qrcode" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 15px;"></i>
                </div>
                <h3 style="margin-bottom: 10px;">扫描商品二维码</h3>
                <p style="color: var(--text-muted); margin-bottom: 20px;">扫描产品二维码查看库存并进行调整</p>
                
                <button class="btn" id="startScan" style="max-width: 200px; margin: 0 auto 15px;">
                    <i class="fas fa-camera"></i>开始扫码
                </button>
                
                <div style="margin: 15px 0; color: var(--text-muted);">或</div>
                
                <div class="form-group" style="text-align: left;">
                    <label class="form-label">手动输入商品ID/二维码</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-input" id="manualVariantId" placeholder="输入V001, V002等" style="flex: 1;">
                        <button class="btn" id="manualSearchBtn" style="white-space: nowrap;">
                            <i class="fas fa-search"></i>查询
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 库存信息展示区 -->
            <div id="inventoryInfo" style="display: none;">
                <div class="selected-product-preview" style="margin-bottom: 20px;">
                    <div class="preview-content">
                        <div class="preview-image" id="previewProductImage">
    ${this.selectedProduct?.product_image ? 
        `<img src="${this.selectedProduct.product_image.replace(/\s+/g, '')}" 
             alt="${this.selectedProduct.model_name}" 
             style="width: 100%; height: 100%; object-fit: cover;">` : 
        `<i class="fas fa-glasses"></i>`
    }
</div>
                        <div class="preview-info">
                            <h5 id="inventoryProductName">产品名称</h5>
                            <p id="inventoryProductColor">颜色: 未选择</p>
                            <p id="inventoryProductModel">型号: 未选择</p>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="background: #f8f9fa; margin-bottom: 20px;">
                    <h4 style="text-align: center; margin-bottom: 15px;">当前库存信息</h4>
                    <div style="font-size: 2rem; text-align: center; font-weight: bold; color: var(--primary-color); margin-bottom: 10px;" id="currentStock">0</div>
                    <p style="text-align: center; color: var(--text-muted);">当前库存数量</p>
                    
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                        <p style="font-size: 0.9rem; color: var(--text-muted);">
                            <i class="fas fa-info-circle"></i> 最后更新: <span id="lastUpdated">-</span>
                        </p>
                    </div>
                </div>
                
                <!-- 库存调整表单 -->
                <div class="inventory-adjustment">
                    <h4 style="margin-bottom: 15px;">库存调整</h4>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">调整类型</label>
                            <select class="form-select" id="adjustType">
                                <option value="increase">增加库存</option>
                                <option value="decrease">减少库存</option>
                                <option value="set">设置库存</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">数量</label>
                            <input type="number" class="form-input" id="adjustQuantity" value="1" min="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">调整原因</label>
                        <select class="form-select" id="adjustReason">
                            <option value="sale">销售出库</option>
                            <option value="purchase">采购入库</option>
                            <option value="return">客户退货</option>
                            <option value="damage">商品报损</option>
                            <option value="adjustment">库存盘点调整</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">备注</label>
                        <input type="text" class="form-input" id="adjustRemark" placeholder="可输入备注信息（选填）">
                    </div>
                    
                    <div class="form-row" style="margin-top: 20px;">
                        <button class="btn btn-success" id="confirmAdjust" style="flex: 1;">
                            <i class="fas fa-check"></i>确认调整
                        </button>
                        <button class="btn btn-outline" id="cancelAdjust" style="flex: 1;">
                            <i class="fas fa-times"></i>取消
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="scanMessage"></div>
</div>

          <!-- 线下销售页面 -->
<div id="sale-page" class="page">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">线下销售出库</h3>
            <button class="btn btn-warning" onclick="app.useTestData()" style="padding: 8px 12px;">
                <i class="fas fa-vial"></i>测试数据
            </button>
        </div>
        
        <div class="sale-form">
            <!-- 1. 客户选择 -->
            <div class="form-group">
                <label class="form-label">选择客户</label>
                <select class="form-select" id="customerSelect">
                    <option value="">请选择客户...</option>
                </select>
            </div>

            <!-- 3. 添加新商品区域 -->
            <div class="add-item-section">
                <h4>添加新商品</h4>
                
                <!-- 产品选择按钮 -->
                <div class="product-select-btn" id="saleProductSelectBtn">
                    <i class="fas fa-plus-circle"></i>
                    <div>点击选择产品</div>
                </div>

              <!-- 已选产品预览 -->
<!-- 已选产品预览 -->
<div class="selected-product-preview" id="selectedProductPreview" style="display: none;">
    <div class="preview-header">
        <h4>已选产品</h4>
    </div>
    <div class="preview-content">
        <div class="preview-image" id="previewProductImage">
            <!-- 这里会通过JavaScript动态更新 -->
            <i class="fas fa-glasses"></i>
        </div>
        <div class="preview-info">
            <h5 id="previewProductName">产品名称</h5>
        </div>
    </div>
</div>

                <!-- 颜色选择 -->
                <div class="color-selection" id="saleColorSelection" style="display: none;">
                    <label class="form-label">选择颜色</label>
                    <div class="color-options" id="saleColorOptions">
                        <!-- 颜色选项将通过JS动态生成 -->
                    </div>
                </div>
<div class="form-row">
    <div class="form-group">
        <label class="form-label">数量</label>
        <input type="number" class="form-input" id="saleQuantity" value="1" min="1">
    </div>
    <div class="form-group">
        <label class="form-label">单价</label>
        <div class="price-display" style="
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-weight: 600;
        ">
            ¥<span id="priceDisplay">0</span>
            <div id="priceNote" class="price-note" style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;"></div>
        </div>
    </div>
</div>

                <button class="btn btn-block" id="addItemBtn">
                    <i class="fas fa-plus"></i>添加到销售单
                </button>
                <!-- 2. 当前销售商品清单 -->
            <div class="item-list" id="saleItems" style="display: none;">
                <h4>当前销售商品</h4>
                <div id="itemsList"></div>
                
                <div class="total-section">
                    总计: ¥<span id="totalAmount">0</span>
                </div>
            </div>
            </div>
            
            <!-- 4. 确认销售按钮 -->
            <button class="btn btn-success btn-block" id="confirmSale" style="display: none;">
                <i class="fas fa-check-circle"></i>确认销售出库
            </button>
        </div>
    </div>

    <div id="saleMessage"></div>

    <!-- 销售单预览 -->
    <div id="invoicePreview" class="card" style="display: none;">
        <div class="card-header">
            <h3 class="card-title">销售单预览</h3>
            <button class="btn" id="downloadInvoice">
                <i class="fas fa-download"></i>下载销售单
            </button>
        </div>
        <div id="invoiceContent"></div>
    </div>
</div>

          <!-- 库存情况页面 -->
<div id="data-page" class="page">
    <div class="card">
        <div class="card-header">
    <h3 class="card-title">库存情况</h3>
    <div style="display: flex; gap: 8px;">
        <button class="btn" id="refreshStockBtn" style="padding: 6px 12px; font-size: 0.85rem;">
            <i class="fas fa-sync-alt"></i>
        </button>
        <button class="btn btn-success" id="addProductBtn" style="padding: 6px 12px; font-size: 0.85rem;">
            <i class="fas fa-plus"></i> 新增商品
        </button>
    </div>
</div>
        
        <!-- 筛选条件 - 只保留状态筛选 -->
        <div class="filter-section" style="margin-bottom: 15px;">
            <div style="display: flex; gap: 8px; align-items: center;">
                <div style="flex: 1;">
                    <select class="form-select" id="stockFilterStatus" style="padding: 8px; font-size: 0.9rem;">
                        <option value="">所有库存状态</option>
                        <option value="low">库存紧张（≤5）</option>
                        <option value="warning">库存较少（6-10）</option>
                        <option value="normal">库存充足（>10）</option>
                    </select>
                </div>
                <button class="btn" id="searchStockBtn" style="padding: 8px 16px; white-space: nowrap;">
                    <i class="fas fa-filter"></i>筛选
                </button>
                <button class="btn" id="clearFilterBtn" style="padding: 8px 12px; background: #f8f9fa; color: var(--text-muted);">
                    <i class="fas fa-times"></i>清除
                </button>
            </div>
        </div>
        
        <!-- 库存统计 -->
        <div class="stock-summary" style="margin-bottom: 15px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                <div class="summary-item" id="stockNormal" style="padding: 10px; border-radius: 6px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #166534;">0</div>
                    <div style="font-size: 0.75rem; color: #166534;">充足</div>
                </div>
                <div class="summary-item" id="stockWarning" style="padding: 10px; border-radius: 6px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #92400e;">0</div>
                    <div style="font-size: 0.75rem; color: #92400e;">较少</div>
                </div>
                <div class="summary-item" id="stockLow" style="padding: 10px; border-radius: 6px;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #991b1b;">0</div>
                    <div style="font-size: 0.75rem; color: #991b1b;">紧张</div>
                </div>
            </div>
        </div>
        
        <!-- 产品卡片列表 -->
        <div id="stockListContent">
            <div style="text-align: center; padding: 30px 15px; color: #666;">
                <i class="fas fa-boxes" style="font-size: 2.5rem; margin-bottom: 10px; color: var(--text-muted);"></i>
                <p style="margin-bottom: 10px;">点击按钮加载库存数据</p>
                <button class="btn" id="initialLoadStock" style="padding: 8px 20px;">
                    <i class="fas fa-sync-alt"></i>加载库存数据
                </button>
            </div>
        </div>
    </div>
</div>

            <!-- 基础数据页面 -->
            <div id="base-page" class="page">
                <div class="card">
                    <div class="feature-icon" style="text-align: center; font-size: 2rem; color: var(--primary-color); margin-bottom: 15px;">
                        <i class="fas fa-cog"></i>
                    </div>
                    <h3 style="text-align: center;">基础数据管理</h3>
                    <p style="text-align: center; color: var(--text-muted); margin-bottom: 20px;">产品、客户管理等设置</p>
                    <div class="status-badge" style="background: #fff3cd; color: #856404; padding: 8px 12px; border-radius: 6px; text-align: center;">
                        功能开发中
                    </div>
                </div>
            </div>
        </div>
    <!-- 摄像头扫描界面 -->
<div id="cameraModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>扫描商品二维码</h3>
            <button class="close-btn" id="closeCameraModal">&times;</button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; position: relative;">
    <!-- 扫描区域容器 -->
    <div class="camera-frame" style="position: relative; display: inline-block;">
        <video id="cameraPreview" autoplay playsinline 
               style="width: 100%; max-width: 300px; border-radius: 8px;"></video>
        
        <!-- 新增：扫描框叠加层 -->
        <div class="scan-overlay" style="
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        ">
            <!-- 扫描框 -->
            <div class="scan-box" style="
                position: absolute;
                top: 20%;
                left: 10%;
                width: 80%;
                height: 60%;
                border: 2px solid #4CAF50;
                border-radius: 8px;
                box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.4);
            ">
                <!-- 四个角 -->
                <div style="position: absolute; top: 0; left: 0; width: 20px; height: 20px; border-top: 3px solid #4CAF50; border-left: 3px solid #4CAF50; border-radius: 4px 0 0 0;"></div>
                <div style="position: absolute; top: 0; right: 0; width: 20px; height: 20px; border-top: 3px solid #4CAF50; border-right: 3px solid #4CAF50; border-radius: 0 4px 0 0;"></div>
                <div style="position: absolute; bottom: 0; left: 0; width: 20px; height: 20px; border-bottom: 3px solid #4CAF50; border-left: 3px solid #4CAF50; border-radius: 0 0 0 4px;"></div>
                <div style="position: absolute; bottom: 0; right: 0; width: 20px; height: 20px; border-bottom: 3px solid #4CAF50; border-right: 3px solid #4CAF50; border-radius: 0 0 4px 0;"></div>
                
                <!-- 扫描线 -->
                <div class="scan-line" style="
                    position: absolute;
                    top: 0;
                    left: 10%;
                    width: 80%;
                    height: 2px;
                    background: linear-gradient(90deg, transparent, #4CAF50, transparent);
                    animation: scan 2s ease-in-out infinite;
                "></div>
            </div>
        </div>
    </div>
    
    <div id="cameraStatus" style="margin: 15px 0; color: var(--text-muted);">
        将二维码放入绿色框内自动识别
    </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-outline" id="cancelScanBtn">
                        <i class="fas fa-times"></i>取消扫描
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
        <!-- 新增商品弹窗 -->
<div id="addProductModal" class="modal" onclick="event.stopPropagation()">
    <div class="modal-content">
        <div class="modal-header">
            <h3>新增商品</h3>
            <button class="close-btn" id="closeAddProductModal">&times;</button>
        </div>
        <div class="modal-body">
            <div id="addProductForm">
                <div class="form-group">
                    <label class="form-label">产品系列型号 *</label>
                    <input type="text" class="form-input" id="newModelId" placeholder="如: M001, M002等">
                    <div class="price-note">格式: 类型JGRN，有无框NFH，镜片PCE，数字</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">产品系列名称 *</label>
                    <input type="text" class="form-input" id="newModelName" placeholder="如: 经典金属系列">
                </div>
                
                <div class="form-group">
    <label class="form-label">颜色和库存 *</label>
    <div id="colorInputs">
        <div class="color-stock-row" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
            <div style="flex: 1;">
                <input type="text" class="form-input color-input" placeholder="颜色名称，如: 黑色" style="width: 100%; margin-bottom: 5px;">
                <input type="number" class="form-input stock-input" placeholder="库存数量" value="0" min="0" style="width: 100%;">
            </div>
            <button type="button" class="btn btn-danger" onclick="app.removeColorInput(this)" style="padding: 6px 12px; align-self: center;">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <button type="button" class="btn btn-outline" onclick="app.addColorInput()" style="width: 100%; margin-top: 10px;">
        <i class="fas fa-plus"></i> 添加更多颜色
    </button>
    <div class="price-note">每个颜色可以设置不同的库存数量</div>
</div>

                
                <div class="form-group">
                    <label class="form-label">标准价格</label>
                    <input type="number" class="form-input" id="newStandardPrice" value="0" min="0">
                    <div class="price-note">可填写价格，如果不填默认为0</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">产品图片URL（选填）</label>
                    <input type="text" class="form-input" id="newProductImage" placeholder="https://example.com/image.jpg">
                    <div class="price-note">粘贴产品图片的完整网址</div>
                </div>

                                <!-- 新增：位置输入 -->
                <div class="form-group">
                    <label class="form-label">位置（选填）</label>
                    <input type="text" class="form-input" id="newProductLocation" placeholder="如：A01-1">
                    <div class="price-note">填写商品存放位置，方便查找</div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-success btn-block" onclick="app.submitNewProduct()">
                        <i class="fas fa-check"></i> 确认新增商品
                    </button>
                    <button class="btn btn-outline btn-block" onclick="app.closeAddProductModal()" style="margin-top: 10px;">
                        <i class="fas fa-times"></i> 取消
                    </button>
                </div>
                
                <div id="addProductMessage" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>
</div>
    </main>

    <!-- 产品选择弹窗 -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>选择产品系列</h3>
                <button class="close-btn" id="closeProductModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="product-grid" id="modalProductGrid">
                    <!-- 产品卡片将通过JS动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 底部导航 -->
    <nav class="bottom-nav">
        <a href="#scan" class="nav-item active" data-page="scan">
        <i class="fas fa-boxes"></i>  <!-- 修改图标为库存图标 -->
        <span>库存管理</span>  <!-- 修改文字 -->
        </a>
        <a href="#sale" class="nav-item" data-page="sale">
            <i class="fas fa-receipt"></i>
            <span>线下销售</span>
        </a>
        <a href="#data" class="nav-item" data-page="data">
    <i class="fas fa-boxes"></i>  <!-- 改为库存图标 -->
    <span>库存情况</span>  <!-- 改为库存情况 -->
</a>
        <a href="#base" class="nav-item" data-page="base">
            <i class="fas fa-cog"></i>
            <span>基础数据</span>
        </a>
    </nav>

    <script>
        // API配置
const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbxxxNe7aV7N7tKlKgzLMl2rvN1MaxJka3Vxkv2cQcjT5_HY4XDkIO2-i1dl5cM5lb7r/exec';        
        class App {
constructor() {
    this.currentPage = 'scan';
    this.saleItems = [];
    this.productVariants = {};
    this.products = [];
    this.customers = [];
    this.salesRecords = [];
    this.selectedProduct = null;
    this.selectedVariant = null;
    this.useTestMode = false;
    this.productModalSource = null;
    this.stream = null;  // ← 在这里添加这一行
    this.colorCount = 1;  // 添加这行
    this.qrDetectionInterval = null;
    
    // 批量价格缓存
    this.standardPrices = {};
    this.customerPrices = {};
    this.allVariants = [];
    
    this.currentCustomerId = null;
    this.customerChangeTimeout = null;
    
    this.init();
}
            
init() {
    this.bindEvents();
    this.bindInventoryEvents();  // 添加这一行
    this.hideLoading();
    this.loadInitialData();
    this.bindAddProductEvents();  // 绑定新增商品事件
    // 新增：绑定库存页面事件
    setTimeout(() => {
        this.bindStockEvents();
    }, 1000);
}
            
            bindEvents() {
                // 底部导航点击事件
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = item.getAttribute('data-page');
                        this.switchPage(page);
                    });
                });
                
                // 扫码页面事件
                document.getElementById('startScan').addEventListener('click', () => {
                    this.startScan();
                });
                
                // 销售页面事件
document.getElementById('customerSelect').addEventListener('change', (e) => {
    clearTimeout(this.customerChangeTimeout);
    this.customerChangeTimeout = setTimeout(() => {
        this.clearSaleForm();
        // 只更新价格，不查询欠款
        if (this.selectedProduct) {
            this.showColorSelection('sale');
        }
        if (this.selectedVariant) {
            const customerId = e.target.value;
            const price = this.getPrice(this.selectedVariant.variant_id, customerId);
            
            const priceDisplay = document.getElementById('priceDisplay');
            if (priceDisplay) {
                priceDisplay.textContent = price;
            }
            
            const priceNote = document.getElementById('priceNote');
            if (priceNote) {
                if (customerId && this.customerPrices[customerId]?.[this.selectedVariant.variant_id] !== undefined) {
                    priceNote.textContent = '客户专属价格';
                    priceNote.className = 'price-note special-price';
                } else {
                    priceNote.textContent = '标准价格';
                    priceNote.className = 'price-note';
                }
            }
        }
    }, 300);
});
                
                document.getElementById('saleProductSelectBtn').addEventListener('click', () => {
                    this.openProductModal('sale');
                });
                
                document.getElementById('saleQuantity').addEventListener('change', () => {
                    this.updateItemTotal();
                });
                
                document.getElementById('addItemBtn').addEventListener('click', () => {
                    this.addSaleItem();
                });
                
                document.getElementById('confirmSale').addEventListener('click', () => {
                    this.confirmSale();
                });

                document.getElementById('downloadInvoice').addEventListener('click', () => {
                    this.downloadInvoice();
                });

                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.refreshData();
                });

                // 弹窗事件
                document.getElementById('closeProductModal').addEventListener('click', () => {
                    this.closeProductModal();
                });

                // 点击弹窗外部关闭
                document.getElementById('productModal').addEventListener('click', (e) => {
                    if (e.target.id === 'productModal') {
                        this.closeProductModal();
                    }
                });
                // 颜色选项的事件委托（处理动态生成的元素）
document.addEventListener('click', (e) => {
    if (e.target.closest('.color-option')) {
        const colorOption = e.target.closest('.color-option');
        const variantId = colorOption.dataset.variantId;
        // 判断是扫码页面还是销售页面的颜色选项
        const source = colorOption.closest('#scanColorOptions') ? 'scan' : 'sale';
        this.selectVariant(variantId, source);
    }
});
            }

            // 添加库存管理相关事件绑定
bindInventoryEvents() {
    // 手动输入按钮
    document.getElementById('manualInputBtn').addEventListener('click', () => {
        document.getElementById('manualVariantId').focus();
    });
    
    // 手动查询按钮
    document.getElementById('manualSearchBtn').addEventListener('click', () => {
        const variantId = document.getElementById('manualVariantId').value.trim();
        if (variantId) {
            this.lookupInventory(variantId);
        } else {
            this.showMessage('scanMessage', '请输入商品ID', 'error');
        }
    });
    
    // 回车键触发查询
    document.getElementById('manualVariantId').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            document.getElementById('manualSearchBtn').click();
        }
    });
    
    // 确认调整库存
    document.getElementById('confirmAdjust').addEventListener('click', () => {
        this.confirmInventoryAdjustment();
    });
    
    // 取消调整
    document.getElementById('cancelAdjust').addEventListener('click', () => {
        this.hideInventoryInfo();
    });
    
    // 调整类型变化时
    document.getElementById('adjustType').addEventListener('change', (e) => {
        if (e.target.value === 'set') {
            document.getElementById('adjustQuantity').placeholder = '输入要设置的库存数量';
        } else {
            document.getElementById('adjustQuantity').placeholder = '';
        }
    });
}
            
            // 打开产品选择弹窗
            openProductModal(source) {
                this.productModalSource = source;
                this.renderProductModal();
                document.getElementById('productModal').classList.add('show');
            }

            // 关闭产品选择弹窗
            closeProductModal() {
                document.getElementById('productModal').classList.remove('show');
                this.productModalSource = null;
            }

            // 渲染产品选择弹窗
            renderProductModal() {
                const container = document.getElementById('modalProductGrid');
                container.innerHTML = '';
                
                this.products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.dataset.modelId = product.model_id;
                    productCard.innerHTML = `
    <div class="product-image" style="display: flex; align-items: center; justify-content: center; overflow: hidden;">
        ${product.product_image ? 
            `<img src="${product.product_image.replace(/\s+/g, '')}" 
                 alt="${product.model_name}" 
                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">` : 
            `<i class="fas fa-glasses" style="font-size: 1.5rem; color: #999;"></i>`
        }
    </div>
    <div class="product-name">${product.model_name}</div>
    <div class="product-stock">点击选择</div>
`;
                    
                    productCard.addEventListener('click', () => {
                        this.selectProductInModal(product.model_id);
                    });
                    
                    container.appendChild(productCard);
                });
            }

// 在弹窗中选择产品
selectProductInModal(modelId) {
    this.selectedProduct = this.products.find(p => p.model_id === modelId);
    this.closeProductModal();
    
    document.getElementById('selectedProductPreview').style.display = 'block';
    document.getElementById('previewProductName').textContent = this.selectedProduct.model_name;
    document.getElementById('saleColorSelection').style.display = 'block';
// 确保更新图片显示
    this.updateSaleProductDisplay();  // 添加这一行
    this.showColorSelection('sale');
}
            
// 显示已选产品预览
showSelectedProductPreview() {
    const previewElement = document.getElementById('selectedProductPreview');
    const productNameElement = document.getElementById('previewProductName');
    const productModelElement = document.getElementById('previewProductModel');
    const productDetailsElement = document.getElementById('previewProductDetails');
    
    if (this.selectedProduct) {
        productNameElement.textContent = this.selectedProduct.model_name;
        productModelElement.textContent = `型号: ${this.selectedProduct.model_id}`;
        productDetailsElement.textContent = '颜色: 未选择 | 价格: ¥0 | 库存: 0';
        previewElement.style.display = 'block';
    } else {
        previewElement.style.display = 'none';
    }
}

// 更新销售页面的产品显示
updateSaleProductDisplay() {
    console.log('=== updateSaleProductDisplay 开始 ===');
    
    const previewElement = document.getElementById('selectedProductPreview');
    const previewImage = document.getElementById('previewProductImage');
    
    if (this.selectedProduct) {
        console.log('有选中产品，开始更新显示');
        
        // 直接使用 selectedProduct 的产品图片
        if (this.selectedProduct.product_image) {
            previewImage.innerHTML = `
                <img src="${this.selectedProduct.product_image.replace(/\s+/g, '')}" 
                     alt="${this.selectedProduct.model_name}" 
                     style="width: 100%; height: 100%; object-fit: cover;">
            `;
        } else {
            previewImage.innerHTML = '<i class="fas fa-glasses"></i>';
        }
        
        previewElement.style.display = 'block';
        document.getElementById('previewProductName').textContent = this.selectedProduct.model_name;
        
        console.log('产品基本信息已更新');
    } else {
        console.log('没有选中产品，隐藏预览区域');
        previewElement.style.display = 'none';
    }
    
    console.log('=== updateSaleProductDisplay 结束 ===');
}

// 显示颜色选择
async showColorSelection(source) {
    const colorSelection = source === 'scan' ? 
        document.getElementById('scanColorSelection') : 
        document.getElementById('saleColorSelection');
    
    const colorOptions = source === 'scan' ? 
        document.getElementById('scanColorOptions') : 
        document.getElementById('saleColorOptions');
    
    colorSelection.style.display = 'block';
    colorOptions.innerHTML = '';
    
    const variants = this.productVariants[this.selectedProduct.model_id] || [];
    
    // 遍历所有变体创建颜色选项
    for (const variant of variants) {
        const colorOption = document.createElement('div');
colorOption.className = 'color-option';
colorOption.dataset.variantId = variant.variant_id;

// 根据库存显示不同的样式
const stockClass = variant.stock <= 5 ? 'stock-low' : 
                   variant.stock <= 10 ? 'stock-warning' : 'stock-normal';
const stockText = variant.stock <= 5 ? '紧张' : 
                  variant.stock <= 10 ? '较少' : '充足';

colorOption.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <div style="font-weight: 500; font-size: 0.95rem;">${variant.color}</div>
            <div style="font-size: 0.8rem; color: #666;">
                ID: ${variant.variant_id}
            </div>
        </div>
        <div style="text-align: right;">
            <div style="font-weight: bold; font-size: 1rem; color: var(--primary-color);">
                ¥${variant.price}
            </div>
            <div style="font-size: 0.8rem; color: #666; display: flex; align-items: center; gap: 5px;">
                <span>库存: ${variant.stock}</span>
                <span style="
                    padding: 1px 6px;
                    background: ${stockClass === 'stock-low' ? '#fee2e2' : 
                                 stockClass === 'stock-warning' ? '#fef3c7' : '#dcfce7'};
                    color: ${stockClass === 'stock-low' ? '#991b1b' : 
                             stockClass === 'stock-warning' ? '#92400e' : '#166534'};
                    border-radius: 10px;
                    font-size: 0.7rem;
                ">
                    ${stockText}
                </span>
            </div>
        </div>
    </div>
`;
        
        colorOptions.appendChild(colorOption);
    }
}



        // === 新方法：从缓存获取价格（同步，无网络请求）===
getPrice(variantId, customerId) {
    if (!variantId) {
        console.log('getPrice: variantId为空');
        return 0;
    }
    
    console.log(`getPrice调用: variantId=${variantId}, customerId=${customerId}`);
    
    // 1. 优先客户专属价
    if (customerId && 
        this.customerPrices[customerId] && 
        this.customerPrices[customerId][variantId] !== undefined) {
        
        const price = this.customerPrices[customerId][variantId];
        console.log(`使用客户专属价: ¥${price} (客户: ${customerId})`);
        return price;
    }
    
    // 2. 其次标准价
    if (this.standardPrices[variantId] !== undefined) {
        const price = this.standardPrices[variantId];
        console.log(`使用标准价: ¥${price}`);
        return price;
    }
    
    // 3. 都没找到，尝试从变体数据中找
    const variant = this.allVariants.find(v => v.variant_id === variantId);
    if (variant) {
        console.log(`从变体数据获取价格: ¥${variant.price}`);
        // 顺便更新缓存
        this.standardPrices[variantId] = variant.price;
        return variant.price;
    }
    
    console.log('未找到价格，返回0');
    return 0;
}

// === 修改颜色选择方法 ===
async selectVariant(variantId, source) {
    console.log(`selectVariant: ${variantId}, source: ${source}`);
    
    // 更新选中状态
    const colorOptions = source === 'scan' ? 
        document.getElementById('scanColorOptions') : 
        document.getElementById('saleColorOptions');
    
    // 移除所有选中状态
    document.querySelectorAll('.color-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // 查找选中的变体
    this.selectedVariant = this.findVariantById(variantId);
    
    if (!this.selectedVariant) {
        console.log('未找到变体:', variantId);
        return;
    }
    
    // 更新显示
    if (source === 'sale') {
        // === 关键修改：直接从缓存获取价格 ===
        const customerId = document.getElementById('customerSelect').value;
        const price = this.getPrice(variantId, customerId);
        
        console.log(`获取到价格: ¥${price}, 客户: ${customerId || '未选择'}`);
        
        // 更新价格显示
        const priceDisplay = document.getElementById('priceDisplay');
        if (priceDisplay) {
            priceDisplay.textContent = price;
        }
        
        // 更新价格提示
        const priceNote = document.getElementById('priceNote');
        if (priceNote) {
            if (customerId && this.customerPrices[customerId]?.[variantId] !== undefined) {
                priceNote.textContent = '客户专属价格';
                priceNote.className = 'price-note special-price';
            } else {
                priceNote.textContent = '标准价格';
                priceNote.className = 'price-note';
            }
        }
        
        // 更新颜色选项显示
        const selectedOption = document.querySelector(`.color-option[data-variant-id="${variantId}"]`);
        if (selectedOption) {
            selectedOption.classList.add('selected');
        }
        
    }
}


            // 使用测试数据
            useTestData() {
                this.useTestMode = true;
                this.addTestCustomers();
                this.addTestProducts();
                this.loadTestSalesRecords();
                this.showMessage('saleMessage', '已切换到测试模式，使用模拟数据', 'success');
            }
            
            async refreshData() {
                this.showMessage('saleMessage', '重新加载数据中...', 'success');
                await this.loadInitialData();
            }
            
            switchPage(page) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-page="${page}"]`).classList.add('active');
                
                this.showPage(page);
                this.currentPage = page;
                this.updatePageTitle(page);
            }
            
            showPage(page) {
                document.querySelectorAll('.page').forEach(pageEl => {
                    pageEl.classList.remove('active');
                });
                
                const targetPage = document.getElementById(`${page}-page`);
                if (targetPage) {
                    targetPage.classList.add('active');
                }
            }
            
           updatePageTitle(page) {
    const titles = {
        'scan': '库存管理',
        'sale': '线下销售', 
        'data': '数据查看',
        'base': '基础数据'
    };
    document.getElementById('pageTitle').textContent = titles[page] || '赛娜眼镜进销存';
}
            
            hideLoading() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            }
            
            async loadInitialData() {
                const debugInfo = document.getElementById('initDebug');
                debugInfo.innerHTML = '开始加载初始数据...';
                
                try {
                    await this.loadCustomers();
                    await this.loadProducts();
                    await this.loadSalesRecords();
                    debugInfo.innerHTML = '数据加载完成！';
                } catch (error) {
                    debugInfo.innerHTML = `数据加载失败: ${error.message}`;
                    this.useTestData();
                    this.showMessage('scanMessage', '使用测试数据模式', 'warning');
                    this.showMessage('saleMessage', '使用测试数据模式', 'warning');
                }
            }
            
            async loadCustomers() {
                try {
                    const response = await fetch(`${API_BASE_URL}?action=getCustomers&t=${Date.now()}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.customers = data.data;
                        const select = document.getElementById('customerSelect');
                        select.innerHTML = '<option value="">请选择客户...</option>';
                        
                        data.data.forEach(customer => {
                            const option = document.createElement('option');
                            option.value = customer.customer_id;
                            option.textContent = customer.name;
                            select.appendChild(option);
                        });
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    console.error('加载客户失败:', error);
                    throw error;
                }
            }

            addTestCustomers() {
                this.customers = [
                    { customer_id: 'C001', name: '张三贸易' },
                    { customer_id: 'C002', name: '李四光学' },
                    { customer_id: 'C003', name: '王五眼镜店' },
                    { customer_id: 'C004', name: '网店客户' }
                ];
                
                const select = document.getElementById('customerSelect');
                select.innerHTML = '<option value="">请选择客户...</option>';
                this.customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.customer_id;
                    option.textContent = customer.name;
                    select.appendChild(option);
                });
            }
            
           async loadProducts() {
    try {
        const response = await fetch(`${API_BASE_URL}?action=getProducts&t=${Date.now()}`);
        const data = await response.json();
        
        if (data.success) {
            this.products = data.data;
            
            // === 新增：批量加载所有变体 ===
            await this.loadAllVariants();
            // ============================
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('加载产品失败:', error);
        throw error;
    }
}

// === 新增方法：批量加载所有变体 ===
async loadAllVariants() {
    try {
        // ===== 必须有的防护：加载前清空旧数据 =====
        this.productVariants = {}; // 清空产品-变体索引
        this.allVariants = [];     // 清空总变体列表
        // ========================================
        console.log('开始批量加载所有变体...');
        const allVariants = [];
        const standardPrices = {};
        
        // ===== 关键修复：清空现有数据，避免累积 =====
        this.productVariants = {};
        // ===========================================
        
        // 为每个产品系列加载变体
        for (const product of this.products) {
            const response = await fetch(`${API_BASE_URL}?action=getProductVariants&model_id=${product.model_id}&t=${Date.now()}`);
            const data = await response.json();
            
            if (data.success && data.data) {
                // ===== 关键修复：去重逻辑 =====
                const uniqueVariants = [];
                const seenVariants = new Set();
                
                data.data.forEach(variant => {
                    const key = `${variant.variant_id}_${variant.color}`;
                    if (!seenVariants.has(key)) {
                        seenVariants.add(key);
                        uniqueVariants.push(variant);
                    } else {
                        console.warn(`发现重复变体，已跳过: ${variant.variant_id} - ${variant.color}`);
                    }
                });
                // ==============================
                
                // 添加到总列表（使用去重后的数据）
                allVariants.push(...uniqueVariants);
                
                // 构建标准价缓存（使用去重后的数据）
                uniqueVariants.forEach(variant => {
                    standardPrices[variant.variant_id] = variant.price;
                    
                    // 确保productVariants结构正确（使用去重后的数据）
                    if (!this.productVariants[product.model_id]) {
                        this.productVariants[product.model_id] = [];
                    }
                    this.productVariants[product.model_id].push(variant);
                });
                
                console.log(`产品 ${product.model_id} 加载了 ${uniqueVariants.length} 个唯一变体`);
            }
        }
        
        // ===== 关键修复：对最终结果也去重一次（安全措施）=====
        const finalUniqueVariants = [];
        const finalSeenKeys = new Set();
        
        allVariants.forEach(variant => {
            const key = `${variant.variant_id}_${variant.color}`;
            if (!finalSeenKeys.has(key)) {
                finalSeenKeys.add(key);
                finalUniqueVariants.push(variant);
            }
        });
        // ================================================
        
        this.allVariants = finalUniqueVariants;
        this.standardPrices = standardPrices;
        console.log(`批量加载完成，共 ${finalUniqueVariants.length} 个唯一变体`);
        
    } catch (error) {
        console.error('批量加载变体失败，尝试逐个加载:', error);
        // 回退到原来的逐个加载方式，并确保填充 allVariants
        const allVariants = []; // 创建临时数组收集
        const seenVariants = new Set(); // 添加去重Set
        
        // ===== 关键修复：清空现有数据 =====
        this.productVariants = {};
        // ================================
        
        for (const product of this.products) {
            await this.loadProductVariants(product.model_id); // 这个方法会填充 this.productVariants
            
            // 将刚加载的变体也加入到总列表（需要去重）
            if (this.productVariants[product.model_id]) {
                this.productVariants[product.model_id].forEach(variant => {
                    const key = `${variant.variant_id}_${variant.color}`;
                    if (!seenVariants.has(key)) {
                        seenVariants.add(key);
                        allVariants.push(variant);
                    }
                });
            }
        }
        
        // 将收集到的所有变体存入 this.allVariants（已经去重）
        this.allVariants = allVariants;
        console.log(`回退加载完成，共 ${allVariants.length} 个唯一变体`);
    }
}

            // === 新增方法：加载客户所有专属价格 ===
async loadCustomerPrices(customerId) {
    if (!customerId) return;
    
    try {
        // 调用新API：getCustomerPrices（复数）
        const response = await fetch(`${API_BASE_URL}?action=getCustomerPrices&customer_id=${customerId}&t=${Date.now()}`);
        const data = await response.json();
        
        if (data.success) {
            // 存储格式: {V001: 280, V002: 290}
            this.customerPrices[customerId] = data.data || {};
            console.log(`已加载客户 ${customerId} 的专属价格，共 ${Object.keys(data.data || {}).length} 条`);
        }
    } catch (error) {
        console.error(`加载客户 ${customerId} 价格失败:`, error);
        this.customerPrices[customerId] = {};
    }
}

            addTestProducts() {
                this.products = [
                    { model_id: 'M001', model_name: '经典金属系列' },
                    { model_id: 'M002', model_name: '时尚塑胶系列' },
                    { model_id: 'M003', model_name: '运动休闲系列' }
                ];
                
                // 添加测试变体数据
                this.productVariants = {
                    'M001': [
                        { variant_id: 'V001', model_id: 'M001', color: '黑色', price: 299, stock: 50, product_image: '' },
                        { variant_id: 'V002', model_id: 'M001', color: '银色', price: 299, stock: 30, product_image: '' }
                    ],
                    'M002': [
                        { variant_id: 'V003', model_id: 'M002', color: '棕色', price: 199, stock: 25, product_image: '' }
                    ],
                    'M003': [
                        { variant_id: 'V004', model_id: 'M003', color: '蓝色', price: 399, stock: 40, product_image: '' }
                    ]
                };
            }

            async loadProductVariants(modelId) {
    try {
        const response = await fetch(`${API_BASE_URL}?action=getProductVariants&model_id=${modelId}&t=${Date.now()}`);
        const data = await response.json();
        
        if (data.success) {
            // ===== 关键修复：添加去重逻辑 =====
            const uniqueVariants = [];
            const seenVariants = new Set();
            
            data.data.forEach(variant => {
                const key = `${variant.variant_id}_${variant.color}`;
                if (!seenVariants.has(key)) {
                    seenVariants.add(key);
                    uniqueVariants.push(variant);
                } else {
                    console.warn(`发现重复变体，已跳过: ${variant.variant_id} - ${variant.color}`);
                }
            });
            // ==============================
            
            this.productVariants[modelId] = uniqueVariants;
        }
    } catch (error) {
        console.error(`加载产品变体失败 (${modelId}):`, error);
    }
}

           findVariantById(variantId) {
    // 1. 首先在总列表 allVariants 中查找（速度快）
    let variant = this.allVariants.find(v => v.variant_id === variantId);
    if (variant) return variant;
    
    // 2. 如果没找到，再遍历 productVariants 结构查找（确保不遗漏）
    for (const modelId in this.productVariants) {
        variant = this.productVariants[modelId].find(v => v.variant_id === variantId);
        if (variant) {
            // 顺便把它加入 allVariants 缓存，下次就快了
            this.allVariants.push(variant);
            return variant;
        }
    }
    return null; // 确实没找到
}

            async loadSalesRecords() {
                try {
                    const response = await fetch(`${API_BASE_URL}?action=getSalesRecords&t=${Date.now()}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.salesRecords = data.data;
                    }
                } catch (error) {
                    console.error('加载销售记录失败:', error);
                    // 不抛出错误，因为销售记录不是关键数据
                }
            }

            loadTestSalesRecords() {
                this.salesRecords = [
                    { sale_id: 'S001', customer_id: 'C001', total_amount: 598, status: '待收款' },
                    { sale_id: 'S002', customer_id: 'C001', total_amount: 897, status: '待收款' },
                    { sale_id: 'S003', customer_id: 'C002', total_amount: 199, status: '待收款' }
                ];
            }

// 清空销售表单
clearSaleForm() {
    this.saleItems = [];
    this.updateSaleItemsDisplay();
    this.selectedProduct = null;
    this.selectedVariant = null;
    
    // 重置产品选择 - 确保使用正确的显示控制
    document.getElementById('selectedProductPreview').style.display = 'none';
    document.getElementById('saleProductSelectBtn').style.display = 'block';
    document.getElementById('saleColorSelection').style.display = 'none';
    document.getElementById('saleColorOptions').innerHTML = '';
    document.getElementById('saleQuantity').value = 1;

    
    // 修复：添加元素存在性检查
    const priceNoteElement = document.getElementById('priceNote');
    if (priceNoteElement) {
        priceNoteElement.innerHTML = '';
    }
    
    this.showMessage('saleMessage', '已清空销售清单', 'success');
}

async updateCustomerBalance(customerId) {
    if (!customerId) return;
    
    // 只加载客户专属价格
    await this.loadCustomerPrices(customerId);
    
    // 更新价格显示
    if (this.selectedVariant) {
        const price = this.getPrice(this.selectedVariant.variant_id, customerId);
        
        if (document.getElementById('priceDisplay')) {
            document.getElementById('priceDisplay').textContent = price;
        }
        
        const priceNote = document.getElementById('priceNote');
        if (priceNote) {
            if (customerId && this.customerPrices[customerId]?.[this.selectedVariant.variant_id] !== undefined) {
                priceNote.textContent = '客户专属价格';
                priceNote.className = 'price-note special-price';
            } else {
                priceNote.textContent = '标准价格';
                priceNote.className = 'price-note';
            }
        }
    }
}

            

            updateItemTotal() {
                // 如果需要实时计算总价可以在这里实现
            }
            
            addSaleItem() {
    const customerId = document.getElementById('customerSelect').value;
    const quantity = parseInt(document.getElementById('saleQuantity').value);
    
    // === 修改：不再从输入框获取，而是自动计算 ===
    // const unitPrice = parseFloat(document.getElementById('unitPrice').value);
    const unitPrice = this.getPrice(this.selectedVariant.variant_id, customerId);
    // ==========================================
    
    if (!customerId) {
        this.showMessage('saleMessage', '请选择客户', 'error');
        return;
    }

    if (!this.selectedVariant) {
        this.showMessage('saleMessage', '请选择产品颜色', 'error');
        return;
    }

    if (!quantity || quantity < 1) {
        this.showMessage('saleMessage', '请输入正确的数量', 'error');
        return;
    }

    // === 修改：价格验证逻辑 ===
    if (!unitPrice || unitPrice <= 0) {
        this.showMessage('saleMessage', '价格获取失败，请重新选择产品', 'error');
        return;
    }

    if (this.selectedVariant.stock < quantity) {
        this.showMessage('saleMessage', `库存不足，当前库存: ${this.selectedVariant.stock}`, 'error');
        return;
    }
    
    const item = {
        customerId,
        variantId: this.selectedVariant.variant_id,
        variantName: `${this.selectedProduct.model_name} - ${this.selectedVariant.color}`,
        quantity,
        unitPrice: unitPrice,  // 使用自动计算的价格
        total: quantity * unitPrice
    };
    
    this.saleItems.push(item);
    this.updateSaleItemsDisplay();
    this.showMessage('saleMessage', '商品已添加到销售单', 'success');
    
    // 重置数量
    document.getElementById('saleQuantity').value = 1;
}
            
updateSaleItemsDisplay() {
    const itemsList = document.getElementById('itemsList');
    const totalAmount = document.getElementById('totalAmount');
    const saleItemsSection = document.getElementById('saleItems');
    const confirmSaleBtn = document.getElementById('confirmSale');
    
    itemsList.innerHTML = '';
    let total = 0;
    
    this.saleItems.forEach((item, index) => {
        total += item.total;
        
        const itemCard = document.createElement('div');
        itemCard.className = 'item-card';
        itemCard.innerHTML = `
            <div class="item-info">
                <h4>${item.variantName}</h4>
                <p>数量: ${item.quantity} × ¥${item.unitPrice}</p>
            </div>
            <div class="item-actions">
                <span>¥${item.total}</span>
                <button class="qty-btn" onclick="app.removeSaleItem(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        itemsList.appendChild(itemCard);
    });
    
    totalAmount.textContent = total.toFixed(2);
    
    // 控制显示
    const hasItems = this.saleItems.length > 0;
    saleItemsSection.style.display = hasItems ? 'block' : 'none';
    confirmSaleBtn.style.display = hasItems ? 'block' : 'none';
}
            
            removeSaleItem(index) {
                this.saleItems.splice(index, 1);
                this.updateSaleItemsDisplay();
            }
            
            async confirmSale() {
                if (this.saleItems.length === 0) {
                    this.showMessage('saleMessage', '请添加销售商品', 'error');
                    return;
                }

                const customerId = document.getElementById('customerSelect').value;
                const customer = this.customers.find(c => c.customer_id === customerId);

                if (this.useTestMode) {
                    // 测试模式 - 模拟成功
                    this.showMessage('saleMessage', '测试模式: 销售出库成功！', 'success');
                    this.generateReceipt(customer.name);
                    this.clearSaleForm();
                    return;
                }

                try {
                    // 为每个商品创建销售记录
                    for (const item of this.saleItems) {
                        const saleData = {
                            customer_id: item.customerId,
                            variant_id: item.variantId,
                            quantity: item.quantity,
                            unit_price: item.unitPrice,  // ← 添加这行
                            operator: '销售员'
                        };

                        // 构建URL参数 - 确保参数正确传递
                        const params = new URLSearchParams();
                        params.append('action', 'createSale');
                        params.append('customer_id', saleData.customer_id);
                        params.append('variant_id', saleData.variant_id);
                        params.append('quantity', saleData.quantity.toString());
                        params.append('operator', saleData.operator);
                        params.append('unit_price', saleData.unit_price.toString());  // ← 添加这行

                        console.log('销售参数:', params.toString());

                        const response = await fetch(`${API_BASE_URL}?${params}`);
                        const result = await response.json();
                        
                        if (!result.success) {
                            throw new Error(result.message || `销售失败: ${item.variantName}`);
                        }
                    }

                    this.showMessage('saleMessage', '销售出库成功！', 'success');
                    this.generateReceipt(customer.name);
                    this.clearSaleForm();
                    
                    // 重新加载数据
                    await this.loadSalesRecords();
                    
                } catch (error) {
                    console.error('销售失败:', error);
                    this.showMessage('saleMessage', '销售失败: ' + error.message, 'error');
                }
            }

            generateReceipt(customerName) {
                const invoiceContent = document.getElementById('invoiceContent');
                const invoicePreview = document.getElementById('invoicePreview');
                const now = new Date();
                const invoiceNumber = 'SN' + now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0') + String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');

                let itemsHTML = '';
                let totalAmount = 0;

                this.saleItems.forEach(item => {
                    totalAmount += item.total;
                    itemsHTML += `
                        <div class="receipt-item">
                            <div class="receipt-item-name">${item.variantName}</div>
                            <div class="receipt-item-details">${item.quantity} × ¥${item.unitPrice}</div>
                        </div>
                        <div class="receipt-item">
                            <div class="receipt-item-name"></div>
                            <div class="receipt-item-details">¥${item.total}</div>
                        </div>
                    `;
                });

                const customerId = document.getElementById('customerSelect').value;

                invoiceContent.innerHTML = `
    <div class="receipt" id="receiptToDownload">
        <div class="receipt-header">
            <div class="receipt-title">赛娜眼镜</div>
            <div>销售单据</div>
        </div>
        
        <div class="receipt-info">
            <div>单号: ${invoiceNumber}</div>
            <div>日期: ${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}</div>
        </div>
        
        <div class="receipt-info">
            <div>客户: ${customerName}</div>
        </div>
                        
                        <div class="receipt-divider"></div>
                        
                        <div class="receipt-items">
                            ${itemsHTML}
                        </div>
                        
                        <div class="receipt-divider"></div>
                        
                        <div class="receipt-total">
                            合计: ¥${totalAmount.toFixed(2)}
                        </div>
                        
                        
                        <div class="receipt-footer">
                            <div>SENNA GLASSES</div>
                        </div>
                    </div>
                `;

                invoicePreview.style.display = 'block';
            }

            async downloadInvoice() {
                const receiptElement = document.getElementById('receiptToDownload');
                
                try {
                    const canvas = await html2canvas(receiptElement, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff'
                    });
                    
                    const link = document.createElement('a');
                    link.download = `赛娜眼镜销售单_${new Date().getTime()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    this.showMessage('saleMessage', '销售单下载成功', 'success');
                } catch (error) {
                    console.error('下载销售单失败:', error);
                    this.showMessage('saleMessage', '下载失败: ' + error.message, 'error');
                }
            }
            
async startScan() {
    console.log('=== 启动真实摄像头扫码 ===');
    
    // 检查设备类型
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    console.log('设备类型:', isMobile ? '移动设备' : '桌面设备');
    
    // 检查浏览器支持
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        this.showMessage('scanMessage', '您的浏览器不支持摄像头功能', 'error');
        this.startMockScan();
        return;
    }
    
    // 显示摄像头界面
    this.showCameraScanner();
}

            // 显示摄像头扫描界面
showCameraScanner() {
    const modal = document.getElementById('cameraModal');
    modal.classList.add('show');
    
    // 绑定关闭按钮
    document.getElementById('closeCameraModal').onclick = () => {
        this.stopCamera();
        modal.classList.remove('show');
    };
    
    document.getElementById('cancelScanBtn').onclick = () => {
        this.stopCamera();
        modal.classList.remove('show');
    };
    
    // 启动摄像头
    this.startCamera();
}

// 启动摄像头
async startCamera() {
    const video = document.getElementById('cameraPreview');
    const status = document.getElementById('cameraStatus');
    
    try {
        status.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                <i class="fas fa-camera"></i>
                <span>正在启动摄像头...</span>
            </div>
        `;
        status.style.color = 'var(--warning-color)';
        
        // 摄像头配置 - 提高分辨率
        const constraints = {
            video: {
                facingMode: 'environment', // 后置摄像头
                width: { ideal: 1920 },    // 提高分辨率
                height: { ideal: 1080 }
            },
            audio: false
        };
        
        this.stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = this.stream;
        
        await new Promise((resolve) => {
            video.onloadedmetadata = () => {
                video.play();
                resolve();
            };
        });
        
        // 更好的提示
        status.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                <i class="fas fa-qrcode" style="color: #4CAF50;"></i>
                <span>将二维码放入绿色框内，系统会自动识别</span>
            </div>
        `;
        status.style.color = 'var(--success-color)';
        
        // 开始二维码识别
        this.startQRCodeDetection(video);
        
    } catch (error) {
        console.error('摄像头启动失败:', error);
        
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            status.innerHTML = `
                <div style="color: var(--danger-color); text-align: center; padding: 10px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i><br>
                    <strong>需要摄像头权限</strong><br>
                    <small style="font-size: 0.9rem;">请在浏览器设置中允许摄像头访问，然后刷新页面重试</small>
                </div>
            `;
            
            setTimeout(() => {
                document.getElementById('cameraModal').classList.remove('show');
                this.showMessage('scanMessage', '请允许摄像头权限后重试', 'error');
            }, 4000);
            
        } else if (error.name === 'NotFoundError') {
            status.innerHTML = `
                <div style="color: var(--danger-color); text-align: center;">
                    <i class="fas fa-video-slash"></i><br>
                    未找到摄像头设备
                </div>
            `;
            
        } else {
            status.innerHTML = `
                <div style="color: var(--danger-color); text-align: center;">
                    <i class="fas fa-exclamation-circle"></i><br>
                    摄像头错误: ${error.message}
                </div>
            `;
        }
        
        // 回退到模拟扫码
        setTimeout(() => {
            document.getElementById('cameraModal').classList.remove('show');
            this.startMockScan();
        }, 3000);
    }
}

stopCamera() {
    // 停止动画效果
    const scanLine = document.querySelector('.scan-line');
    if (scanLine) {
        scanLine.style.animation = 'none';
    }
    
    // 停止二维码识别
    if (this.qrDetectionInterval) {
        clearInterval(this.qrDetectionInterval);
        this.qrDetectionInterval = null;
    }
    
    // 停止摄像头
    if (this.stream) {
        this.stream.getTracks().forEach(track => {
            track.stop();
        });
        this.stream = null;
    }
    
    const video = document.getElementById('cameraPreview');
    if (video) {
        video.srcObject = null;
    }
    
    console.log('摄像头已完全停止');
}
           // 开始二维码识别
startQRCodeDetection(video) {
    console.log('开始二维码识别...');
    
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    const status = document.getElementById('cameraStatus');
    
    // 设置canvas为固定尺寸，对应扫描框区域
    canvas.width = 300;  // 固定宽度
    canvas.height = 300; // 固定高度
    
    this.qrDetectionInterval = setInterval(() => {
        if (!this.stream || !video.videoWidth) {
            console.log('摄像头未就绪，停止识别');
            clearInterval(this.qrDetectionInterval);
            return;
        }
        
        try {
            // 只截取扫描框区域的图像进行识别
            // 计算扫描框在视频中的位置（20% top, 10% left, 80% width, 60% height）
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            
            // 扫描框在视频中的位置和大小
            const scanBoxX = videoWidth * 0.1;  // 左边距10%
            const scanBoxY = videoHeight * 0.2; // 上边距20%
            const scanBoxWidth = videoWidth * 0.8;  // 宽度80%
            const scanBoxHeight = videoHeight * 0.6; // 高度60%
            
            // 绘制扫描框区域到canvas
            context.drawImage(
                video, 
                scanBoxX, scanBoxY, scanBoxWidth, scanBoxHeight,  // 源图像位置和尺寸
                0, 0, canvas.width, canvas.height                 // 目标canvas位置和尺寸
            );
            
            // 获取图像数据
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            
            // 使用jsQR识别二维码
            const code = jsQR(imageData.data, canvas.width, canvas.height, {
                inversionAttempts: "dontInvert",
            });
            
            if (code) {
                console.log('识别到二维码:', code.data);
                clearInterval(this.qrDetectionInterval);
                this.handleScannedQRCode(code.data);
                
                // 添加成功反馈
                status.textContent = '✓ 扫码成功！';
                status.style.color = 'var(--success-color)';
                
                // 扫描框变绿色闪烁
                const scanBox = document.querySelector('.scan-box');
                if (scanBox) {
                    scanBox.style.borderColor = '#4CAF50';
                    scanBox.style.boxShadow = '0 0 0 1000px rgba(0, 0, 0, 0.4), 0 0 20px #4CAF50';
                }
            }
            
        } catch (error) {
            console.error('二维码识别出错:', error);
        }
    }, 200); // 加快扫描频率，每200毫秒一次
}

// 处理识别到的二维码
handleScannedQRCode(qrData) {
    console.log('处理二维码数据:', qrData);
    
    // 播放提示音（可选）
    this.playScanSuccessSound();
    
    // 停止摄像头
    this.stopCamera();
    
    // 关闭摄像头界面
    document.getElementById('cameraModal').classList.remove('show');
    
    // 提取产品型号（改为提取model_id）
const modelId = this.extractModelIdFromQR(qrData);

if (modelId) {
    // 显示产品所有变体
    this.showProductAllVariants(modelId);
    
    this.showMessage('scanMessage', `扫码成功: ${modelId}`, 'success');
} else {
    this.showMessage('scanMessage', '无法识别的产品二维码', 'error');
    
    // 3秒后重新启动扫码
    setTimeout(() => {
        this.showCameraScanner();
    }, 3000);
}
}

// 播放扫码成功音效（可选）
playScanSuccessSound() {
    try {
        // 创建短暂的提示音
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.5);
        
    } catch (error) {
        console.log('音效播放失败:', error);
        // 不影响主要功能
    }
} 

// 模拟扫码（备用）
startMockScan() {
    this.showMessage('scanMessage', '使用模拟扫码功能...', 'warning');
    
    // 随机选择一个测试商品
    const mockVariantIds = ['V001', 'V002', 'V003', 'V004'];
    const randomVariantId = mockVariantIds[Math.floor(Math.random() * mockVariantIds.length)];
    
    document.getElementById('manualVariantId').value = randomVariantId;
    this.lookupInventory(randomVariantId);
    
    this.showMessage('scanMessage', `模拟扫码: ${randomVariantId}`, 'success');
}
            
// 从二维码内容提取商品ID
extractModelIdFromQR(qrContent) {
    console.log('解析二维码内容:', qrContent);
    
    // 1. 直接返回内容（最简单的方式）
    const trimmed = qrContent.trim();
    
    // 2. 如果是URL，尝试提取参数
    if (trimmed.includes('model_id=')) {
        const match = trimmed.match(/model_id=([^&]+)/);
        if (match && match[1]) {
            return decodeURIComponent(match[1]);
        }
    }
    
    if (trimmed.includes('model=')) {
        const match = trimmed.match(/model=([^&]+)/);
        if (match && match[1]) {
            return decodeURIComponent(match[1]);
        }
    }
    
    // 3. 返回原内容
    return trimmed;
}

// 查找库存信息
async lookupInventory(input) {
    const trimmedInput = input.trim();
    
    // 1. 首先尝试作为产品ID查找
    const product = this.products.find(p => p.model_id === trimmedInput);
    if (product) {
        this.showProductAllVariants(trimmedInput);
        return;
    }
    
    // 2. 尝试作为变体ID查找
    const variant = this.findVariantById(trimmedInput);
    if (variant) {
        const product = this.products.find(p => p.model_id === variant.model_id);
        this.showInventoryInfo(variant, product);
        return;
    }
    
    // 3. 都没找到，显示错误
    this.showMessage('scanMessage', '请输入正确的商品ID或变体ID', 'error');
}

// 显示库存信息
// 显示库存信息
showInventoryInfo(variant, product) {
    const inventoryInfo = document.getElementById('inventoryInfo');
    
    // 更新显示信息
    document.getElementById('inventoryProductName').textContent = product.model_name;
    document.getElementById('inventoryProductColor').textContent = `颜色: ${variant.color}`;
    document.getElementById('inventoryProductModel').textContent = `型号: ${product.model_id} | 变体ID: ${variant.variant_id}`;
    document.getElementById('currentStock').textContent = variant.stock;
    
    // 更新最后更新时间
    const now = new Date();
    document.getElementById('lastUpdated').textContent = 
        `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    
    // 显示库存信息区域
    inventoryInfo.style.display = 'block';
    
    // 滚动到库存区域
    inventoryInfo.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    this.showMessage('scanMessage', `已找到: ${product.model_name} - ${variant.color}`, 'success');
}

// 隐藏库存信息
hideInventoryInfo() {
    document.getElementById('inventoryInfo').style.display = 'none';
    document.getElementById('manualVariantId').value = '';
    this.showMessage('scanMessage', '已取消操作', 'warning');
}

// 确认库存调整
async confirmInventoryAdjustment() {
    const variant = this.selectedVariant;
    if (!variant) {
        this.showMessage('scanMessage', '请先选择商品', 'error');
        return;
    }
    
    const adjustType = document.getElementById('adjustType').value;
    const quantity = parseInt(document.getElementById('adjustQuantity').value);
    const reason = document.getElementById('adjustReason').value;
    const remark = document.getElementById('adjustRemark').value.trim();
    
    if (!quantity || quantity < 1) {
        this.showMessage('scanMessage', '请输入有效的数量', 'error');
        return;
    }
    
    let newStock = variant.stock;
    let operation = '';
    
    switch (adjustType) {
        case 'increase':
            newStock += quantity;
            operation = '增加';
            break;
        case 'decrease':
            if (variant.stock < quantity) {
                this.showMessage('scanMessage', `库存不足，当前库存: ${variant.stock}`, 'error');
                return;
            }
            newStock -= quantity;
            operation = '减少';
            break;
        case 'set':
            newStock = quantity;
            operation = '设置';
            break;
    }

    // ===== 从这里开始，插入以下代码 =====
// 计算要发送给后端的调整量 (adjustment)
let adjustment;
if (adjustType === 'set') {
    // 如果是“设置”，调整量 = 新库存 - 老库存
    adjustment = newStock - variant.stock;
} else if (adjustType === 'increase') {
    // 如果是“增加”，调整量为正数
    adjustment = quantity;
} else if (adjustType === 'decrease') {
    // 如果是“减少”，调整量为负数！！！这是关键
    adjustment = -quantity;
}
    
    if (this.useTestMode) {
        // 测试模式 - 模拟更新
        variant.stock = newStock;
        this.showInventoryInfo(variant, this.selectedProduct);
        this.showMessage('scanMessage', `测试模式: ${operation}库存成功！新库存: ${newStock}`, 'success');
        return;
    }
    
    try {
        // 实际API调用
        const params = new URLSearchParams();
        params.append('action', 'updateStock');
        params.append('variant_id', variant.variant_id);
        params.append('new_stock', newStock.toString());
        params.append('adjustment', adjustment.toString());
        params.append('operation', adjustType);
        params.append('reason', reason);
        params.append('remark', remark);
        params.append('operator', '管理员');
        
        const response = await fetch(`${API_BASE_URL}?${params}`);
        const result = await response.json();
        
        if (result.success) {
            // 更新本地数据
            variant.stock = newStock;
            this.showInventoryInfo(variant, this.selectedProduct);
            this.showMessage('scanMessage', `${operation}库存成功！新库存: ${newStock}`, 'success');
            
            // 重置表单
            document.getElementById('adjustQuantity').value = 1;
            document.getElementById('adjustRemark').value = '';
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('库存调整失败:', error);
        this.showMessage('scanMessage', '库存调整失败: ' + error.message, 'error');
    }
}

            // === 第3步：显示产品所有变体 ===
showProductAllVariants(modelId) {
    try {
        // 查找产品信息
        const product = this.products.find(p => p.model_id === modelId);
        if (!product) {
            this.showMessage('scanMessage', `未找到产品: ${modelId}`, 'error');
            return;
        }
        
        // 获取该产品的所有变体
        const variants = this.productVariants[modelId] || [];
        if (variants.length === 0) {
            this.showMessage('scanMessage', `${product.model_name} 暂无颜色变体`, 'warning');
            return;
        }
        
        // 显示产品信息区域
        const inventoryInfo = document.getElementById('inventoryInfo');
        
        let html = `
            <div class="product-header" style="
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 1px solid var(--border-color);
            ">
                <div style="display: flex; align-items: center; gap: 12px;">
                   <div style="
    width: 50px;
    height: 50px;
    background: #f0f0f0;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: var(--primary-color);
    flex-shrink: 0;
    overflow: hidden;
">
    ${product.product_image ? 
        `<img src="${product.product_image.replace(/\s+/g, '')}" alt="${product.model_name}" 
             style="width: 100%; height: 100%; object-fit: cover;">` : 
        `<i class="fas fa-glasses"></i>`
    }
</div>
                    <div>
                        <h3 style="margin: 0 0 4px 0; font-size: 1.2rem;">${product.model_name}</h3>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">
                            <span style="margin-right: 12px;">型号: ${modelId}</span>
                            <span>变体: ${variants.length} 个</span>
                            ${product.location ? `<div style="margin-top: 4px; color: #4a5568; display: flex; align-items: center; gap: 5px;">
                                <i class="fas fa-map-marker-alt" style="font-size: 0.8rem;"></i>
                                <span>位置: ${product.location}</span>
                            </div>` : ''}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 新增：位置编辑按钮 -->
            <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 8px;
                border: 1px solid var(--border-color);
            ">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-map-marker-alt" style="color: var(--primary-color); font-size: 0.9rem;"></i>
                    <div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 2px;">
                            位置信息
                        </div>
                        <div style="font-size: 0.9rem; font-weight: 500; color: var(--text-color);">
                            ${product.location || '未设置位置'}
                        </div>
                    </div>
                </div>
                <button class="btn edit-location-btn" 
                        data-model-id="${modelId}"
                        style="padding: 6px 12px; font-size: 0.8rem;">
                    <i class="fas fa-edit" style="margin-right: 4px;"></i>编辑位置
                </button>
            </div>
            
            <div class="variants-list" style="margin-bottom: 15px;">
                <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 12px;
                ">
                    <h4 style="margin: 0; font-size: 1.1rem;">颜色变体</h4>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" onclick="app.hideInventoryInfo()" style="padding: 6px 12px; font-size: 0.85rem;">
                            <i class="fas fa-times"></i> 返回
                        </button>
                        <!-- 新增颜色按钮 -->
                        <button class="btn btn-success" onclick="app.showAddColorForm('${modelId}')" 
                                style="padding: 6px 12px; font-size: 0.85rem;">
                            <i class="fas fa-plus"></i> 新增颜色
                        </button>
                    </div>
                </div>
        `;
        
        
        // 显示每个颜色变体
        variants.forEach(variant => {
            const stockStatus = variant.stock <= 5 ? 'stock-low' : 
                               variant.stock <= 10 ? 'stock-warning' : 'stock-normal';
            const statusText = variant.stock <= 5 ? '紧张' : 
                              variant.stock <= 10 ? '较少' : '充足';
            
            html += `
                <div class="variant-card" data-variant-id="${variant.variant_id}" style="
                    background: white;
                    border-radius: 8px;
                    padding: 12px;
                    margin-bottom: 8px;
                    border: 1px solid var(--border-color);
                ">
                    <!-- 变体信息行 -->
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                            <div style="
                                width: 36px;
                                height: 36px;
                                border-radius: 6px;
                                background: #f8f9fa;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: 600;
                                color: var(--text-color);
                                font-size: 0.9rem;
                                flex-shrink: 0;
                            ">${variant.color.charAt(0)}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    margin-bottom: 2px;
                                ">
                                    <div style="font-weight: 600; font-size: 1rem; color: var(--text-color);">
                                        ${variant.color}
                                    </div>
                                    <div style="
                                        font-size: 0.75rem;
                                        padding: 1px 6px;
                                        background: ${stockStatus === 'stock-low' ? '#fee2e2' : 
                                                    stockStatus === 'stock-warning' ? '#fef3c7' : '#dcfce7'};
                                        color: ${stockStatus === 'stock-low' ? '#991b1b' : 
                                               stockStatus === 'stock-warning' ? '#92400e' : '#166534'};
                                        border-radius: 10px;
                                        font-weight: 500;
                                    ">
                                        ${statusText}
                                    </div>
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">
                                    <div style="display: flex; gap: 8px;">
                                        <span>ID: ${variant.variant_id}</span>
                                        <span>¥${variant.price}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="
                            display: flex;
                            flex-direction: column;
                            align-items: flex-end;
                            gap: 6px;
                            margin-left: 10px;
                        ">
                            <div style="
                                font-size: 1.3rem;
                                font-weight: 700;
                                color: ${stockStatus === 'stock-low' ? 'var(--danger-color)' : 
                                       stockStatus === 'stock-warning' ? 'var(--warning-color)' : 'var(--success-color)'};
                            ">
                                ${variant.stock}
                            </div>
                            <button class="btn adjust-toggle-btn" 
                                    data-variant-id="${variant.variant_id}"
                                    style="
                                        padding: 4px 8px;
                                        font-size: 0.8rem;
                                        background: #f8f9fa;
                                        color: var(--primary-color);
                                        border: 1px solid var(--border-color);
                                    ">
                                <i class="fas fa-edit" style="font-size: 0.8rem;"></i> 调整
                            </button>
                        </div>
                    </div>
                    
                    <!-- 调整表单（默认隐藏） -->
                    <div class="adjust-form" id="adjust-form-${variant.variant_id}" style="
                        display: none;
                        padding: 12px;
                        background: #f8f9fa;
                        border-radius: 6px;
                        margin-top: 10px;
                    ">
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 8px;
                        ">
                            <div style="font-weight: 600; font-size: 0.9rem; color: var(--text-color);">
                                调整 ${variant.color} 库存
                            </div>
                            <button class="cancel-adjust-btn" 
                                    data-variant-id="${variant.variant_id}"
                                    style="
                                        background: none;
                                        border: none;
                                        color: var(--text-muted);
                                        font-size: 1.1rem;
                                        cursor: pointer;
                                        padding: 0;
                                    ">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div style="
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 8px;
                            margin-bottom: 8px;
                        ">
                            <div>
                                <label style="
                                    display: block;
                                    font-size: 0.75rem;
                                    margin-bottom: 4px;
                                    color: var(--text-muted);
                                ">调整类型</label>
                                <select class="adjust-type" style="
                                    width: 100%;
                                    padding: 6px;
                                    border-radius: 4px;
                                    border: 1px solid var(--border-color);
                                    font-size: 0.85rem;
                                ">
                                    <option value="increase">增加</option>
                                    <option value="decrease">减少</option>
                                    <option value="set">设置</option>
                                </select>
                            </div>
                            <div>
                                <label style="
                                    display: block;
                                    font-size: 0.75rem;
                                    margin-bottom: 4px;
                                    color: var(--text-muted);
                                ">数量</label>
                                <input type="number" class="adjust-quantity" value="1" min="1" style="
                                    width: 100%;
                                    padding: 6px;
                                    border-radius: 4px;
                                    border: 1px solid var(--border-color);
                                    font-size: 0.85rem;
                                ">
                            </div>
                        </div>
                        
                    
                        
                        <div style="margin-bottom: 10px;">
                            <label style="
                                display: block;
                                font-size: 0.75rem;
                                margin-bottom: 4px;
                                color: var(--text-muted);
                            ">备注</label>
                            <input type="text" class="adjust-remark" placeholder="选填" style="
                                width: 100%;
                                padding: 6px;
                                border-radius: 4px;
                                border: 1px solid var(--border-color);
                                font-size: 0.85rem;
                            ">
                        </div>
                        
                        <button class="btn btn-success confirm-adjust-btn" 
                                data-variant-id="${variant.variant_id}"
                                style="
                                    width: 100%;
                                    padding: 8px;
                                    font-size: 0.85rem;
                                ">
                            <i class="fas fa-check" style="margin-right: 4px;"></i> 确认调整
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += `
            </div>
            
            <div style="
                background: #f8f9fa;
                border-radius: 8px;
                padding: 12px;
                font-size: 0.85rem;
                color: var(--text-muted);
                text-align: center;
            ">
                <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
                点击"调整"按钮修改对应颜色的库存
            </div>
        `;
        
        inventoryInfo.innerHTML = html;
        inventoryInfo.style.display = 'block';
        
        // 滚动到显示区域
        inventoryInfo.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // 绑定事件
        this.bindProductVariantEvents();
        
    } catch (error) {
        console.error('显示产品变体失败:', error);
        this.showMessage('scanMessage', '加载失败: ' + error.message, 'error');
    }
}

            // 在 showProductAllVariants 方法之后添加
bindProductVariantEvents() {
    // 切换调整表单显示/隐藏
    document.querySelectorAll('.adjust-toggle-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const variantId = e.target.closest('button').dataset.variantId;
            const form = document.getElementById(`adjust-form-${variantId}`);
            
            // 隐藏其他所有调整表单
            document.querySelectorAll('.adjust-form').forEach(f => {
                f.style.display = 'none';
            });
            
            // 重置所有调整按钮文本
            document.querySelectorAll('.adjust-toggle-btn').forEach(b => {
                b.innerHTML = '<i class="fas fa-edit" style="font-size: 0.8rem;"></i> 调整';
                b.style.background = '#f8f9fa';
                b.style.color = 'var(--primary-color)';
            });
            
            if (form.style.display === 'none') {
                form.style.display = 'block';
                e.target.innerHTML = '<i class="fas fa-times" style="font-size: 0.8rem;"></i> 关闭';
                e.target.style.background = 'var(--primary-color)';
                e.target.style.color = 'white';
            } else {
                form.style.display = 'none';
                e.target.innerHTML = '<i class="fas fa-edit" style="font-size: 0.8rem;"></i> 调整';
                e.target.style.background = '#f8f9fa';
                e.target.style.color = 'var(--primary-color)';
            }
        });
    });
    
    // 确认调整
    document.querySelectorAll('.confirm-adjust-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const variantId = e.target.closest('button').dataset.variantId;
            this.confirmProductVariantAdjustment(variantId);
        });
    });
    
    // 取消调整
    document.querySelectorAll('.cancel-adjust-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const variantId = e.target.closest('button').dataset.variantId;
            const form = document.getElementById(`adjust-form-${variantId}`);
            form.style.display = 'none';
            
            // 重置按钮
            const toggleBtn = document.querySelector(`.adjust-toggle-btn[data-variant-id="${variantId}"]`);
            if (toggleBtn) {
                toggleBtn.innerHTML = '<i class="fas fa-edit" style="font-size: 0.8rem;"></i> 调整';
                toggleBtn.style.background = '#f8f9fa';
                toggleBtn.style.color = 'var(--primary-color)';
            }
        });
    });
    // 新增：编辑位置按钮点击事件
    document.querySelectorAll('.edit-location-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const modelId = e.target.closest('button').dataset.modelId;
            this.showEditLocationForm(modelId);
        });
    });
}
            // 在 bindProductVariantEvents 方法之后添加
async confirmProductVariantAdjustment(variantId) {
    const variant = this.findVariantById(variantId);
    if (!variant) {
        this.showMessage('scanMessage', '未找到该商品变体', 'error');
        return;
    }
    
    const form = document.getElementById(`adjust-form-${variantId}`);
    const adjustType = form.querySelector('.adjust-type').value;
    const quantity = parseInt(form.querySelector('.adjust-quantity').value);
    const remark = form.querySelector('.adjust-remark').value.trim();
    
    if (!quantity || quantity < 1) {
        this.showMessage('scanMessage', '请输入有效的数量', 'error');
        return;
    }
    
    let newStock = variant.stock;
    let operation = '';
    
    switch (adjustType) {
        case 'increase':
            newStock += quantity;
            operation = '增加';
            break;
        case 'decrease':
            if (variant.stock < quantity) {
                this.showMessage('scanMessage', `库存不足，当前库存: ${variant.stock}`, 'error');
                return;
            }
            newStock -= quantity;
            operation = '减少';
            break;
        case 'set':
            newStock = quantity;
            operation = '设置';
            break;
    }

// ===== 从这里开始，插入以下代码 =====
// 计算要发送给后端的调整量 (adjustment)
let adjustment;
if (adjustType === 'set') {
    adjustment = newStock - variant.stock;
} else if (adjustType === 'increase') {
    adjustment = quantity;
} else if (adjustType === 'decrease') {
    adjustment = -quantity; // 关键：确保这是负数
}
    
    try {
        // API调用
        const params = new URLSearchParams();
        params.append('action', 'updateStock');
        params.append('variant_id', variantId);
        params.append('new_stock', newStock.toString());
        params.append('adjustment', adjustment.toString());
        params.append('operation', adjustType);
        params.append('remark', remark);
        params.append('operator', '管理员');
        
        const response = await fetch(`${API_BASE_URL}?${params}`);
        const result = await response.json();
        
        if (result.success) {
            // 更新本地数据
            variant.stock = newStock;
            
            // 更新显示
            this.updateVariantDisplay(variantId, newStock);
            
            // 隐藏表单
            form.style.display = 'none';
            const toggleBtn = document.querySelector(`.adjust-toggle-btn[data-variant-id="${variantId}"]`);
            if (toggleBtn) {
                toggleBtn.innerHTML = '<i class="fas fa-edit" style="font-size: 0.8rem;"></i> 调整';
                toggleBtn.style.background = '#f8f9fa';
                toggleBtn.style.color = 'var(--primary-color)';
            }
            
            // 重置表单
            form.querySelector('.adjust-quantity').value = 1;
            form.querySelector('.adjust-remark').value = '';
            
            this.showMessage('scanMessage', `${operation}库存成功！新库存: ${newStock}`, 'success');
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('库存调整失败:', error);
        this.showMessage('scanMessage', '库存调整失败: ' + error.message, 'error');
    }
}

// 更新变体显示
updateVariantDisplay(variantId, newStock) {
    const variantCard = document.querySelector(`.variant-card[data-variant-id="${variantId}"]`);
    if (!variantCard) return;
    
    // 更新库存数字
    const stockElement = variantCard.querySelector('[style*="font-size: 1.3rem"]');
    if (stockElement) {
        stockElement.textContent = newStock;
        
        // 更新库存状态
        const stockStatus = newStock <= 5 ? 'stock-low' : 
                           newStock <= 10 ? 'stock-warning' : 'stock-normal';
        const statusText = newStock <= 5 ? '紧张' : 
                          newStock <= 10 ? '较少' : '充足';
        
        // 更新颜色
        stockElement.style.color = stockStatus === 'stock-low' ? 'var(--danger-color)' : 
                                  stockStatus === 'stock-warning' ? 'var(--warning-color)' : 'var(--success-color)';
        
        // 更新状态标签
        const statusTag = variantCard.querySelector('[style*="font-size: 0.75rem"]');
        if (statusTag) {
            statusTag.textContent = statusText;
            statusTag.style.background = stockStatus === 'stock-low' ? '#fee2e2' : 
                                        stockStatus === 'stock-warning' ? '#fef3c7' : '#dcfce7';
            statusTag.style.color = stockStatus === 'stock-low' ? '#991b1b' : 
                                   stockStatus === 'stock-warning' ? '#92400e' : '#166534';
        }
    }
}

// === 第4步：显示单个变体调整 ===
showSingleVariantAdjustment(variantId) {
    const variant = this.findVariantById(variantId);
    if (!variant) {
        this.showMessage('scanMessage', '未找到该商品变体', 'error');
        return;
    }
    
    const product = this.products.find(p => p.model_id === variant.model_id);
    if (!product) {
        this.showMessage('scanMessage', '未找到产品信息', 'error');
        return;
    }
    
    // 显示单个变体的调整界面（使用你原有的showInventoryInfo方法）
    this.showInventoryInfo(variant, product);
}

// === 原来的 showMessage 方法 ===
showMessage(containerId, message, type) {
    const container = document.getElementById(containerId);
    container.innerHTML = `<div class="message ${type}">${message}</div>`;
    
    setTimeout(() => {
        container.innerHTML = '';
    }, 5000);
}

               // ==================== 库存情况页面方法 ====================
        
        bindStockEvents() {
            // 使用延迟绑定，确保元素存在
            setTimeout(() => {
                // 初始加载按钮
                const initialLoadBtn = document.getElementById('initialLoadStock');
                if (initialLoadBtn) {
                    initialLoadBtn.addEventListener('click', () => {
                        this.loadStockData();
                    });
                }
                
                // 刷新按钮
                const refreshBtn = document.getElementById('refreshStockBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => {
                        this.loadStockData();
                    });
                }
                
                // 查询按钮
                const searchBtn = document.getElementById('searchStockBtn');
                if (searchBtn) {
                    searchBtn.addEventListener('click', () => {
                        this.loadStockData();
                    });
                }
                
                // 新增商品按钮
                const addProductBtn = document.getElementById('addProductBtn');
                if (addProductBtn) {
                    addProductBtn.addEventListener('click', () => {
                        this.showAddProductForm();
                    });
                }
                
                // 页面切换时自动加载
                document.addEventListener('pageChanged', (e) => {
                    if (e.detail.page === 'data' && (!this.allStockData || this.allStockData.length === 0)) {
                        setTimeout(() => {
                            this.loadStockData();
                        }, 500);
                    }
                });
            }, 500);
        }

        // 加载库存数据
        async loadStockData() {
            try {
                this.showStockLoading();
                
                // 收集所有变体的库存数据
                const allStockData = [];
                
                for (const product of this.products) {
                    const variants = this.productVariants[product.model_id] || [];
                    for (const variant of variants) {
                        allStockData.push({
                            model_id: product.model_id,
                            model_name: product.model_name,
                            variant_id: variant.variant_id,
                            color: variant.color,
                            stock: variant.stock || 0,
                            price: variant.price || 0,
                            product_image: product.product_image || ''
                        });
                    }
                }
                
                this.allStockData = allStockData;
                this.renderStockList();
                
            } catch (error) {
                console.error('加载库存失败:', error);
                this.showStockMessage('加载库存失败: ' + error.message, 'error');
            }
        }

        // 显示加载中状态
        showStockLoading() {
            const container = document.getElementById('stockListContent');
            if (container) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div class="spinner" style="width: 40px; height: 40px; margin: 0 auto 15px;"></div>
                        <p style="color: var(--text-muted);">正在加载库存数据...</p>
                    </div>
                `;
            }
        }

        // 显示库存消息
        showStockMessage(message, type) {
            const container = document.getElementById('stockListContent');
            if (container) {
                container.innerHTML = `
                    <div class="message ${type}" style="margin: 20px;">
                        ${message}
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="app.loadStockData()">
                            <i class="fas fa-redo"></i>重新加载
                        </button>
                    </div>
                `;
            }
        }

        // 渲染库存列表 - 产品卡片式布局
        renderStockList() {
            if (!this.allStockData || this.allStockData.length === 0) {
                this.showStockMessage('暂无库存数据', 'warning');
                return;
            }
            
            const container = document.getElementById('stockListContent');
            const filterModel = document.getElementById('stockFilterModel')?.value || '';
            const filterStatus = document.getElementById('stockFilterStatus')?.value || '';
            
            // 筛选数据
            let filteredData = this.filterStockData(this.allStockData, filterModel, filterStatus);
            
            // 更新统计
            this.updateStockSummary(filteredData);
            
            // 按产品分组数据
            const groupedData = {};
            filteredData.forEach(item => {
                if (!groupedData[item.model_id]) {
                    groupedData[item.model_id] = {
                        model_name: item.model_name,
                        product_image: item.product_image,
                        items: []
                    };
                }
                groupedData[item.model_id].items.push(item);
            });
            
            // 渲染产品卡片
            if (Object.keys(groupedData).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <p>没有找到符合条件的商品</p>
                        <button class="btn" onclick="app.loadStockData()" style="margin-top: 15px;">
                            <i class="fas fa-redo"></i>重新查询
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="product-cards-grid">';
            
            // 渲染每个产品卡片
            Object.keys(groupedData).forEach(modelId => {
                const group = groupedData[modelId];
                html += this.renderProductCard(modelId, group);
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // 筛选库存数据
        filterStockData(data, filterModel, filterStatus) {
            let filteredData = [...data];
            
            // 筛选产品系列
            if (filterModel) {
                filteredData = filteredData.filter(item => item.model_id === filterModel);
            }
            
            // 筛选库存状态
            if (filterStatus) {
                filteredData = filteredData.filter(item => {
                    if (filterStatus === 'low') return item.stock <= 5;
                    if (filterStatus === 'warning') return item.stock > 5 && item.stock <= 10;
                    if (filterStatus === 'normal') return item.stock > 10;
                    return true;
                });
            }
            
            return filteredData;
        }

        // 渲染产品卡片
                // 渲染产品卡片
        renderProductCard(modelId, group) {
            // 获取产品位置信息
            const product = this.products.find(p => p.model_id === modelId);
            const location = product?.location || '';
            
            // 按库存状态排序：紧张 -> 较少 -> 充足
            const sortedItems = [...group.items].sort((a, b) => {
                const getPriority = (stock) => {
                    if (stock <= 5) return 1;  // 紧张最前
                    if (stock <= 10) return 2; // 较少中间
                    return 3;                   // 充足最后
                };
                return getPriority(a.stock) - getPriority(b.stock);
            });
            
            return `
                <div class="product-card" style="
                    background: white;
                    border-radius: 10px;
                    border: 1px solid #e0e0e0;
                    padding: 12px;
                    margin-bottom: 12px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    transition: all 0.3s ease;
                ">
                    <!-- 产品头部：图片和名称 -->
                    <div style="
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        margin-bottom: 12px;
                        padding-bottom: 10px;
                        border-bottom: 1px solid #f0f0f0;
                    ">
                        <!-- 产品图片 -->
                        <div style="
                            width: 50px;
                            height: 50px;
                            background: #f8f9fa;
                            border-radius: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            overflow: hidden;
                            border: 1px solid #e9ecef;
                            flex-shrink: 0;
                        ">
                            ${group.product_image ? 
                                `<img src="${group.product_image}" alt="${group.model_name}" 
                                     style="width: 100%; height: 100%; object-fit: cover;">` : 
                                `<i class="fas fa-glasses" style="color: #adb5bd; font-size: 1.2rem;"></i>`
                            }
                        </div>
                        
                        <!-- 产品信息 -->
                        <div style="flex: 1;">
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                align-items: flex-start;
                            ">
                                <div>
                                    <div style="font-weight: 600; font-size: 0.95rem; color: var(--text-color);">
                                        ${group.model_name}
                                    </div>
                                    <div style="font-size: 0.75rem; color: #666; margin-top: 2px;">
                                        <div>
                                            <span style="margin-right: 12px;">型号: ${modelId}</span>
                                            <span>变体: ${group.items.length}种</span>
                                        </div>
                                        <div style="margin-top: 2px; display: flex; align-items: center; gap: 4px; color: ${location ? '#4a5568' : '#999'};">
                                            <i class="fas fa-map-marker-alt" style="font-size: 0.7rem;"></i>
                                            <span>位置: ${location || '空'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 颜色变体列表 -->
                    <div class="variants-list" style="max-height: 200px; overflow-y: auto;">
                        ${sortedItems.map(item => this.renderVariantRow(item)).join('')}
                    </div>
                    
                    <!-- 查看详情按钮 -->
                    <div style="text-align: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0;">
                        <button class="btn" 
                                onclick="app.viewProductDetails('${modelId}')"
                                style="
                                    padding: 6px 20px;
                                    font-size: 0.85rem;
                                    background: #f8f9fa;
                                    color: var(--primary-color);
                                    border: 1px solid var(--border-color);
                                    width: 100%;
                                ">
                            <i class="fas fa-info-circle" style="margin-right: 5px;"></i>查看产品详情
                        </button>
                    </div>
                </div>
            `;
        }

        // 渲染变体行（在卡片内）
        renderVariantRow(item) {
            const stockStatus = item.stock <= 5 ? 'low' : 
                               item.stock <= 10 ? 'warning' : 'normal';
            const statusText = item.stock <= 5 ? '紧张' : 
                              item.stock <= 10 ? '较少' : '充足';
            const statusColor = stockStatus === 'low' ? '#991b1b' : 
                               stockStatus === 'warning' ? '#92400e' : '#166534';
            const statusBg = stockStatus === 'low' ? '#fee2e2' : 
                            stockStatus === 'warning' ? '#fef3c7' : '#dcfce7';
            
            return `
                <div class="variant-row" style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 6px 8px;
                    margin-bottom: 4px;
                    background: #f8f9fa;
                    border-radius: 6px;
                    border-left: 3px solid ${statusColor};
                ">
                    <div style="flex: 1;">
                        <div style="
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            margin-bottom: 2px;
                        ">
                            <span style="
                                font-weight: 500;
                                font-size: 0.85rem;
                                color: var(--text-color);
                            ">
                                ${item.color}
                            </span>
                            <span style="
                                font-size: 0.7rem;
                                color: #666;
                                background: #e9ecef;
                                padding: 1px 5px;
                                border-radius: 3px;
                            ">
                                ${item.variant_id}
                            </span>
                        </div>
                        <div style="font-size: 0.75rem; color: #666;">
                            ¥${item.price}
                        </div>
                    </div>
                    
                    <div style="
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        text-align: right;
                    ">
                        <div style="
                            font-size: 1.1rem;
                            font-weight: 700;
                            color: ${statusColor};
                            min-width: 30px;
                        ">
                            ${item.stock}
                        </div>
                        <div style="
                            padding: 2px 6px;
                            background: ${statusBg};
                            color: ${statusColor};
                            border-radius: 10px;
                            font-size: 0.7rem;
                            font-weight: 500;
                            min-width: 40px;
                            text-align: center;
                        ">
                            ${statusText}
                        </div>
                    </div>
                </div>
            `;
        }

        // 更新库存统计
        updateStockSummary(data) {
            let normal = 0, warning = 0, low = 0;
            
            data.forEach(item => {
                if (item.stock <= 5) low++;
                else if (item.stock <= 10) warning++;
                else normal++;
            });
            
            // 更新统计卡片
            const updateCard = (id, count, color) => {
                const card = document.getElementById(id);
                if (card) {
                    card.innerHTML = `
                        <div style="font-size: 1.5rem; font-weight: bold; color: ${color};">${count}</div>
                        <div style="font-size: 0.9rem; color: ${color};">${id === 'stockNormal' ? '库存充足' : id === 'stockWarning' ? '库存较少' : '库存紧张'}</div>
                    `;
                }
            };
            
            updateCard('stockNormal', normal, '#166534');
            updateCard('stockWarning', warning, '#92400e');
            updateCard('stockLow', low, '#991b1b');
        }

        // 查看产品详情
        viewProductDetails(modelId) {
            // 跳转到库存管理页面并自动查询
            app.switchPage('scan');
            
            // 设置手动输入框的值
            setTimeout(() => {
                document.getElementById('manualVariantId').value = modelId;
                document.getElementById('manualSearchBtn').click();
            }, 500);
        }

// ==================== 新增商品功能 ====================

// 显示新增商品弹窗
showAddProductForm() {
    // 重置表单
    document.getElementById('newModelId').value = '';
    document.getElementById('newModelName').value = '';
    document.getElementById('newStandardPrice').value = 0;
    document.getElementById('newProductImage').value = '';
    document.getElementById('newProductLocation').value = '';  // 新增：重置位置
    
    // 重置颜色输入
    const colorInputs = document.getElementById('colorInputs');
    // 找到设置 colorInputs.innerHTML 的地方，替换为：
colorInputs.innerHTML = `
    <div class="color-stock-row" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
        <div style="flex: 1;">
            <input type="text" class="form-input color-input" placeholder="颜色名称，如: 黑色" style="width: 100%; margin-bottom: 5px;">
            <input type="number" class="form-input stock-input" placeholder="库存数量" value="0" min="0" style="width: 100%;">
        </div>
        <button type="button" class="btn btn-danger" onclick="app.removeColorInput(this)" style="padding: 6px 12px; align-self: center;">
            <i class="fas fa-times"></i>
        </button>
    </div>
`;
    this.colorCount = 1;
    
    // 显示弹窗
    document.getElementById('addProductModal').classList.add('show');
}

// 关闭新增商品弹窗
closeAddProductModal() {
    document.getElementById('addProductModal').classList.remove('show');
    // === 新增：关闭弹窗时，同时清空内部的消息提示 ===
    const messageContainer = document.getElementById('addProductMessage');
    if (messageContainer) {
        messageContainer.innerHTML = ''; // 清空所有内容
    }
    // =================================================

}

// 添加颜色输入框（带库存）
addColorInput() {
    const colorInputs = document.getElementById('colorInputs');
    const newRow = document.createElement('div');
    newRow.className = 'color-stock-row';
    newRow.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
    newRow.innerHTML = `
        <div style="flex: 1;">
            <input type="text" class="form-input color-input" placeholder="颜色名称，如: 银色" style="width: 100%; margin-bottom: 5px;">
            <input type="number" class="form-input stock-input" placeholder="库存数量" value="0" min="0" style="width: 100%;">
        </div>
        <button type="button" class="btn btn-danger" onclick="app.removeColorInput(this)" style="padding: 6px 12px; align-self: center;">
            <i class="fas fa-times"></i>
        </button>
    `;
    colorInputs.appendChild(newRow);
    this.colorCount++;
}

// 移除颜色输入框
removeColorInput(button) {
    if (this.colorCount > 1) {
        button.parentElement.remove();
        this.colorCount--;
    }
}

// 提交新增商品
// 提交新增商品
async submitNewProduct() {
    // 收集表单数据
    const modelId = document.getElementById('newModelId').value.trim();
    const modelName = document.getElementById('newModelName').value.trim();
    const standardPrice = parseFloat(document.getElementById('newStandardPrice').value) || 0;
    const productImage = document.getElementById('newProductImage').value.trim();
    const location = document.getElementById('newProductLocation').value.trim();  // 新增：获取位置
    
    
    // 收集颜色和库存
    const colorRows = document.querySelectorAll('.color-stock-row');
    const colors = [], stocks = [];

    colorRows.forEach(row => {
        const colorInput = row.querySelector('.color-input');
        const stockInput = row.querySelector('.stock-input');
        const color = colorInput ? colorInput.value.trim() : '';
        const stock = stockInput ? parseInt(stockInput.value) || 0 : 0;
        
        if (color) {  // 只添加非空的颜色
            colors.push(color);
            stocks.push(stock);
        }
    });
    
    // 验证数据
    if (!modelId) {
        this.showAddProductMessage('请输入产品型号', 'error');
        return;
    }
    
    if (!modelName) {
        this.showAddProductMessage('请输入产品名称', 'error');
        return;
    }
    
    if (colors.length === 0) {
        this.showAddProductMessage('请至少添加一个颜色', 'error');
        return;
    }
    
    // 检查是否已存在该型号
    const existingProduct = this.products.find(p => p.model_id === modelId);
    if (existingProduct) {
        this.showAddProductMessage(`产品型号 ${modelId} 已存在`, 'error');
        return;
    }

    try {
        // 调用后端API新增商品
        const result = await this.addProductToBackend({
            modelId: modelId,
            modelName: modelName,
            colors: colors,      // 确保这是数组
            stocks: stocks,      // 确保这是数组
            standardPrice: standardPrice,
            productImage: productImage,
            location: location   // 新增：传递位置
        });
        
        if (result.success) {
            this.showAddProductMessage('商品新增成功！正在刷新数据...', 'success');
            
            // 关闭弹窗
            setTimeout(() => {
                this.closeAddProductModal();
                
                // 重新加载数据
                this.loadProducts();
                this.loadStockData();
                
                // 显示成功消息
                this.showStockMessage('商品新增成功！数据已刷新', 'success');
            }, 1500);
        } else {
            throw new Error(result.message || '新增失败');
        }
    } catch (error) {
        console.error('新增商品失败:', error);
        this.showAddProductMessage('新增失败: ' + error.message, 'error');
    }
}

async addProductToBackend(productData) {
    try {
        const priceValue = productData.standardPrice || productData.price || 0;
        
        const params = new URLSearchParams();
        params.append('action', 'addProduct');
        params.append('model_id', productData.modelId);
        params.append('model_name', productData.modelName);
        
        // 确保是数组
        const colorsArray = Array.isArray(productData.colors) ? productData.colors : [productData.colors];
        const stocksArray = Array.isArray(productData.stocks) ? productData.stocks : [productData.stocks];
        
        const validColors = [];
        const validStocks = [];
        
        for (let i = 0; i < colorsArray.length; i++) {
            const color = colorsArray[i];
            if (color && typeof color === 'string' && color.trim()) {
                validColors.push(color.trim());
                validStocks.push(stocksArray[i] || 0);
            }
        }
        
        if (validColors.length === 0) {
            throw new Error('请至少添加一个有效的颜色');
        }
        
        // === 永久修复：同时发送两种格式 ===
        // 格式1: color_stock (分号分隔)
        const colorStockString = validColors.map((color, i) => 
            `${color}:${validStocks[i]}`
        ).join('; ');
        params.append('color_stock', colorStockString);
        
        // 格式2: colors 和 stocks (逗号分隔)
        params.append('colors', validColors.join(','));
        params.append('stocks', validStocks.join(','));
        // ===================================
        
        params.append('price', priceValue.toString());
        
        if (productData.productImage) {
            params.append('product_image', productData.productImage);
        }

        // 新增：添加位置参数
        if (productData.location) {
            params.append('location', productData.location);
        }
        
        console.log('新增商品请求:', params.toString());
        
        const response = await fetch(`${API_BASE_URL}?${params}`);
        const result = await response.json();
        
        if (result.success) {
            this.showAddProductMessage(`✅ ${result.message}`, 'success');
            setTimeout(() => {
                document.getElementById('addProductModal').classList.remove('show');
                this.loadProducts();
                this.loadStockData();
            }, 3000);
        } else {
            this.showAddProductMessage(`❌ ${result.message}`, 'error');
        }
        
        return result;
    } catch (error) {
        console.error('新增商品失败:', error);
        this.showAddProductMessage(`错误: ${error.message}`, 'error');
        throw error;
    }
}
// 显示新增商品的消息
showAddProductMessage(message, type) {
    const container = document.getElementById('addProductMessage');
    container.innerHTML = `<div class="message ${type}">${message}</div>`;
}

// 绑定新增商品弹窗的事件
bindAddProductEvents() {
    // 关闭按钮
    document.getElementById('closeAddProductModal').addEventListener('click', () => {
        this.closeAddProductModal();
    });
    
    // 点击弹窗外部关闭
    document.getElementById('addProductModal').addEventListener('click', (e) => {
        if (e.target.id === 'addProductModal') {
            this.closeAddProductModal();
        }
    });
}
// ==================== 添加这个方法 ====================
        // 查看产品详情
        viewProductDetails(modelId) {
            // 跳转到库存管理页面并自动查询
            app.switchPage('scan');
            
            // 设置手动输入框的值
            setTimeout(() => {
                document.getElementById('manualVariantId').value = modelId;
                document.getElementById('manualSearchBtn').click();
            }, 500);
        }

// === 新增颜色功能 ===
showAddColorForm(modelId) {
    // 先隐藏所有调整表单
    document.querySelectorAll('.adjust-form').forEach(form => {
        form.style.display = 'none';
    });
    
    // 检查是否已存在新增颜色表单
    const existingForm = document.querySelector('.add-color-form');
    if (existingForm) {
        existingForm.remove();
        return;
    }
    
    // 创建新增颜色表单
    const addColorForm = document.createElement('div');
    addColorForm.className = 'add-color-form';
    addColorForm.innerHTML = `
        <div style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        ">
            <h5 style="margin: 0; color: var(--text-color); font-size: 0.95rem;">
                <i class="fas fa-plus-circle" style="color: var(--success-color); margin-right: 6px;"></i>
                新增颜色变体
            </h5>
            <button class="close-color-form" style="
                background: none;
                border: none;
                color: var(--text-muted);
                font-size: 1.1rem;
                cursor: pointer;
                padding: 0;
            ">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="color-form-row">
            <div>
                <label style="
                    display: block;
                    font-size: 0.8rem;
                    margin-bottom: 4px;
                    color: var(--text-muted);
                ">颜色名称 *</label>
                <input type="text" class="form-input new-color-name" placeholder="如: 玫瑰金" 
                       style="width: 100%; padding: 8px; font-size: 0.9rem;">
            </div>
            <div>
                <label style="
                    display: block;
                    font-size: 0.8rem;
                    margin-bottom: 4px;
                    color: var(--text-muted);
                ">初始库存 *</label>
                <input type="number" class="form-input new-color-stock" value="0" min="0" 
                       style="width: 100%; padding: 8px; font-size: 0.9rem;">
            </div>
        </div>
        
        <div style="margin-bottom: 10px;">
            <label style="
                display: block;
                font-size: 0.8rem;
                margin-bottom: 4px;
                color: var(--text-muted);
            ">价格</label>
            <input type="number" class="form-input new-color-price" 
                   value="${this.getProductStandardPrice(modelId)}" min="0" 
                   style="width: 100%; padding: 8px; font-size: 0.9rem;">
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                如不填写，将使用产品标准价格
            </div>
        </div>
        
        <div class="color-form-actions">
            <button class="btn btn-success confirm-add-color" data-model-id="${modelId}"
                    style="padding: 8px;">
                <i class="fas fa-check"></i> 确认新增
            </button>
            <button class="btn btn-outline cancel-add-color" style="padding: 8px;">
                <i class="fas fa-times"></i> 取消
            </button>
        </div>
        
        <div id="addColorMessage" style="margin-top: 10px;"></div>
    `;
    
    // 插入到颜色列表上方
    const variantsList = document.querySelector('.variants-list');
    variantsList.parentNode.insertBefore(addColorForm, variantsList);
    
    // 绑定事件
    this.bindAddColorEvents(modelId);
}

// 获取产品的标准价格
getProductStandardPrice(modelId) {
    // 获取该产品第一个变体的价格作为标准价格
    const variants = this.productVariants[modelId] || [];
    if (variants.length > 0) {
        return variants[0].price || 0;
    }
    return 0;
}

// 绑定新增颜色表单事件
bindAddColorEvents(modelId) {
    // 关闭按钮
    document.querySelector('.close-color-form').addEventListener('click', () => {
        document.querySelector('.add-color-form').remove();
    });
    
    document.querySelector('.cancel-add-color').addEventListener('click', () => {
        document.querySelector('.add-color-form').remove();
    });
    
    // 确认新增按钮
    document.querySelector('.confirm-add-color').addEventListener('click', async () => {
        await this.confirmAddColor(modelId);
    });
}

// 确认新增颜色
async confirmAddColor(modelId) {
    const colorName = document.querySelector('.new-color-name').value.trim();
    const stock = parseInt(document.querySelector('.new-color-stock').value) || 0;
    const price = parseFloat(document.querySelector('.new-color-price').value) || this.getProductStandardPrice(modelId);
    
    // 验证
    if (!colorName) {
        this.showAddColorMessage('请输入颜色名称', 'error');
        return;
    }
    
    if (stock < 0) {
        this.showAddColorMessage('库存不能为负数', 'error');
        return;
    }
    
    // 检查是否已存在该颜色
    const existingVariants = this.productVariants[modelId] || [];
    const existingColor = existingVariants.find(v => v.color === colorName);
    if (existingColor) {
        this.showAddColorMessage(`颜色 "${colorName}" 已存在`, 'error');
        return;
    }
    
    try {
        this.showAddColorMessage('正在新增颜色...', 'success');
        
        // 生成新的变体ID (格式：产品ID+颜色编号)
        const existingCount = existingVariants.length;
        const newVariantId = `${modelId.replace('M', 'V')}${String(existingCount + 1).padStart(2, '0')}`;
        
        // 调用API新增颜色变体 - 使用 updateStock 接口
const params = new URLSearchParams();
params.append('action', 'updateStock');  // ← 改为 updateStock
params.append('model_id', modelId);
params.append('color', colorName);
params.append('new_stock', stock.toString());
params.append('adjustment', stock.toString()); // 因为是新增，所以调整量就是库存值
params.append('operation', 'add_color'); // 新增操作类型
params.append('price', price.toString());
params.append('variant_id', newVariantId);
params.append('operator', '管理员');
        
        console.log('新增颜色参数:', params.toString());
        
        const response = await fetch(`${API_BASE_URL}?${params}`);
        const result = await response.json();
        
        if (result.success) {
            this.showAddColorMessage('颜色新增成功！正在刷新...', 'success');
            
            // 更新本地数据
            const newVariant = {
                variant_id: newVariantId,
                model_id: modelId,
                color: colorName,
                stock: stock,
                price: price
            };
            
            if (!this.productVariants[modelId]) {
                this.productVariants[modelId] = [];
            }
            this.productVariants[modelId].push(newVariant);
            
            // 更新总变体列表
            this.allVariants.push(newVariant);
            
            // 更新标准价格缓存
            this.standardPrices[newVariantId] = price;
            
            // 重新显示产品详情（刷新界面）
            setTimeout(() => {
                document.querySelector('.add-color-form')?.remove();
                this.showProductAllVariants(modelId);
                this.showMessage('scanMessage', `颜色 "${colorName}" 新增成功！`, 'success');
            }, 1500);
            
        } else {
            throw new Error(result.message || '新增失败');
        }
        
    } catch (error) {
        console.error('新增颜色失败:', error);
        this.showAddColorMessage('新增失败: ' + error.message, 'error');
    }
}

// 显示新增颜色消息
showAddColorMessage(message, type) {
    const container = document.getElementById('addColorMessage');
    if (container) {
        container.innerHTML = `<div class="message ${type}" style="padding: 8px; font-size: 0.85rem;">${message}</div>`;
    }
}
            // 显示编辑位置表单
showEditLocationForm(modelId) {
    const product = this.products.find(p => p.model_id === modelId);
    if (!product) return;
    
    // 创建编辑位置表单
    const editForm = `
        <div class="edit-location-form" style="
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        ">
            <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            ">
                <h5 style="margin: 0; color: var(--text-color); font-size: 0.95rem;">
                    <i class="fas fa-map-marker-alt" style="color: var(--primary-color); margin-right: 6px;"></i>
                    编辑位置信息
                </h5>
                <button class="close-edit-form" style="
                    background: none;
                    border: none;
                    color: var(--text-muted);
                    font-size: 1.1rem;
                    cursor: pointer;
                    padding: 0;
                ">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="margin-bottom: 10px;">
                <label style="
                    display: block;
                    font-size: 0.8rem;
                    margin-bottom: 4px;
                    color: var(--text-muted);
                ">位置</label>
                <input type="text" class="form-input edit-location-input" 
                       value="${product.location || ''}" 
                       placeholder="输入商品存放位置"
                       style="width: 100%; padding: 8px; font-size: 0.9rem;">
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                    如：货架A01、仓库2区、展示柜等
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-success save-location-btn" data-model-id="${modelId}"
                        style="padding: 8px; flex: 1;">
                    <i class="fas fa-save" style="margin-right: 4px;"></i> 保存位置
                </button>
                <button class="btn btn-outline cancel-edit-location" style="padding: 8px; flex: 1;">
                    <i class="fas fa-times" style="margin-right: 4px;"></i> 取消
                </button>
            </div>
            
            <div id="editLocationMessage" style="margin-top: 10px;"></div>
        </div>
    `;
    
    // 替换位置显示区域
    const locationSection = document.querySelector('.edit-location-btn').closest('div');
    locationSection.outerHTML = editForm;
    
    // 绑定事件
    this.bindEditLocationEvents(modelId);
}

// 绑定编辑位置事件
bindEditLocationEvents(modelId) {
    // 关闭按钮
    document.querySelector('.close-edit-form').addEventListener('click', () => {
        this.cancelEditLocation(modelId);
    });
    
    document.querySelector('.cancel-edit-location').addEventListener('click', () => {
        this.cancelEditLocation(modelId);
    });
    
    // 保存位置按钮
    document.querySelector('.save-location-btn').addEventListener('click', async () => {
        await this.saveProductLocation(modelId);
    });
}

// 取消编辑位置
cancelEditLocation(modelId) {
    // 重新显示产品详情
    this.showProductAllVariants(modelId);
}

// 保存产品位置
async saveProductLocation(modelId) {
    const newLocation = document.querySelector('.edit-location-input').value.trim();
    
    try {
        // 调用后端API更新位置
        const params = new URLSearchParams();
        params.append('action', 'updateLocation');
        params.append('model_id', modelId);
        params.append('location', newLocation);
        
        const response = await fetch(`${API_BASE_URL}?${params}`);
        const result = await response.json();
        
        if (result.success) {
            // 更新本地数据
            const product = this.products.find(p => p.model_id === modelId);
            if (product) {
                product.location = newLocation;
            }
            
            // 显示成功消息
            const messageDiv = document.getElementById('editLocationMessage');
            messageDiv.innerHTML = `<div class="message success" style="padding: 8px; font-size: 0.85rem;">位置已更新！</div>`;
            
            // 2秒后刷新显示
            setTimeout(() => {
                this.showProductAllVariants(modelId);
                this.showMessage('scanMessage', `位置已更新: ${newLocation || '空'}`, 'success');
            }, 1500);
            
        } else {
            throw new Error(result.message || '更新失败');
        }
    } catch (error) {
        console.error('更新位置失败:', error);
        const messageDiv = document.getElementById('editLocationMessage');
        messageDiv.innerHTML = `<div class="message error" style="padding: 8px; font-size: 0.85rem;">更新失败: ${error.message}</div>`;
    }
}
            showMessage(containerId, message, type) {
                const container = document.getElementById(containerId);
                container.innerHTML = `<div class="message ${type}">${message}</div>`;
                
                setTimeout(() => {
                    container.innerHTML = '';
                }, 15000);
            }
            
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new App();
        });
    </script>
</body>
</html>
