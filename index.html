<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>赛娜眼镜进销存</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@latest/dist/jsQR.js"></script>
    <style>
        /* 基础重置和变量定义 */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-bg: #f5f5f5;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-muted: #666666;
            --border-color: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
            padding-bottom: 80px;
        }

        /* 顶部导航 */
        .app-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 15px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .icon-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.1rem;
            padding: 5px;
            cursor: pointer;
        }

        /* 主内容区 */
        .app-main {
            margin-top: 60px;
            padding: 15px;
            min-height: calc(100vh - 140px);
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }
/* 摄像头扫描框样式 */
.camera-frame {
    position: relative;
    width: 100%;
    max-width: 300px;
    margin: 0 auto;
    overflow: hidden;
    border-radius: 8px;
}

/* 扫描线动画 */
.scan-line {
    position: absolute;
    left: 10%;
    right: 10%;
    height: 3px;
    background: linear-gradient(90deg, transparent, #667eea, transparent);
    box-shadow: 0 0 10px #667eea;
    animation: scan 2s ease-in-out infinite;
    z-index: 10;
    top: 20%;
}

@keyframes scan {
    0%, 100% {
        top: 20%;
        opacity: 0.7;
    }
    50% {
        top: 80%;
        opacity: 1;
    }
}

/* 摄像头叠加层 */
.camera-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    pointer-events: none;
    z-index: 5;
}

.camera-overlay::before {
    content: '';
    position: absolute;
    top: 20%;
    left: 10%;
    right: 10%;
    bottom: 20%;
    border: 2px solid #667eea;
    border-radius: 8px;
    box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.3);
}
    
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 底部导航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid var(--border-color);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-muted);
            font-size: 0.8rem;
            padding: 5px 10px;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 80px;
        }

        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        /* 卡片样式 */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
        }

        /* 页面管理 */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
            text-align: left;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: var(--card-bg);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-block {
            width: 100%;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-warning {
            background: var(--warning-color);
            color: #000;
        }

        .btn-danger {
            background: var(--danger-color);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

/* 产品选择按钮 */
.product-select-btn {
    background: var(--light-bg);
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 12px;  /* 从20px改为12px */
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 12px;  /* 从15px改为12px */
}

.product-select-btn:hover {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.1);
}

.product-select-btn i {
    font-size: 1.2rem;  /* 从2rem改为1.2rem */
    color: var(--text-muted);
    margin-bottom: 5px;  /* 从8px改为5px */
}

.selected-product {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 12px;  /* 从15px改为12px */
    margin-bottom: 12px;  /* 从15px改为12px */
    border-left: 4px solid var(--primary-color);
}
/* === 新增的紧凑布局样式 === */
.selected-product-header {
    display: flex;
    align-items: center;
    gap: 10px;
}

.product-image-small {
    width: 40px;
    height: 40px;
    background: #f0f0f0;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    color: var(--text-muted);
    flex-shrink: 0;
}
.product-info {
    flex: 1;
}

.product-info h4 {
    margin-bottom: 3px;
    color: var(--text-color);
    font-size: 0.95rem;
}

.product-info p {
    color: var(--text-muted);
    margin-bottom: 2px;
    font-size: 0.85rem;
}

.add-item-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
}

.add-item-section h4 {
    margin-bottom: 15px;
    color: var(--text-color);
}

/* 销售商品清单样式优化 */
.item-list {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.item-list h4 {
    margin-bottom: 15px;
    color: var(--text-color);
}

        .selected-product h4 {
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .selected-product p {
            color: var(--text-muted);
            margin-bottom: 3px;
            font-size: 0.9rem;
        }

        /* 颜色选择 */
        .color-selection {
            margin-top: 15px;
        }

        .color-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .color-option {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .color-option.selected {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.15);
    font-weight: 600;
    color: var(--primary-color);
    box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
}
/* === 已选产品预览样式 === */
.selected-product-preview {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    border: 1px solid var(--border-color);
}

.preview-header h4 {
    margin-bottom: 10px;
    color: var(--text-color);
    font-size: 0.95rem;
    font-weight: 600;
}

.preview-content {
    display: flex;
    align-items: center;
    gap: 12px;
}

.preview-image {
    width: 45px;
    height: 45px;
    background: #e9ecef;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    color: var(--primary-color);
    flex-shrink: 0;
}

.preview-info {
    flex: 1;
}

.preview-info h5 {
    margin-bottom: 4px;
    color: var(--text-color);
    font-size: 0.9rem;
    font-weight: 600;
}

.preview-info p {
    color: var(--text-muted);
    font-size: 0.8rem;
    margin: 0;
}
        /* 销售表单样式 */
        .sale-form {
            margin-top: 10px;
        }

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .item-list {
            margin-top: 20px;
        }

        .item-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-info h4 {
            margin-bottom: 5px;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qty-btn {
            background: #ddd;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
        }

        .total-section {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* 客户欠款显示 */
        .customer-balance {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .balance-warning {
            color: #856404;
            font-weight: 500;
        }

        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-body {
            padding: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        /* 产品选择网格 */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .product-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .product-card.selected {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        .product-image {
            width: 60px;
            height: 60px;
            background: #f0f0f0;
            border-radius: 6px;
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--text-muted);
        }

        .product-name {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .product-price {
            font-size: 0.8rem;
            color: var(--success-color);
            font-weight: 600;
        }

        .product-stock {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* 小票样式 */
        .receipt {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px dashed #333;
        }

        .receipt-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .receipt-info {
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .receipt-info div {
            margin-bottom: 3px;
        }

        .receipt-items {
            width: 100%;
            margin-bottom: 10px;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .receipt-item-name {
            flex: 2;
        }

        .receipt-item-details {
            flex: 1;
            text-align: right;
        }

        .receipt-divider {
            border-top: 1px dashed #333;
            margin: 10px 0;
        }

        .receipt-total {
            text-align: right;
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 10px;
        }

        .receipt-footer {
            text-align: center;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #333;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .receipt-balance {
            background: #fff3cd;
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        /* 价格提示 */
        .price-note {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .special-price {
            color: var(--success-color);
            font-weight: 500;
        }

        /* 消息提示 */
        .message {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* 调试信息 */
        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* 工具类 */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-success { color: var(--success-color); }
        .text-danger { color: var(--danger-color); }
        .text-warning { color: var(--warning-color); }
        .mt-1 { margin-top: 5px; }
        .mt-2 { margin-top: 10px; }
        .mb-1 { margin-bottom: 5px; }
        .mb-2 { margin-bottom: 10px; }
        .hidden { display: none; }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .app-main {
                padding: 10px;
            }
            
            .card {
                padding: 12px;
            }
            
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        @media (max-width: 480px) {
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <header class="app-header">
        <div class="header-content">
            <h1 class="app-title" id="pageTitle">扫码</h1>
            <div class="header-actions">
                <button class="icon-btn" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="app-main">
        <!-- 加载状态 -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>系统初始化中...</p>
            <div id="initDebug" class="debug-info"></div>
        </div>
        
        <!-- 动态内容区 -->
        <div id="content" style="display: none;">
<!-- 库存管理页面 -->
<div id="scan-page" class="page active">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">库存管理</h3>
            <button class="btn btn-warning" id="manualInputBtn" style="padding: 8px 12px;">
                <i class="fas fa-keyboard"></i>手动输入
            </button>
        </div>
        
        <div class="scan-section" style="text-align: center; padding: 20px;">
            <!-- 扫码区域 -->
            <div class="scan-area" style="margin-bottom: 20px;">
                <div class="feature-icon">
                    <i class="fas fa-qrcode" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 15px;"></i>
                </div>
                <h3 style="margin-bottom: 10px;">扫描商品二维码</h3>
                <p style="color: var(--text-muted); margin-bottom: 20px;">扫描产品二维码查看库存并进行调整</p>
                
                <button class="btn" id="startScan" style="max-width: 200px; margin: 0 auto 15px;">
                    <i class="fas fa-camera"></i>开始扫码
                </button>
                
                <div style="margin: 15px 0; color: var(--text-muted);">或</div>
                
                <div class="form-group" style="text-align: left;">
                    <label class="form-label">手动输入商品ID/二维码</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-input" id="manualVariantId" placeholder="输入V001, V002等" style="flex: 1;">
                        <button class="btn" id="manualSearchBtn" style="white-space: nowrap;">
                            <i class="fas fa-search"></i>查询
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 库存信息展示区 -->
            <div id="inventoryInfo" style="display: none;">
                <div class="selected-product-preview" style="margin-bottom: 20px;">
                    <div class="preview-content">
                        <div class="preview-image">
                            <i class="fas fa-glasses"></i>
                        </div>
                        <div class="preview-info">
                            <h5 id="inventoryProductName">产品名称</h5>
                            <p id="inventoryProductColor">颜色: 未选择</p>
                            <p id="inventoryProductModel">型号: 未选择</p>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="background: #f8f9fa; margin-bottom: 20px;">
                    <h4 style="text-align: center; margin-bottom: 15px;">当前库存信息</h4>
                    <div style="font-size: 2rem; text-align: center; font-weight: bold; color: var(--primary-color); margin-bottom: 10px;" id="currentStock">0</div>
                    <p style="text-align: center; color: var(--text-muted);">当前库存数量</p>
                    
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                        <p style="font-size: 0.9rem; color: var(--text-muted);">
                            <i class="fas fa-info-circle"></i> 最后更新: <span id="lastUpdated">-</span>
                        </p>
                    </div>
                </div>
                
                <!-- 库存调整表单 -->
                <div class="inventory-adjustment">
                    <h4 style="margin-bottom: 15px;">库存调整</h4>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">调整类型</label>
                            <select class="form-select" id="adjustType">
                                <option value="increase">增加库存</option>
                                <option value="decrease">减少库存</option>
                                <option value="set">设置库存</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">数量</label>
                            <input type="number" class="form-input" id="adjustQuantity" value="1" min="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">调整原因</label>
                        <select class="form-select" id="adjustReason">
                            <option value="sale">销售出库</option>
                            <option value="purchase">采购入库</option>
                            <option value="return">客户退货</option>
                            <option value="damage">商品报损</option>
                            <option value="adjustment">库存盘点调整</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">备注</label>
                        <input type="text" class="form-input" id="adjustRemark" placeholder="可输入备注信息（选填）">
                    </div>
                    
                    <div class="form-row" style="margin-top: 20px;">
                        <button class="btn btn-success" id="confirmAdjust" style="flex: 1;">
                            <i class="fas fa-check"></i>确认调整
                        </button>
                        <button class="btn btn-outline" id="cancelAdjust" style="flex: 1;">
                            <i class="fas fa-times"></i>取消
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="scanMessage"></div>
</div>

          <!-- 线下销售页面 -->
<div id="sale-page" class="page">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">线下销售出库</h3>
            <button class="btn btn-warning" onclick="app.useTestData()" style="padding: 8px 12px;">
                <i class="fas fa-vial"></i>测试数据
            </button>
        </div>
        
        <div class="sale-form">
            <!-- 1. 客户选择 -->
            <div class="form-group">
                <label class="form-label">选择客户</label>
                <select class="form-select" id="customerSelect">
                    <option value="">请选择客户...</option>
                </select>
                <div id="customerBalance" class="customer-balance hidden">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span class="balance-warning">该客户有待收款金额: ¥<span id="balanceAmount">0</span></span>
                </div>
            </div>

            <!-- 3. 添加新商品区域 -->
            <div class="add-item-section">
                <h4>添加新商品</h4>
                
                <!-- 产品选择按钮 -->
                <div class="product-select-btn" id="saleProductSelectBtn">
                    <i class="fas fa-plus-circle"></i>
                    <div>点击选择产品</div>
                </div>

                <!-- 已选产品预览 -->
                <div class="selected-product-preview" id="selectedProductPreview" style="display: none;">
                    <div class="preview-header">
                        <h4>已选产品</h4>
                    </div>
                    <div class="preview-content">
                        <div class="preview-image">
                            <i class="fas fa-glasses"></i>
                        </div>
                        <div class="preview-info">
                            <h5 id="previewProductName">产品名称</h5>
                        </div>
                    </div>
                </div>

                <!-- 颜色选择 -->
                <div class="color-selection" id="saleColorSelection" style="display: none;">
                    <label class="form-label">选择颜色</label>
                    <div class="color-options" id="saleColorOptions">
                        <!-- 颜色选项将通过JS动态生成 -->
                    </div>
                </div>
<div class="form-row">
    <div class="form-group">
        <label class="form-label">数量</label>
        <input type="number" class="form-input" id="saleQuantity" value="1" min="1">
    </div>
    <div class="form-group">
        <label class="form-label">单价</label>
        <div class="price-display" style="
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-weight: 600;
        ">
            ¥<span id="priceDisplay">0</span>
            <div id="priceNote" class="price-note" style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;"></div>
        </div>
    </div>
</div>

                <button class="btn btn-block" id="addItemBtn">
                    <i class="fas fa-plus"></i>添加到销售单
                </button>
                <!-- 2. 当前销售商品清单 -->
            <div class="item-list" id="saleItems" style="display: none;">
                <h4>当前销售商品</h4>
                <div id="itemsList"></div>
                
                <div class="total-section">
                    总计: ¥<span id="totalAmount">0</span>
                </div>
            </div>
            </div>
            
            <!-- 4. 确认销售按钮 -->
            <button class="btn btn-success btn-block" id="confirmSale" style="display: none;">
                <i class="fas fa-check-circle"></i>确认销售出库
            </button>
        </div>
    </div>

    <div id="saleMessage"></div>

    <!-- 销售单预览 -->
    <div id="invoicePreview" class="card" style="display: none;">
        <div class="card-header">
            <h3 class="card-title">销售单预览</h3>
            <button class="btn" id="downloadInvoice">
                <i class="fas fa-download"></i>下载销售单
            </button>
        </div>
        <div id="invoiceContent"></div>
    </div>
</div>

            <!-- 数据查看页面 -->
            <div id="data-page" class="page">
                <div class="card">
                    <div class="feature-icon" style="text-align: center; font-size: 2rem; color: var(--primary-color); margin-bottom: 15px;">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h3 style="text-align: center;">数据查看</h3>
                    <p style="text-align: center; color: var(--text-muted); margin-bottom: 20px;">销售记录、库存查询等功能</p>
                    <div class="status-badge" style="background: #fff3cd; color: #856404; padding: 8px 12px; border-radius: 6px; text-align: center;">
                        功能开发中
                    </div>
                </div>
            </div>

            <!-- 基础数据页面 -->
            <div id="base-page" class="page">
                <div class="card">
                    <div class="feature-icon" style="text-align: center; font-size: 2rem; color: var(--primary-color); margin-bottom: 15px;">
                        <i class="fas fa-cog"></i>
                    </div>
                    <h3 style="text-align: center;">基础数据管理</h3>
                    <p style="text-align: center; color: var(--text-muted); margin-bottom: 20px;">产品、客户管理等设置</p>
                    <div class="status-badge" style="background: #fff3cd; color: #856404; padding: 8px 12px; border-radius: 6px; text-align: center;">
                        功能开发中
                    </div>
                </div>
            </div>
        </div>
    <!-- 摄像头扫描界面 -->
<div id="cameraModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>扫描商品二维码</h3>
            <button class="close-btn" id="closeCameraModal">&times;</button>
        </div>
        <div class="modal-body">
            <div style="text-align: center;">
                <!-- 扫码框 -->
                <div class="camera-frame">
                    <video id="cameraPreview" autoplay playsinline 
                           style="width: 100%; max-width: 300px; border-radius: 8px;"></video>
                    <div class="scan-line"></div>
                </div>
                
                <div id="cameraStatus" style="margin: 15px 0; color: var(--text-muted);">
                    将二维码放入框内自动识别
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-outline" id="cancelScanBtn">
                        <i class="fas fa-times"></i>取消扫描
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
        
    </main>

    <!-- 产品选择弹窗 -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>选择产品系列</h3>
                <button class="close-btn" id="closeProductModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="product-grid" id="modalProductGrid">
                    <!-- 产品卡片将通过JS动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 底部导航 -->
    <nav class="bottom-nav">
        <a href="#scan" class="nav-item active" data-page="scan">
        <i class="fas fa-boxes"></i>  <!-- 修改图标为库存图标 -->
        <span>库存管理</span>  <!-- 修改文字 -->
        </a>
        <a href="#sale" class="nav-item" data-page="sale">
            <i class="fas fa-receipt"></i>
            <span>线下销售</span>
        </a>
        <a href="#data" class="nav-item" data-page="data">
            <i class="fas fa-chart-bar"></i>
            <span>数据查看</span>
        </a>
        <a href="#base" class="nav-item" data-page="base">
            <i class="fas fa-cog"></i>
            <span>基础数据</span>
        </a>
    </nav>

    <script>
        // API配置
const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbz_7KJ3iEV8I7ImNIcKikYO0oJLMrKiTOatuqhTT9W0imWdhGWdMMYUkVxT2FFzeeYy2w/exec';        
        class App {
constructor() {
    this.currentPage = 'scan';
    this.saleItems = [];
    this.productVariants = {};
    this.products = [];
    this.customers = [];
    this.salesRecords = [];
    this.selectedProduct = null;
    this.selectedVariant = null;
    this.useTestMode = false;
    this.productModalSource = null;
    this.stream = null;  // ← 在这里添加这一行
    this.qrDetectionInterval = null;
    
    // 批量价格缓存
    this.standardPrices = {};
    this.customerPrices = {};
    this.allVariants = [];
    
    this.currentCustomerId = null;
    this.customerChangeTimeout = null;
    
    this.init();
}
            
init() {
    this.bindEvents();
    this.bindInventoryEvents();  // 添加这一行
    this.hideLoading();
    this.loadInitialData();
}
            
            bindEvents() {
                // 底部导航点击事件
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = item.getAttribute('data-page');
                        this.switchPage(page);
                    });
                });
                
                // 扫码页面事件
                document.getElementById('startScan').addEventListener('click', () => {
                    this.startScan();
                });
                
                // 销售页面事件
document.getElementById('customerSelect').addEventListener('change', (e) => {
    // === 添加防抖处理 ===
    clearTimeout(this.customerChangeTimeout);
    this.customerChangeTimeout = setTimeout(() => {
        this.clearSaleForm();
        this.updateCustomerBalance(e.target.value);
        // 如果已选择产品，重新显示颜色选项以更新价格
        if (this.selectedProduct) {
            this.showColorSelection('sale');
        }
        // 如果已选择变体，立即更新价格显示
        if (this.selectedVariant) {
            // 直接从缓存获取价格并更新显示
            const customerId = e.target.value;
            const price = this.getPrice(this.selectedVariant.variant_id, customerId);
            
            // 更新价格显示
            const priceDisplay = document.getElementById('priceDisplay');
            if (priceDisplay) {
                priceDisplay.textContent = price;
            }
            
            // 更新价格提示
            const priceNote = document.getElementById('priceNote');
            if (priceNote) {
                if (customerId && this.customerPrices[customerId]?.[this.selectedVariant.variant_id] !== undefined) {
                    priceNote.textContent = '客户专属价格';
                    priceNote.className = 'price-note special-price';
                } else {
                    priceNote.textContent = '标准价格';
                    priceNote.className = 'price-note';
                }
            }
        }
    }, 300);
});
                
                document.getElementById('saleProductSelectBtn').addEventListener('click', () => {
                    this.openProductModal('sale');
                });
                
                document.getElementById('saleQuantity').addEventListener('change', () => {
                    this.updateItemTotal();
                });
                
                document.getElementById('addItemBtn').addEventListener('click', () => {
                    this.addSaleItem();
                });
                
                document.getElementById('confirmSale').addEventListener('click', () => {
                    this.confirmSale();
                });

                document.getElementById('downloadInvoice').addEventListener('click', () => {
                    this.downloadInvoice();
                });

                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.refreshData();
                });

                // 弹窗事件
                document.getElementById('closeProductModal').addEventListener('click', () => {
                    this.closeProductModal();
                });

                // 点击弹窗外部关闭
                document.getElementById('productModal').addEventListener('click', (e) => {
                    if (e.target.id === 'productModal') {
                        this.closeProductModal();
                    }
                });
                // 颜色选项的事件委托（处理动态生成的元素）
document.addEventListener('click', (e) => {
    if (e.target.closest('.color-option')) {
        const colorOption = e.target.closest('.color-option');
        const variantId = colorOption.dataset.variantId;
        // 判断是扫码页面还是销售页面的颜色选项
        const source = colorOption.closest('#scanColorOptions') ? 'scan' : 'sale';
        this.selectVariant(variantId, source);
    }
});
            }

            // 添加库存管理相关事件绑定
bindInventoryEvents() {
    // 手动输入按钮
    document.getElementById('manualInputBtn').addEventListener('click', () => {
        document.getElementById('manualVariantId').focus();
    });
    
    // 手动查询按钮
    document.getElementById('manualSearchBtn').addEventListener('click', () => {
        const variantId = document.getElementById('manualVariantId').value.trim();
        if (variantId) {
            this.lookupInventory(variantId);
        } else {
            this.showMessage('scanMessage', '请输入商品ID', 'error');
        }
    });
    
    // 回车键触发查询
    document.getElementById('manualVariantId').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            document.getElementById('manualSearchBtn').click();
        }
    });
    
    // 确认调整库存
    document.getElementById('confirmAdjust').addEventListener('click', () => {
        this.confirmInventoryAdjustment();
    });
    
    // 取消调整
    document.getElementById('cancelAdjust').addEventListener('click', () => {
        this.hideInventoryInfo();
    });
    
    // 调整类型变化时
    document.getElementById('adjustType').addEventListener('change', (e) => {
        if (e.target.value === 'set') {
            document.getElementById('adjustQuantity').placeholder = '输入要设置的库存数量';
        } else {
            document.getElementById('adjustQuantity').placeholder = '';
        }
    });
}
            
            // 打开产品选择弹窗
            openProductModal(source) {
                this.productModalSource = source;
                this.renderProductModal();
                document.getElementById('productModal').classList.add('show');
            }

            // 关闭产品选择弹窗
            closeProductModal() {
                document.getElementById('productModal').classList.remove('show');
                this.productModalSource = null;
            }

            // 渲染产品选择弹窗
            renderProductModal() {
                const container = document.getElementById('modalProductGrid');
                container.innerHTML = '';
                
                this.products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.dataset.modelId = product.model_id;
                    productCard.innerHTML = `
                        <div class="product-image">
                            <i class="fas fa-glasses"></i>
                        </div>
                        <div class="product-name">${product.model_name}</div>
                        <div class="product-stock">点击选择</div>
                    `;
                    
                    productCard.addEventListener('click', () => {
                        this.selectProductInModal(product.model_id);
                    });
                    
                    container.appendChild(productCard);
                });
            }

// 在弹窗中选择产品
selectProductInModal(modelId) {
    this.selectedProduct = this.products.find(p => p.model_id === modelId);
    this.closeProductModal();
    
    document.getElementById('selectedProductPreview').style.display = 'block';
    document.getElementById('previewProductName').textContent = this.selectedProduct.model_name;
    document.getElementById('saleColorSelection').style.display = 'block';
    this.showColorSelection('sale');
}
            
// 显示已选产品预览
showSelectedProductPreview() {
    const previewElement = document.getElementById('selectedProductPreview');
    const productNameElement = document.getElementById('previewProductName');
    const productModelElement = document.getElementById('previewProductModel');
    const productDetailsElement = document.getElementById('previewProductDetails');
    
    if (this.selectedProduct) {
        productNameElement.textContent = this.selectedProduct.model_name;
        productModelElement.textContent = `型号: ${this.selectedProduct.model_id}`;
        productDetailsElement.textContent = '颜色: 未选择 | 价格: ¥0 | 库存: 0';
        previewElement.style.display = 'block';
    } else {
        previewElement.style.display = 'none';
    }
}

// 更新销售页面的产品显示
updateSaleProductDisplay() {
    console.log('=== updateSaleProductDisplay 开始 ===');
    
    const previewElement = document.getElementById('selectedProductPreview');
    
    if (this.selectedProduct) {
        console.log('有选中产品，开始更新显示');
        
        // 显示选中产品区域，但不要隐藏选择按钮
        previewElement.style.display = 'block';
        
        // 只更新产品图片和名称，删除其他所有信息
        document.getElementById('previewProductName').textContent = this.selectedProduct.model_name;
        
        console.log('产品基本信息已更新');
    } else {
        console.log('没有选中产品，隐藏预览区域');
        previewElement.style.display = 'none';
    }
    
    console.log('=== updateSaleProductDisplay 结束 ===');
}

// 显示颜色选择
async showColorSelection(source) {
    const colorSelection = source === 'scan' ? 
        document.getElementById('scanColorSelection') : 
        document.getElementById('saleColorSelection');
    
    const colorOptions = source === 'scan' ? 
        document.getElementById('scanColorOptions') : 
        document.getElementById('saleColorOptions');
    
    colorSelection.style.display = 'block';
    colorOptions.innerHTML = '';
    
    const variants = this.productVariants[this.selectedProduct.model_id] || [];
    
    // 遍历所有变体创建颜色选项
    for (const variant of variants) {
        const colorOption = document.createElement('div');
        colorOption.className = 'color-option';
        colorOption.dataset.variantId = variant.variant_id;
        colorOption.innerHTML = `
            ${variant.color} 
            <span style="font-size: 0.8rem; color: #666;">
                (库存: ${variant.stock})
            </span>
        `;
        
        colorOptions.appendChild(colorOption);
    }
}



        // === 新方法：从缓存获取价格（同步，无网络请求）===
getPrice(variantId, customerId) {
    if (!variantId) {
        console.log('getPrice: variantId为空');
        return 0;
    }
    
    console.log(`getPrice调用: variantId=${variantId}, customerId=${customerId}`);
    
    // 1. 优先客户专属价
    if (customerId && 
        this.customerPrices[customerId] && 
        this.customerPrices[customerId][variantId] !== undefined) {
        
        const price = this.customerPrices[customerId][variantId];
        console.log(`使用客户专属价: ¥${price} (客户: ${customerId})`);
        return price;
    }
    
    // 2. 其次标准价
    if (this.standardPrices[variantId] !== undefined) {
        const price = this.standardPrices[variantId];
        console.log(`使用标准价: ¥${price}`);
        return price;
    }
    
    // 3. 都没找到，尝试从变体数据中找
    const variant = this.allVariants.find(v => v.variant_id === variantId);
    if (variant) {
        console.log(`从变体数据获取价格: ¥${variant.price}`);
        // 顺便更新缓存
        this.standardPrices[variantId] = variant.price;
        return variant.price;
    }
    
    console.log('未找到价格，返回0');
    return 0;
}

// === 修改颜色选择方法 ===
async selectVariant(variantId, source) {
    console.log(`selectVariant: ${variantId}, source: ${source}`);
    
    // 更新选中状态
    const colorOptions = source === 'scan' ? 
        document.getElementById('scanColorOptions') : 
        document.getElementById('saleColorOptions');
    
    // 移除所有选中状态
    document.querySelectorAll('.color-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // 查找选中的变体
    this.selectedVariant = this.findVariantById(variantId);
    
    if (!this.selectedVariant) {
        console.log('未找到变体:', variantId);
        return;
    }
    
    // 更新显示
    if (source === 'sale') {
        // === 关键修改：直接从缓存获取价格 ===
        const customerId = document.getElementById('customerSelect').value;
        const price = this.getPrice(variantId, customerId);
        
        console.log(`获取到价格: ¥${price}, 客户: ${customerId || '未选择'}`);
        
        // 更新价格显示
        const priceDisplay = document.getElementById('priceDisplay');
        if (priceDisplay) {
            priceDisplay.textContent = price;
        }
        
        // 更新价格提示
        const priceNote = document.getElementById('priceNote');
        if (priceNote) {
            if (customerId && this.customerPrices[customerId]?.[variantId] !== undefined) {
                priceNote.textContent = '客户专属价格';
                priceNote.className = 'price-note special-price';
            } else {
                priceNote.textContent = '标准价格';
                priceNote.className = 'price-note';
            }
        }
        
        // 更新颜色选项显示
        const selectedOption = document.querySelector(`.color-option[data-variant-id="${variantId}"]`);
        if (selectedOption) {
            selectedOption.classList.add('selected');
        }
        
    }
}


            // 使用测试数据
            useTestData() {
                this.useTestMode = true;
                this.addTestCustomers();
                this.addTestProducts();
                this.loadTestSalesRecords();
                this.showMessage('saleMessage', '已切换到测试模式，使用模拟数据', 'success');
            }
            
            async refreshData() {
                this.showMessage('saleMessage', '重新加载数据中...', 'success');
                await this.loadInitialData();
            }
            
            switchPage(page) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-page="${page}"]`).classList.add('active');
                
                this.showPage(page);
                this.currentPage = page;
                this.updatePageTitle(page);
            }
            
            showPage(page) {
                document.querySelectorAll('.page').forEach(pageEl => {
                    pageEl.classList.remove('active');
                });
                
                const targetPage = document.getElementById(`${page}-page`);
                if (targetPage) {
                    targetPage.classList.add('active');
                }
            }
            
           updatePageTitle(page) {
    const titles = {
        'scan': '库存管理',
        'sale': '线下销售', 
        'data': '数据查看',
        'base': '基础数据'
    };
    document.getElementById('pageTitle').textContent = titles[page] || '赛娜眼镜进销存';
}
            
            hideLoading() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            }
            
            async loadInitialData() {
                const debugInfo = document.getElementById('initDebug');
                debugInfo.innerHTML = '开始加载初始数据...';
                
                try {
                    await this.loadCustomers();
                    await this.loadProducts();
                    await this.loadSalesRecords();
                    debugInfo.innerHTML = '数据加载完成！';
                } catch (error) {
                    debugInfo.innerHTML = `数据加载失败: ${error.message}`;
                    this.useTestData();
                    this.showMessage('scanMessage', '使用测试数据模式', 'warning');
                    this.showMessage('saleMessage', '使用测试数据模式', 'warning');
                }
            }
            
            async loadCustomers() {
                try {
                    const response = await fetch(`${API_BASE_URL}?action=getCustomers&t=${Date.now()}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.customers = data.data;
                        const select = document.getElementById('customerSelect');
                        select.innerHTML = '<option value="">请选择客户...</option>';
                        
                        data.data.forEach(customer => {
                            const option = document.createElement('option');
                            option.value = customer.customer_id;
                            option.textContent = customer.name;
                            select.appendChild(option);
                        });
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    console.error('加载客户失败:', error);
                    throw error;
                }
            }

            addTestCustomers() {
                this.customers = [
                    { customer_id: 'C001', name: '张三贸易' },
                    { customer_id: 'C002', name: '李四光学' },
                    { customer_id: 'C003', name: '王五眼镜店' },
                    { customer_id: 'C004', name: '网店客户' }
                ];
                
                const select = document.getElementById('customerSelect');
                select.innerHTML = '<option value="">请选择客户...</option>';
                this.customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.customer_id;
                    option.textContent = customer.name;
                    select.appendChild(option);
                });
            }
            
           async loadProducts() {
    try {
        const response = await fetch(`${API_BASE_URL}?action=getProducts&t=${Date.now()}`);
        const data = await response.json();
        
        if (data.success) {
            this.products = data.data;
            
            // === 新增：批量加载所有变体 ===
            await this.loadAllVariants();
            // ============================
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('加载产品失败:', error);
        throw error;
    }
}

// === 新增方法：批量加载所有变体 ===
async loadAllVariants() {
    try {
        console.log('开始批量加载所有变体...');
        const allVariants = [];
        const standardPrices = {};
        
        // 为每个产品系列加载变体
        for (const product of this.products) {
            const response = await fetch(`${API_BASE_URL}?action=getProductVariants&model_id=${product.model_id}&t=${Date.now()}`);
            const data = await response.json();
            
            if (data.success && data.data) {
                // 添加到总列表
                allVariants.push(...data.data);
                
                // 构建标准价缓存
                data.data.forEach(variant => {
                    standardPrices[variant.variant_id] = variant.price;
                    
                    // 确保productVariants结构正确
                    if (!this.productVariants[product.model_id]) {
                        this.productVariants[product.model_id] = [];
                    }
                    this.productVariants[product.model_id].push(variant);
                });
            }
        }
        
        this.allVariants = allVariants;
        this.standardPrices = standardPrices;
        console.log(`批量加载完成，共 ${allVariants.length} 个变体`);
        
    } catch (error) {
    console.error('批量加载变体失败，尝试逐个加载:', error);
    // 回退到原来的逐个加载方式，并确保填充 allVariants
    const allVariants = []; // 创建临时数组收集
    for (const product of this.products) {
        await this.loadProductVariants(product.model_id); // 这个方法会填充 this.productVariants
        // 将刚加载的变体也加入到总列表
        if (this.productVariants[product.model_id]) {
            allVariants.push(...this.productVariants[product.model_id]);
        }
    }
    // 将收集到的所有变体存入 this.allVariants
    this.allVariants = allVariants;
    console.log(`回退加载完成，共 ${allVariants.length} 个变体`);
}
}

            // === 新增方法：加载客户所有专属价格 ===
async loadCustomerPrices(customerId) {
    if (!customerId) return;
    
    try {
        // 调用新API：getCustomerPrices（复数）
        const response = await fetch(`${API_BASE_URL}?action=getCustomerPrices&customer_id=${customerId}&t=${Date.now()}`);
        const data = await response.json();
        
        if (data.success) {
            // 存储格式: {V001: 280, V002: 290}
            this.customerPrices[customerId] = data.data || {};
            console.log(`已加载客户 ${customerId} 的专属价格，共 ${Object.keys(data.data || {}).length} 条`);
        }
    } catch (error) {
        console.error(`加载客户 ${customerId} 价格失败:`, error);
        this.customerPrices[customerId] = {};
    }
}

            addTestProducts() {
                this.products = [
                    { model_id: 'M001', model_name: '经典金属系列' },
                    { model_id: 'M002', model_name: '时尚塑胶系列' },
                    { model_id: 'M003', model_name: '运动休闲系列' }
                ];
                
                // 添加测试变体数据
                this.productVariants = {
                    'M001': [
                        { variant_id: 'V001', model_id: 'M001', color: '黑色', price: 299, stock: 50, product_image: '' },
                        { variant_id: 'V002', model_id: 'M001', color: '银色', price: 299, stock: 30, product_image: '' }
                    ],
                    'M002': [
                        { variant_id: 'V003', model_id: 'M002', color: '棕色', price: 199, stock: 25, product_image: '' }
                    ],
                    'M003': [
                        { variant_id: 'V004', model_id: 'M003', color: '蓝色', price: 399, stock: 40, product_image: '' }
                    ]
                };
            }

            async loadProductVariants(modelId) {
                try {
                    const response = await fetch(`${API_BASE_URL}?action=getProductVariants&model_id=${modelId}&t=${Date.now()}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        if (!this.productVariants[modelId]) {
                            this.productVariants[modelId] = [];
                        }
                        this.productVariants[modelId] = data.data;
                    }
                } catch (error) {
                    console.error(`加载产品变体失败 (${modelId}):`, error);
                }
            }

           findVariantById(variantId) {
    // 1. 首先在总列表 allVariants 中查找（速度快）
    let variant = this.allVariants.find(v => v.variant_id === variantId);
    if (variant) return variant;
    
    // 2. 如果没找到，再遍历 productVariants 结构查找（确保不遗漏）
    for (const modelId in this.productVariants) {
        variant = this.productVariants[modelId].find(v => v.variant_id === variantId);
        if (variant) {
            // 顺便把它加入 allVariants 缓存，下次就快了
            this.allVariants.push(variant);
            return variant;
        }
    }
    return null; // 确实没找到
}

            async loadSalesRecords() {
                try {
                    const response = await fetch(`${API_BASE_URL}?action=getSalesRecords&t=${Date.now()}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.salesRecords = data.data;
                    }
                } catch (error) {
                    console.error('加载销售记录失败:', error);
                    // 不抛出错误，因为销售记录不是关键数据
                }
            }

            loadTestSalesRecords() {
                this.salesRecords = [
                    { sale_id: 'S001', customer_id: 'C001', total_amount: 598, status: '待收款' },
                    { sale_id: 'S002', customer_id: 'C001', total_amount: 897, status: '待收款' },
                    { sale_id: 'S003', customer_id: 'C002', total_amount: 199, status: '待收款' }
                ];
            }

// 清空销售表单
clearSaleForm() {
    this.saleItems = [];
    this.updateSaleItemsDisplay();
    this.selectedProduct = null;
    this.selectedVariant = null;
    
    // 重置产品选择 - 确保使用正确的显示控制
    document.getElementById('selectedProductPreview').style.display = 'none';
    document.getElementById('saleProductSelectBtn').style.display = 'block';
    document.getElementById('saleColorSelection').style.display = 'none';
    document.getElementById('saleColorOptions').innerHTML = '';
    document.getElementById('saleQuantity').value = 1;

    
    // 修复：添加元素存在性检查
    const priceNoteElement = document.getElementById('priceNote');
    if (priceNoteElement) {
        priceNoteElement.innerHTML = '';
    }
    
    this.showMessage('saleMessage', '已清空销售清单', 'success');
}

async updateCustomerBalance(customerId) {
    const balanceElement = document.getElementById('customerBalance');
    const balanceAmount = document.getElementById('balanceAmount');
    
    if (!customerId) {
        balanceElement.classList.add('hidden');
        return;
    }
    
    // === 新增第一步：批量加载该客户专属价格 ===
    await this.loadCustomerPrices(customerId);
    // =====================================
    
    // 确保销售记录数据已加载，如果未加载显示"计算中..."
    if (!this.salesRecords || this.salesRecords.length === 0) {
        balanceAmount.textContent = '计算中...';
        balanceElement.classList.remove('hidden');
        
        // 可选：延迟重试一次（3秒后）
        setTimeout(() => {
            if (this.salesRecords && this.salesRecords.length > 0) {
                this.updateCustomerBalance(customerId); // 重新计算
            }
        }, 3000);
        return;
    }
    
    const pendingAmount = this.calculatePendingAmount(customerId);
    
    // 无论金额是多少都显示，包括0
    balanceAmount.textContent = pendingAmount.toFixed(2);
    balanceElement.classList.remove('hidden');
    
    // === 修改这里：如果已经选择了颜色变体，直接从缓存更新价格 ===
    if (this.selectedVariant) {
        // 直接从缓存获取价格
        const price = this.getPrice(this.selectedVariant.variant_id, customerId);
        
        // 更新价格显示（假设你已经修改了价格显示方式）
        if (document.getElementById('priceDisplay')) {
            document.getElementById('priceDisplay').textContent = price;
        }
        
        // 更新价格提示
        const priceNote = document.getElementById('priceNote');
        if (priceNote) {
            if (customerId && this.customerPrices[customerId]?.[this.selectedVariant.variant_id] !== undefined) {
                priceNote.textContent = '客户专属价格';
                priceNote.className = 'price-note special-price';
            } else {
                priceNote.textContent = '标准价格';
                priceNote.className = 'price-note';
            }
        }
        
        // 更新颜色选项的显示（不需要重新查询价格）
        const selectedOption = document.querySelector(`.color-option[data-variant-id="${this.selectedVariant.variant_id}"]`);
        if (selectedOption) {
            // 这里不再需要异步获取价格
            selectedOption.innerHTML = `
                ${this.selectedVariant.color} 
                <span style="font-size: 0.8rem; color: #666;">
                    (库存: ${this.selectedVariant.stock})
                </span>
            `;
        }
    }
}

            calculatePendingAmount(customerId) {
                return this.salesRecords
                    .filter(record => record.customer_id === customerId && record.status === '待收款')
                    .reduce((sum, record) => sum + record.total_amount, 0);
            }

            updateItemTotal() {
                // 如果需要实时计算总价可以在这里实现
            }
            
            addSaleItem() {
    const customerId = document.getElementById('customerSelect').value;
    const quantity = parseInt(document.getElementById('saleQuantity').value);
    
    // === 修改：不再从输入框获取，而是自动计算 ===
    // const unitPrice = parseFloat(document.getElementById('unitPrice').value);
    const unitPrice = this.getPrice(this.selectedVariant.variant_id, customerId);
    // ==========================================
    
    if (!customerId) {
        this.showMessage('saleMessage', '请选择客户', 'error');
        return;
    }

    if (!this.selectedVariant) {
        this.showMessage('saleMessage', '请选择产品颜色', 'error');
        return;
    }

    if (!quantity || quantity < 1) {
        this.showMessage('saleMessage', '请输入正确的数量', 'error');
        return;
    }

    // === 修改：价格验证逻辑 ===
    if (!unitPrice || unitPrice <= 0) {
        this.showMessage('saleMessage', '价格获取失败，请重新选择产品', 'error');
        return;
    }

    if (this.selectedVariant.stock < quantity) {
        this.showMessage('saleMessage', `库存不足，当前库存: ${this.selectedVariant.stock}`, 'error');
        return;
    }
    
    const item = {
        customerId,
        variantId: this.selectedVariant.variant_id,
        variantName: `${this.selectedProduct.model_name} - ${this.selectedVariant.color}`,
        quantity,
        unitPrice: unitPrice,  // 使用自动计算的价格
        total: quantity * unitPrice
    };
    
    this.saleItems.push(item);
    this.updateSaleItemsDisplay();
    this.showMessage('saleMessage', '商品已添加到销售单', 'success');
    
    // 重置数量
    document.getElementById('saleQuantity').value = 1;
}
            
updateSaleItemsDisplay() {
    const itemsList = document.getElementById('itemsList');
    const totalAmount = document.getElementById('totalAmount');
    const saleItemsSection = document.getElementById('saleItems');
    const confirmSaleBtn = document.getElementById('confirmSale');
    
    itemsList.innerHTML = '';
    let total = 0;
    
    this.saleItems.forEach((item, index) => {
        total += item.total;
        
        const itemCard = document.createElement('div');
        itemCard.className = 'item-card';
        itemCard.innerHTML = `
            <div class="item-info">
                <h4>${item.variantName}</h4>
                <p>数量: ${item.quantity} × ¥${item.unitPrice}</p>
            </div>
            <div class="item-actions">
                <span>¥${item.total}</span>
                <button class="qty-btn" onclick="app.removeSaleItem(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        itemsList.appendChild(itemCard);
    });
    
    totalAmount.textContent = total.toFixed(2);
    
    // 控制显示
    const hasItems = this.saleItems.length > 0;
    saleItemsSection.style.display = hasItems ? 'block' : 'none';
    confirmSaleBtn.style.display = hasItems ? 'block' : 'none';
}
            
            removeSaleItem(index) {
                this.saleItems.splice(index, 1);
                this.updateSaleItemsDisplay();
            }
            
            async confirmSale() {
                if (this.saleItems.length === 0) {
                    this.showMessage('saleMessage', '请添加销售商品', 'error');
                    return;
                }

                const customerId = document.getElementById('customerSelect').value;
                const customer = this.customers.find(c => c.customer_id === customerId);

                if (this.useTestMode) {
                    // 测试模式 - 模拟成功
                    this.showMessage('saleMessage', '测试模式: 销售出库成功！', 'success');
                    this.generateReceipt(customer.name);
                    this.clearSaleForm();
                    return;
                }

                try {
                    // 为每个商品创建销售记录
                    for (const item of this.saleItems) {
                        const saleData = {
                            customer_id: item.customerId,
                            variant_id: item.variantId,
                            quantity: item.quantity,
                            unit_price: item.unitPrice,  // ← 添加这行
                            operator: '销售员'
                        };

                        // 构建URL参数 - 确保参数正确传递
                        const params = new URLSearchParams();
                        params.append('action', 'createSale');
                        params.append('customer_id', saleData.customer_id);
                        params.append('variant_id', saleData.variant_id);
                        params.append('quantity', saleData.quantity.toString());
                        params.append('operator', saleData.operator);
                        params.append('unit_price', saleData.unit_price.toString());  // ← 添加这行

                        console.log('销售参数:', params.toString());

                        const response = await fetch(`${API_BASE_URL}?${params}`);
                        const result = await response.json();
                        
                        if (!result.success) {
                            throw new Error(result.message || `销售失败: ${item.variantName}`);
                        }
                    }

                    this.showMessage('saleMessage', '销售出库成功！', 'success');
                    this.generateReceipt(customer.name);
                    this.clearSaleForm();
                    
                    // 重新加载数据
                    await this.loadSalesRecords();
                    
                } catch (error) {
                    console.error('销售失败:', error);
                    this.showMessage('saleMessage', '销售失败: ' + error.message, 'error');
                }
            }

            generateReceipt(customerName) {
                const invoiceContent = document.getElementById('invoiceContent');
                const invoicePreview = document.getElementById('invoicePreview');
                const now = new Date();
                const invoiceNumber = 'SN' + now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0') + String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');

                let itemsHTML = '';
                let totalAmount = 0;

                this.saleItems.forEach(item => {
                    totalAmount += item.total;
                    itemsHTML += `
                        <div class="receipt-item">
                            <div class="receipt-item-name">${item.variantName}</div>
                            <div class="receipt-item-details">${item.quantity} × ¥${item.unitPrice}</div>
                        </div>
                        <div class="receipt-item">
                            <div class="receipt-item-name"></div>
                            <div class="receipt-item-details">¥${item.total}</div>
                        </div>
                    `;
                });

                const customerId = document.getElementById('customerSelect').value;
                const pendingAmount = this.calculatePendingAmount(customerId);

                invoiceContent.innerHTML = `
                    <div class="receipt" id="receiptToDownload">
                        <div class="receipt-header">
                            <div class="receipt-title">赛娜眼镜</div>
                            <div>销售单据</div>
                        </div>
                        
                        <div class="receipt-info">
                            <div>单号: ${invoiceNumber}</div>
                            <div>日期: ${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}</div>
                            <div>时间: ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}</div>
                        </div>
                        
                        <div class="receipt-info">
                            <div>客户: ${customerName}</div>
                        </div>
                        
                        <div class="receipt-divider"></div>
                        
                        <div class="receipt-items">
                            ${itemsHTML}
                        </div>
                        
                        <div class="receipt-divider"></div>
                        
                        <div class="receipt-total">
                            合计: ¥${totalAmount.toFixed(2)}
                        </div>
                        
                        ${pendingAmount > 0 ? `
                        <div class="receipt-balance">
                            <div>累计待收款: ¥${pendingAmount.toFixed(2)}</div>
                            <div>本次后累计: ¥${(pendingAmount + totalAmount).toFixed(2)}</div>
                        </div>
                        ` : ''}
                        
                        <div class="receipt-footer">
                            <div>SENNA GLASSES</div>
                        </div>
                    </div>
                `;

                invoicePreview.style.display = 'block';
            }

            async downloadInvoice() {
                const receiptElement = document.getElementById('receiptToDownload');
                
                try {
                    const canvas = await html2canvas(receiptElement, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff'
                    });
                    
                    const link = document.createElement('a');
                    link.download = `赛娜眼镜销售单_${new Date().getTime()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    this.showMessage('saleMessage', '销售单下载成功', 'success');
                } catch (error) {
                    console.error('下载销售单失败:', error);
                    this.showMessage('saleMessage', '下载失败: ' + error.message, 'error');
                }
            }
            
async startScan() {
    console.log('=== 启动真实摄像头扫码 ===');
    
    // 检查设备类型
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    console.log('设备类型:', isMobile ? '移动设备' : '桌面设备');
    
    // 检查浏览器支持
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        this.showMessage('scanMessage', '您的浏览器不支持摄像头功能', 'error');
        this.startMockScan();
        return;
    }
    
    // 显示摄像头界面
    this.showCameraScanner();
}

            // 显示摄像头扫描界面
showCameraScanner() {
    const modal = document.getElementById('cameraModal');
    modal.classList.add('show');
    
    // 绑定关闭按钮
    document.getElementById('closeCameraModal').onclick = () => {
        this.stopCamera();
        modal.classList.remove('show');
    };
    
    document.getElementById('cancelScanBtn').onclick = () => {
        this.stopCamera();
        modal.classList.remove('show');
    };
    
    // 启动摄像头
    this.startCamera();
}

// 启动摄像头
async startCamera() {
    const video = document.getElementById('cameraPreview');
    const status = document.getElementById('cameraStatus');
    
    try {
        status.textContent = '正在启动摄像头...';
        status.style.color = 'var(--warning-color)';
        
        // 摄像头配置
        const constraints = {
            video: {
                facingMode: 'environment', // 后置摄像头
                width: { ideal: 1280 },
                height: { ideal: 720 }
            },
            audio: false
        };
        
        // 获取摄像头权限和视频流
        this.stream = await navigator.mediaDevices.getUserMedia(constraints);
        
        // 显示视频流
        video.srcObject = this.stream;
        
        // 等待视频加载
        await new Promise((resolve) => {
            video.onloadedmetadata = () => {
                video.play();
                resolve();
            };
        });
        
        status.textContent = '摄像头已就绪！将二维码放入框内';
        status.style.color = 'var(--success-color)';
        
        console.log('摄像头启动成功，分辨率:', video.videoWidth, 'x', video.videoHeight);
        // 开始二维码识别
this.startQRCodeDetection(video);
        
    } catch (error) {
        console.error('摄像头启动失败:', error);
        
        // 显示具体的错误信息
        let errorMsg = '摄像头启动失败: ';
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            errorMsg = '请允许摄像头权限，然后重试';
            status.textContent = errorMsg;
            status.style.color = 'var(--danger-color)';
            
            // 3秒后关闭
            setTimeout(() => {
                document.getElementById('cameraModal').classList.remove('show');
                this.showMessage('scanMessage', '请允许摄像头权限后重试', 'error');
            }, 3000);
            
        } else if (error.name === 'NotFoundError') {
            errorMsg = '未找到摄像头设备';
            status.textContent = errorMsg;
            status.style.color = 'var(--danger-color)';
            
        } else {
            errorMsg = error.message;
            status.textContent = '摄像头错误: ' + errorMsg;
            status.style.color = 'var(--danger-color)';
        }
        
        // 回退到模拟扫码
        setTimeout(() => {
            document.getElementById('cameraModal').classList.remove('show');
            this.startMockScan();
        }, 3000);
    }
}

stopCamera() {
    // 停止二维码识别
    if (this.qrDetectionInterval) {
        clearInterval(this.qrDetectionInterval);
        this.qrDetectionInterval = null;
    }
    
    // 停止摄像头
    if (this.stream) {
        this.stream.getTracks().forEach(track => {
            track.stop();
        });
        this.stream = null;
    }
    
    const video = document.getElementById('cameraPreview');
    if (video) {
        video.srcObject = null;
    }
    
    console.log('摄像头已完全停止');
}
           // 开始二维码识别
startQRCodeDetection(video) {
    console.log('开始二维码识别...');
    
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    const status = document.getElementById('cameraStatus');
    
    // 保存interval ID，用于清理
    this.qrDetectionInterval = setInterval(() => {
        // 检查摄像头是否还在运行
        if (!this.stream || !video.videoWidth) {
            console.log('摄像头未就绪，停止识别');
            clearInterval(this.qrDetectionInterval);
            return;
        }
        
        try {
            // 设置canvas尺寸为视频尺寸
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // 绘制当前视频帧到canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // 获取图像数据
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            
            // 使用jsQR识别二维码
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });
            
            // 如果识别到二维码
            if (code) {
                console.log('识别到二维码:', code.data);
                clearInterval(this.qrDetectionInterval);
                this.handleScannedQRCode(code.data);
            }
            
        } catch (error) {
            console.error('二维码识别出错:', error);
        }
        
    }, 300); // 每300毫秒识别一次
}

// 处理识别到的二维码
handleScannedQRCode(qrData) {
    console.log('处理二维码数据:', qrData);
    
    // 播放提示音（可选）
    this.playScanSuccessSound();
    
    // 停止摄像头
    this.stopCamera();
    
    // 关闭摄像头界面
    document.getElementById('cameraModal').classList.remove('show');
    
    // 提取商品ID
    const variantId = this.extractVariantIdFromQR(qrData);
    
    if (variantId) {
        // 自动填入输入框
        document.getElementById('manualVariantId').value = variantId;
        
        // 自动查询商品
        setTimeout(() => {
            this.lookupInventory(variantId);
        }, 500);
        
        this.showMessage('scanMessage', `扫码成功: ${variantId}`, 'success');
    } else {
        this.showMessage('scanMessage', '无法识别该二维码格式', 'error');
        
        // 3秒后重新启动扫码
        setTimeout(() => {
            this.showCameraScanner();
        }, 3000);
    }
}

// 播放扫码成功音效（可选）
playScanSuccessSound() {
    try {
        // 创建短暂的提示音
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.5);
        
    } catch (error) {
        console.log('音效播放失败:', error);
        // 不影响主要功能
    }
} 

// 模拟扫码（备用）
startMockScan() {
    this.showMessage('scanMessage', '使用模拟扫码功能...', 'warning');
    
    // 随机选择一个测试商品
    const mockVariantIds = ['V001', 'V002', 'V003', 'V004'];
    const randomVariantId = mockVariantIds[Math.floor(Math.random() * mockVariantIds.length)];
    
    document.getElementById('manualVariantId').value = randomVariantId;
    this.lookupInventory(randomVariantId);
    
    this.showMessage('scanMessage', `模拟扫码: ${randomVariantId}`, 'success');
}
            
// 从二维码内容提取商品ID
extractVariantIdFromQR(qrContent) {
    // 假设二维码内容是变体ID，如 "V001"
    // 或者可能是URL格式，需要提取ID
    if (qrContent.startsWith('http')) {
        // 如果是URL，尝试提取参数
        const urlParams = new URL(qrContent).searchParams;
        return urlParams.get('variant_id') || qrContent;
    }
    return qrContent;
}

// 查找库存信息
async lookupInventory(variantId) {
    try {
        // 先尝试从本地数据查找
        const variant = this.findVariantById(variantId);
        
        if (!variant) {
            this.showMessage('scanMessage', '未找到该商品，请检查ID是否正确', 'error');
            return;
        }
        
        // 找到商品对应的产品系列
        const product = this.products.find(p => 
            this.productVariants[p.model_id]?.some(v => v.variant_id === variantId)
        );
        
        if (!product) {
            this.showMessage('scanMessage', '商品信息不完整', 'error');
            return;
        }
        
        // 存储当前选中的变体和产品
        this.selectedVariant = variant;
        this.selectedProduct = product;
        
        // 显示库存信息
        this.showInventoryInfo(variant, product);
        
    } catch (error) {
        console.error('查找库存失败:', error);
        this.showMessage('scanMessage', '查找失败: ' + error.message, 'error');
    }
}

// 显示库存信息
showInventoryInfo(variant, product) {
    const inventoryInfo = document.getElementById('inventoryInfo');
    
    // 更新显示信息
    document.getElementById('inventoryProductName').textContent = product.model_name;
    document.getElementById('inventoryProductColor').textContent = `颜色: ${variant.color}`;
    document.getElementById('inventoryProductModel').textContent = `型号: ${product.model_id} | 变体ID: ${variant.variant_id}`;
    document.getElementById('currentStock').textContent = variant.stock;
    
    // 更新最后更新时间
    const now = new Date();
    document.getElementById('lastUpdated').textContent = 
        `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    
    // 显示库存信息区域
    inventoryInfo.style.display = 'block';
    
    // 滚动到库存区域
    inventoryInfo.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    this.showMessage('scanMessage', `已找到: ${product.model_name} - ${variant.color}`, 'success');
}

// 隐藏库存信息
hideInventoryInfo() {
    document.getElementById('inventoryInfo').style.display = 'none';
    document.getElementById('manualVariantId').value = '';
    this.showMessage('scanMessage', '已取消操作', 'warning');
}

// 确认库存调整
async confirmInventoryAdjustment() {
    const variant = this.selectedVariant;
    if (!variant) {
        this.showMessage('scanMessage', '请先选择商品', 'error');
        return;
    }
    
    const adjustType = document.getElementById('adjustType').value;
    const quantity = parseInt(document.getElementById('adjustQuantity').value);
    const reason = document.getElementById('adjustReason').value;
    const remark = document.getElementById('adjustRemark').value.trim();
    
    if (!quantity || quantity < 1) {
        this.showMessage('scanMessage', '请输入有效的数量', 'error');
        return;
    }
    
    let newStock = variant.stock;
    let operation = '';
    
    switch (adjustType) {
        case 'increase':
            newStock += quantity;
            operation = '增加';
            break;
        case 'decrease':
            if (variant.stock < quantity) {
                this.showMessage('scanMessage', `库存不足，当前库存: ${variant.stock}`, 'error');
                return;
            }
            newStock -= quantity;
            operation = '减少';
            break;
        case 'set':
            newStock = quantity;
            operation = '设置';
            break;
    }
    
    if (this.useTestMode) {
        // 测试模式 - 模拟更新
        variant.stock = newStock;
        this.showInventoryInfo(variant, this.selectedProduct);
        this.showMessage('scanMessage', `测试模式: ${operation}库存成功！新库存: ${newStock}`, 'success');
        return;
    }
    
    try {
        // 实际API调用
        const params = new URLSearchParams();
        params.append('action', 'updateStock');
        params.append('variant_id', variant.variant_id);
        params.append('new_stock', newStock.toString());
        params.append('adjustment', quantity.toString());
        params.append('operation', adjustType);
        params.append('reason', reason);
        params.append('remark', remark);
        params.append('operator', '管理员');
        
        const response = await fetch(`${API_BASE_URL}?${params}`);
        const result = await response.json();
        
        if (result.success) {
            // 更新本地数据
            variant.stock = newStock;
            this.showInventoryInfo(variant, this.selectedProduct);
            this.showMessage('scanMessage', `${operation}库存成功！新库存: ${newStock}`, 'success');
            
            // 重置表单
            document.getElementById('adjustQuantity').value = 1;
            document.getElementById('adjustRemark').value = '';
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('库存调整失败:', error);
        this.showMessage('scanMessage', '库存调整失败: ' + error.message, 'error');
    }
}
            showMessage(containerId, message, type) {
                const container = document.getElementById(containerId);
                container.innerHTML = `<div class="message ${type}">${message}</div>`;
                
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new App();
        });
    </script>
</body>
</html>
