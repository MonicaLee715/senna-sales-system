<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>赛娜眼镜进销存 - 基础测试版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn { background: #667eea; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1rem; cursor: pointer; width: 100%; margin: 5px 0; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .form-group { margin-bottom: 15px; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .debug-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 0.9rem; white-space: pre-wrap; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        h2 { margin-bottom: 15px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h2>API连接测试</h2>
        
        <div class="card">
            <h3>基础API测试</h3>
            <button class="btn" onclick="testBasicAPI()">测试基础连接</button>
            <button class="btn" onclick="testGetCustomers()">测试获取客户</button>
            <button class="btn" onclick="testGetProducts()">测试获取产品</button>
        </div>

        <div class="card">
            <h3>扫码出入库测试</h3>
            <div class="form-group">
                <input type="text" class="form-input" id="testVariantCode" placeholder="产品编码 (如 V001)" value="V001">
            </div>
            <div class="form-group">
                <input type="number" class="form-input" id="testQuantity" value="1" min="1">
            </div>
            <button class="btn btn-success" onclick="testScanSale()">测试扫码销售</button>
            <button class="btn btn-danger" onclick="testNormalSale()">测试普通销售</button>
        </div>

        <div class="card">
            <h3>调试信息</h3>
            <div id="debugOutput" class="debug-info">点击上面的按钮开始测试...</div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwhElTCOUFTYdGghiQ-WqeQWThPLEZdOs9u5qORLSkHiO1zdtvDl5MLv2NeRTXurf-hqQ/exec';

        // 基础API测试
        async function testBasicAPI() {
            const debug = document.getElementById('debugOutput');
            debug.innerHTML = '测试基础API连接...';
            
            try {
                const response = await fetch(`${API_BASE_URL}?action=test`);
                const data = await response.json();
                
                debug.innerHTML = `✅ API基础连接成功！\n响应: ${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                debug.innerHTML = `❌ API连接失败\n错误: ${error.message}\n\n建议:\n1. 检查API链接是否正确\n2. 检查Google Apps Script是否已部署\n3. 检查网络连接`;
            }
        }

        // 测试获取客户
        async function testGetCustomers() {
            const debug = document.getElementById('debugOutput');
            debug.innerHTML = '获取客户数据...';
            
            try {
                const response = await fetch(`${API_BASE_URL}?action=getCustomers`);
                const data = await response.json();
                
                if (data.success) {
                    debug.innerHTML = `✅ 获取客户成功！\n找到 ${data.data.length} 个客户:\n${data.data.map(c => `${c.customer_id}: ${c.name}`).join('\n')}`;
                } else {
                    debug.innerHTML = `❌ 获取客户失败\n错误: ${data.message}`;
                }
            } catch (error) {
                debug.innerHTML = `❌ 获取客户失败\n错误: ${error.message}`;
            }
        }

        // 测试获取产品
        async function testGetProducts() {
            const debug = document.getElementById('debugOutput');
            debug.innerHTML = '获取产品数据...';
            
            try {
                const response = await fetch(`${API_BASE_URL}?action=getProducts`);
                const data = await response.json();
                
                if (data.success) {
                    debug.innerHTML = `✅ 获取产品成功！\n找到 ${data.data.length} 个产品系列:\n${data.data.map(p => `${p.model_id}: ${p.model_name}`).join('\n')}`;
                    
                    // 测试获取变体
                    if (data.data.length > 0) {
                        const modelId = data.data[0].model_id;
                        debug.innerHTML += `\n\n获取第一个系列的变体...`;
                        
                        const variantResponse = await fetch(`${API_BASE_URL}?action=getProductVariants&model_id=${modelId}`);
                        const variantData = await variantResponse.json();
                        
                        if (variantData.success) {
                            debug.innerHTML += `\n✅ 获取变体成功！\n找到 ${variantData.data.length} 个变体:\n${variantData.data.map(v => `${v.variant_id}: ${v.color} - 库存: ${v.stock} - 价格: ${v.price}`).join('\n')}`;
                        } else {
                            debug.innerHTML += `\n❌ 获取变体失败: ${variantData.message}`;
                        }
                    }
                } else {
                    debug.innerHTML = `❌ 获取产品失败\n错误: ${data.message}`;
                }
            } catch (error) {
                debug.innerHTML = `❌ 获取产品失败\n错误: ${error.message}`;
            }
        }

        // 测试扫码销售
        async function testScanSale() {
            const debug = document.getElementById('debugOutput');
            const variantCode = document.getElementById('testVariantCode').value;
            const quantity = document.getElementById('testQuantity').value;
            
            debug.innerHTML = `测试扫码销售...\n产品: ${variantCode}, 数量: ${quantity}`;
            
            try {
                const scanData = {
                    items: [{
                        variant_id: variantCode,
                        quantity: parseInt(quantity),
                        unit_price: 0
                    }],
                    operator: "测试用户"
                };

                // 使用URL参数方式
                const params = new URLSearchParams();
                params.append('action', 'createScanSale');
                params.append('items', JSON.stringify(scanData.items));
                params.append('operator', scanData.operator);

                debug.innerHTML += `\n\n请求URL: ${API_BASE_URL}?${params.toString()}`;
                
                const response = await fetch(`${API_BASE_URL}?${params.toString()}`);
                const data = await response.json();
                
                debug.innerHTML += `\n\nAPI响应: ${JSON.stringify(data, null, 2)}`;
                
                if (data.success) {
                    debug.innerHTML = `✅ 扫码销售成功！\n销售单号: ${data.results[0].sale_id}\n总金额: ${data.total_amount}`;
                } else {
                    debug.innerHTML = `❌ 扫码销售失败\n错误: ${data.message}`;
                }
            } catch (error) {
                debug.innerHTML = `❌ 扫码销售失败\n错误: ${error.message}`;
            }
        }

        // 测试普通销售
        async function testNormalSale() {
            const debug = document.getElementById('debugOutput');
            const variantCode = document.getElementById('testVariantCode').value;
            const quantity = document.getElementById('testQuantity').value;
            
            debug.innerHTML = `测试普通销售...\n产品: ${variantCode}, 数量: ${quantity}`;
            
            try {
                // 先获取客户列表
                const customerResponse = await fetch(`${API_BASE_URL}?action=getCustomers`);
                const customerData = await customerResponse.json();
                
                if (!customerData.success || customerData.data.length === 0) {
                    debug.innerHTML = '❌ 没有找到客户数据，无法测试销售';
                    return;
                }

                const customerId = customerData.data[0].customer_id;
                
                const params = new URLSearchParams();
                params.append('action', 'createSale');
                params.append('customer_id', customerId);
                params.append('variant_id', variantCode);
                params.append('quantity', quantity);
                params.append('operator', '测试用户');

                debug.innerHTML += `\n使用客户: ${customerId}\n请求URL: ${API_BASE_URL}?${params.toString()}`;
                
                const response = await fetch(`${API_BASE_URL}?${params.toString()}`);
                const data = await response.json();
                
                debug.innerHTML += `\n\nAPI响应: ${JSON.stringify(data, null, 2)}`;
                
                if (data.success) {
                    debug.innerHTML = `✅ 普通销售成功！\n销售单号: ${data.sale_id}\n总金额: ${data.data.total_amount}`;
                } else {
                    debug.innerHTML = `❌ 普通销售失败\n错误: ${data.message}`;
                }
            } catch (error) {
                debug.innerHTML = `❌ 普通销售失败\n错误: ${error.message}`;
            }
        }
    </script>
</body>
</html>
