<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è¿›é”€å­˜ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; color: #333; max-width: 500px; margin: 0 auto; min-height: 100vh; position: relative; }
        .app-container { min-height: 100vh; padding-bottom: 80px; }
        .status-bar { background: #001529; color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .app-title { font-size: 18px; font-weight: 600; }
        .api-status { padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: 500; }
        .api-status.connected { background: #52c41a; color: white; }
        .api-status.disconnected { background: #ff4d4f; color: white; }
        .page-content { padding: 16px; display: none; }
        .page-content.active { display: block; }
        .page-title { font-size: 20px; font-weight: 600; margin-bottom: 20px; text-align: center; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: #333; }
        .form-select, .form-input { width: 100%; padding: 12px; border: 1px solid #e8e8e8; border-radius: 8px; font-size: 16px; background: white; }
        .info-row { display: flex; gap: 16px; margin-bottom: 16px; }
        .info-item { flex: 1; }
        .info-value { background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center; font-weight: 500; min-height: 44px; display: flex; align-items: center; justify-content: center; }
        .submit-button { background: #1890ff; color: white; border: none; border-radius: 8px; padding: 15px; width: 100%; font-size: 16px; cursor: pointer; margin-top: 20px; }
        .function-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 20px; }
        .function-item { background: white; border-radius: 12px; padding: 20px 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; border: none; cursor: pointer; }
        .function-item:active { transform: scale(0.95); background: #f0f7ff; }
        .function-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #1890ff, #096dd9); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-size: 20px; color: white; }
        .scan-section { background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; text-align: center; }
        .scan-button { background: linear-gradient(135deg, #1890ff, #096dd9); color: white; border: none; border-radius: 25px; padding: 15px 30px; font-size: 16px; cursor: pointer; margin: 10px 0; }
        .product-list { background: white; border-radius: 12px; padding: 16px; margin-bottom: 80px; }
        .product-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .product-price { width: 80px; padding: 8px; border: 1px solid #e8e8e8; border-radius: 4px; text-align: center; font-size: 14px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e8e8e8; display: flex; justify-content: space-around; padding: 8px 0; max-width: 500px; margin: 0 auto; }
        .nav-item { display: flex; flex-direction: column; align-items: center; padding: 8px 12px; border: none; background: none; cursor: pointer; flex: 1; }
        .nav-icon { font-size: 20px; margin-bottom: 4px; color: #666; }
        .nav-text { font-size: 11px; color: #666; }
        .nav-item.active .nav-icon, .nav-item.active .nav-text { color: #1890ff; }
        .message { padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center; }
        .message.success { background: #f6ffed; border: 1px solid #b7eb8f; color: #52c41a; }
        .message.error { background: #fff2f0; border: 1px solid #ffccc7; color: #ff4d4f; }
        .debug-info { background: #f0f0f0; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="status-bar">
            <div class="app-title">æ™ºèƒ½è¿›é”€å­˜</div>
            <div id="api-status" class="api-status">æ£€æµ‹ä¸­...</div>
        </div>
        
        <div id="home-page" class="page-content active">
            <div class="debug-info">
                <strong>è¿æ¥çŠ¶æ€ï¼š</strong><span id="debug-status">æ£€æµ‹ä¸­...</span>
            </div>
            
            <div class="function-grid">
                <button class="function-item" onclick="showPage('sale')">
                    <div class="function-icon">ğŸ›’</div>
                    <div class="function-name">é”€å”®å‡ºåº“</div>
                </button>
                <button class="function-item" onclick="showPage('scan')">
                    <div class="function-icon">ğŸ“·</div>
                    <div class="function-name">æ‰«ç å‡ºåº“</div>
                </button>
                <button class="function-item" onclick="showPage('sales-records')">
                    <div class="function-icon">ğŸ“‹</div>
                    <div class="function-name">é”€å”®æ˜ç»†</div>
                </button>
            </div>
        </div>

        <div id="sale-page" class="page-content">
            <div class="page-title">é”€å”®å‡ºåº“</div>
            <div id="sale-message" class="message"></div>
            
            <div class="form-group">
                <label class="form-label">é€‰æ‹©å®¢æˆ·</label>
                <select class="form-select" id="customer-select">
                    <option value="">åŠ è½½ä¸­...</option>
                </select>
            </div>
            
            <div class="info-row">
                <div class="info-item">
                    <label class="form-label">é€‰æ‹©äº§å“å‹å·</label>
                    <select class="form-select" id="model-select" disabled>
                        <option value="">è¯·å…ˆé€‰æ‹©å®¢æˆ·</option>
                    </select>
                </div>
                <div class="info-item">
                    <label class="form-label">é€‰æ‹©é¢œè‰²è§„æ ¼</label>
                    <select class="form-select" id="variant-select" disabled>
                        <option value="">è¯·å…ˆé€‰æ‹©å‹å·</option>
                    </select>
                </div>
            </div>
            
            <div class="info-row">
                <div class="info-item">
                    <label class="form-label">å•ä»· (å…ƒ)</label>
                    <div class="info-value" id="price-display">--</div>
                </div>
                <div class="info-item">
                    <label class="form-label">å½“å‰åº“å­˜</label>
                    <div class="info-value" id="stock-display">--</div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">é”€å”®æ•°é‡</label>
                <input type="number" class="form-input" id="quantity-input" value="1" min="1">
            </div>
            
            <button class="submit-button" onclick="createSale()">ç¡®è®¤å‡ºåº“</button>
        </div>

        <div id="scan-page" class="page-content">
            <div class="page-title">æ‰«ç å‡ºåº“</div>
            <div id="scan-message" class="message"></div>
            
            <div class="scan-section">
                <div style="color: #666; margin-bottom: 10px;">é»˜è®¤å®¢æˆ·ï¼šç½‘åº—å®¢æˆ·</div>
                <button class="scan-button" onclick="startScan()">ğŸ“· å¼€å§‹æ‰«ç </button>
            </div>
            
            <div class="product-list" id="scan-product-list">
                <div style="text-align: center; color: #999; padding: 20px;">æš‚æ— å•†å“</div>
            </div>
            
            <div style="position: fixed; bottom: 80px; left: 0; right: 0; background: white; padding: 16px; border-top: 1px solid #e8e8e8;">
                <button class="submit-button" onclick="submitScanOrder()">ç¡®è®¤å‡ºåº“</button>
            </div>
        </div>

        <div id="sales-records" class="page-content">
            <div class="page-title">é”€å”®æ˜ç»†</div>
            <div id="sales-table" style="text-align: center; color: #999; padding: 20px;">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <div class="bottom-nav">
        <button class="nav-item active" onclick="showPage('home')">
            <div class="nav-icon">ğŸ“</div>
            <div class="nav-text">é¦–é¡µ</div>
        </button>
        <button class="nav-item" onclick="showPage('scan')">
            <div class="nav-icon">ğŸ“·</div>
            <div class="nav-text">æ‰«ç </div>
        </button>
        <button class="nav-item" onclick="showPage('sale')">
            <div class="nav-icon">ğŸ›’</div>
            <div class="nav-text">é”€å”®</div>
        </button>
    </div>

    <script>
        // ä¿®å¤çš„APIè°ƒç”¨å‡½æ•°
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbyV9ibpP3OZikXvExxr6IM7r71y7tQ3HQbsJLDebSL3UPlIjwsOi-xMR6nmB7m9y8_bhg/exec';
        
        let customers = [];
        let products = [];
        let scanProducts = [];

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, message, type = 'error') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `message ${type}`;
            setTimeout(() => element.textContent = '', 3000);
        }

        // æµ‹è¯•APIè¿æ¥ - ä¿®å¤ç‰ˆæœ¬
        async function testAPIConnection() {
            try {
                // ä½¿ç”¨æ›´ç®€å•çš„fetchæ–¹å¼
                const response = await fetch(`${API_BASE_URL}?action=test`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data.success) {
                    document.getElementById('api-status').className = 'api-status connected';
                    document.getElementById('api-status').textContent = 'å·²è¿æ¥';
                    document.getElementById('debug-status').textContent = 'è¿æ¥æˆåŠŸ';
                    return true;
                }
            } catch (error) {
                console.error('APIè¿æ¥å¤±è´¥:', error);
            }
            
            document.getElementById('api-status').className = 'api-status disconnected';
            document.getElementById('api-status').textContent = 'æœªè¿æ¥';
            document.getElementById('debug-status').textContent = 'è¿æ¥å¤±è´¥: ' + error.message;
            return false;
        }

        // é¡µé¢åˆ‡æ¢
        function showPage(page) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            
            document.getElementById(page + '-page').classList.add('active');
            event.currentTarget.classList.add('active');
            
            if (page === 'sale') initSalePage();
            if (page === 'scan') initScanPage();
            if (page === 'sales-records') loadSalesRecords();
        }

        // åˆå§‹åŒ–é”€å”®é¡µé¢
        async function initSalePage() {
            await loadCustomers();
            setupSaleEvents();
        }

        // åˆå§‹åŒ–æ‰«ç é¡µé¢
        function initScanPage() {
            scanProducts = [];
            updateScanProductList();
        }

        // åŠ è½½å®¢æˆ·æ•°æ® - ä¿®å¤ç‰ˆæœ¬
        async function loadCustomers() {
            try {
                const response = await fetch(`${API_BASE_URL}?action=getCustomers`);
                const data = await response.json();
                
                if (data.success) {
                    customers = data.data;
                    const select = document.getElementById('customer-select');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©å®¢æˆ·</option>' +
                        data.data.map(c => `<option value="${c.customer_id}">${c.name}</option>`).join('');
                }
            } catch (error) {
                showMessage('sale-message', 'åŠ è½½å®¢æˆ·å¤±è´¥', 'error');
            }
        }

        // è®¾ç½®é”€å”®äº‹ä»¶
        function setupSaleEvents() {
            document.getElementById('customer-select').addEventListener('change', async function() {
                const modelSelect = document.getElementById('model-select');
                if (this.value) {
                    await loadProducts();
                    modelSelect.disabled = false;
                    modelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©äº§å“å‹å·</option>' +
                        products.map(p => `<option value="${p.model_id}">${p.model_name}</option>`).join('');
                } else {
                    modelSelect.disabled = true;
                    modelSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å®¢æˆ·</option>';
                    document.getElementById('variant-select').disabled = true;
                    document.getElementById('variant-select').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å‹å·</option>';
                    resetProductInfo();
                }
            });

            document.getElementById('model-select').addEventListener('change', async function() {
                const variantSelect = document.getElementById('variant-select');
                if (this.value) {
                    try {
                        const response = await fetch(`${API_BASE_URL}?action=getProductVariants&model_id=${this.value}`);
                        const data = await response.json();
                        
                        if (data.success) {
                            variantSelect.disabled = false;
                            variantSelect.innerHTML = '<option value="">è¯·é€‰æ‹©é¢œè‰²è§„æ ¼</option>' +
                                data.data.map(v => `<option value="${v.variant_id}">${v.color} (åº“å­˜:${v.stock})</option>`).join('');
                        }
                    } catch (error) {
                        variantSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                    }
                } else {
                    variantSelect.disabled = true;
                    variantSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å‹å·</option>';
                    resetProductInfo();
                }
            });

            document.getElementById('variant-select').addEventListener('change', async function() {
                if (this.value) {
                    try {
                        const response = await fetch(`${API_BASE_URL}?action=getVariantDetail&variant_id=${this.value}`);
                        const data = await response.json();
                        
                        if (data.success) {
                            document.getElementById('price-display').textContent = data.data.price;
                            document.getElementById('stock-display').textContent = data.data.stock;
                        }
                    } catch (error) {
                        console.error('è·å–äº§å“è¯¦æƒ…å¤±è´¥:', error);
                    }
                } else {
                    resetProductInfo();
                }
            });
        }

        // åŠ è½½äº§å“æ•°æ®
        async function loadProducts() {
            try {
                const response = await fetch(`${API_BASE_URL}?action=getProducts`);
                const data = await response.json();
                if (data.success) products = data.data;
            } catch (error) {
                console.error('åŠ è½½äº§å“å¤±è´¥:', error);
            }
        }

        // é‡ç½®äº§å“ä¿¡æ¯
        function resetProductInfo() {
            document.getElementById('price-display').textContent = '--';
            document.getElementById('stock-display').textContent = '--';
        }

        // åˆ›å»ºé”€å”®è®°å½• - ä¿®å¤ç‰ˆæœ¬
        async function createSale() {
            const customerId = document.getElementById('customer-select').value;
            const variantId = document.getElementById('variant-select').value;
            const quantity = document.getElementById('quantity-input').value;

            if (!customerId || !variantId || !quantity) {
                showMessage('sale-message', 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                return;
            }

            try {
                // ä½¿ç”¨URLå‚æ•°æ–¹å¼å‘é€POSTè¯·æ±‚ï¼ˆGoogle Apps Scriptå…¼å®¹ï¼‰
                const formData = new FormData();
                formData.append('action', 'createSale');
                formData.append('customer_id', customerId);
                formData.append('variant_id', variantId);
                formData.append('quantity', quantity);
                formData.append('operator', 'ç³»ç»Ÿ');

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('sale-message', `é”€å”®æˆåŠŸï¼å•å·: ${data.data.sale_id}`, 'success');
                    // é‡ç½®è¡¨å•
                    resetForm();
                } else {
                    showMessage('sale-message', 'é”€å”®å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                showMessage('sale-message', 'ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('customer-select').value = '';
            document.getElementById('model-select').disabled = true;
            document.getElementById('model-select').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å®¢æˆ·</option>';
            document.getElementById('variant-select').disabled = true;
            document.getElementById('variant-select').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å‹å·</option>';
            document.getElementById('quantity-input').value = '1';
            resetProductInfo();
        }

        // æ‰«ç åŠŸèƒ½
        function startScan() {
            const variantId = prompt('è¯·è¾“å…¥äº§å“å˜ä½“ID (ä¾‹å¦‚: V001):');
            if (variantId) addScannedProduct(variantId);
        }

        async function addScannedProduct(variantId) {
            try {
                const response = await fetch(`${API_BASE_URL}?action=getVariantDetail&variant_id=${variantId}`);
                const data = await response.json();
                
                if (data.success) {
                    scanProducts.push({
                        variant_id: variantId,
                        name: `${data.data.model_name}-${data.data.color}`,
                        price: 0,
                        quantity: 1
                    });
                    updateScanProductList();
                } else {
                    alert('äº§å“ä¸å­˜åœ¨');
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        function updateScanProductList() {
            const list = document.getElementById('scan-product-list');
            list.innerHTML = scanProducts.map((product, index) => `
                <div class="product-item">
                    <div>${product.name}</div>
                    <input type="number" class="product-price" value="${product.price}" 
                           onchange="scanProducts[${index}].price = parseFloat(this.value) || 0" placeholder="ä»·æ ¼">
                </div>
            `).join('');
        }

        async function submitScanOrder() {
            if (scanProducts.length === 0) {
                showMessage('scan-message', 'è¯·å…ˆæ·»åŠ å•†å“', 'error');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('action', 'createScanSale');
                formData.append('items', JSON.stringify(scanProducts));
                formData.append('operator', 'ç³»ç»Ÿ');

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('scan-message', `æ‰«ç é”€å”®æˆåŠŸï¼`, 'success');
                    scanProducts = [];
                    updateScanProductList();
                } else {
                    showMessage('scan-message', 'æ‰«ç é”€å”®å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                showMessage('scan-message', 'ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // åŠ è½½é”€å”®è®°å½•
        async function loadSalesRecords() {
            try {
                const response = await fetch(`${API_BASE_URL}?action=getSalesRecords`);
                const data = await response.json();
                
                if (data.success) {
                    const table = document.getElementById('sales-table');
                    table.innerHTML = data.data.slice(0, 5).map(record => `
                        <div style="padding: 16px; background: white; border-radius: 8px; margin-bottom: 8px;">
                            <div style="font-weight: 500;">${record.sale_id}</div>
                            <div style="font-size: 14px; color: #666;">${record.date} | æ•°é‡: ${record.quantity}</div>
                            <div style="font-weight: 500; color: #ff4d4f;">Â¥${record.total_amount}</div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                document.getElementById('sales-table').textContent = 'åŠ è½½å¤±è´¥';
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            await testAPIConnection();
        });
    </script>
</body>
</html>
