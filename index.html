<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœ¼é•œé”€å”®ç®¡ç†ç³»ç»Ÿ - å®Œæ•´ç‰ˆ</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f7; color: #1d1d1f; line-height: 1.6; padding: 0; }
        
        /* App å¸ƒå±€ */
        #app { max-width: 100%; min-height: 100vh; display: flex; flex-direction: column; }
        
        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        .header { background: white; padding: 15px 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 1.3rem; color: #333; }
        
        /* å†…å®¹åŒºåŸŸ */
        .content { flex: 1; padding: 20px; padding-bottom: 80px; }
        
        /* å¡ç‰‡æ ·å¼ */
        .card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        /* è¡¨å•æ ·å¼ */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input, select, button, textarea { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; }
        button { background: #007aff; color: white; border: none; font-weight: 600; cursor: pointer; }
        button:active { background: #0056cc; }
        button.secondary { background: #8e8e93; }
        button.success { background: #34c759; }
        button.danger { background: #ff3b30; }
        
        /* åº•éƒ¨å¯¼èˆª */
        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .tab-item { flex: 1; text-align: center; padding: 10px; color: #8e8e93; cursor: pointer; }
        .tab-item.active { color: #007aff; }
        
        /* é¡µé¢åˆ‡æ¢ */
        .page { display: none; }
        .page.active { display: block; }
        
        /* äº§å“å‹å·åˆ†ç»„ */
        .model-group { margin-bottom: 20px; border: 1px solid #e0e0e0; border-radius: 10px; overflow: hidden; }
        .model-header { background: #f8f9fa; padding: 15px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .model-variants { background: white; }
        .variant-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .variant-item:last-child { border-bottom: none; }
        .variant-info { flex: 1; }
        .variant-actions { display: flex; gap: 8px; }
        .variant-actions button { padding: 6px 12px; font-size: 0.8rem; width: auto; }
        
        /* é¢œè‰²è§„æ ¼æ·»åŠ æ ·å¼ */
        .color-variant-item {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px dashed #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .color-variant-item label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }
        .remove-color {
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            width: auto;
            padding: 10px 15px;
        }
        
        /* åº“å­˜æ“ä½œè¡¨æ ¼ */
        .inventory-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .inventory-table th, .inventory-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .inventory-table th { background: #f8f8f8; }
        .inventory-input { width: 70px; padding: 5px; text-align: center; }
        
        /* éšè—ç±» */
        .hidden { display: none; }
        
        /* çŠ¶æ€æ ‡ç­¾ */
        .stock-badge { background: #34c759; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; }
        .price-badge { background: #007aff; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; }
        
        /* æ¶ˆæ¯æç¤º */
        .message { padding: 12px; border-radius: 8px; margin: 10px 0; text-align: center; font-size: 14px; }
        .success { background: #D4EDDA; color: #155724; border: 1px solid #C3E6CB; }
        .error { background: #F8D7DA; color: #721C24; border: 1px solid #F5C6CB; }
        .info { background: #CCE7FF; color: #004085; border: 1px solid #B3D9FF; }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading { text-align: center; padding: 20px; color: #666; }
        .loading-spinner { 
            width: 20px; 
            height: 20px; 
            border: 2px solid #f3f3f3; 
            border-top: 2px solid #007aff; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
        <div class="header">
            <h1 id="pageTitle">é”€å”®å¼€å•</h1>
        </div>
        
        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="content">
            <!-- é¦–é¡µï¼šé”€å”®å¼€å• -->
            <div id="page-home" class="page active">
                <div class="card">
                    <div class="form-group">
                        <label for="customerSelect">é€‰æ‹©å®¢æˆ·</label>
                        <select id="customerSelect">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modelSelect">é€‰æ‹©äº§å“å‹å·</label>
                        <select id="modelSelect">
                            <option value="">è¯·å…ˆé€‰æ‹©å®¢æˆ·</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="variantSelect">é€‰æ‹©é¢œè‰²è§„æ ¼</label>
                        <select id="variantSelect">
                            <option value="">è¯·å…ˆé€‰æ‹©å‹å·</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="priceDisplay">å•ä»· (å…ƒ)</label>
                        <input type="text" id="priceDisplay" readonly placeholder="é€‰æ‹©é¢œè‰²åè‡ªåŠ¨æ˜¾ç¤º">
                    </div>
                    <div class="form-group">
                        <label for="stockDisplay">å½“å‰åº“å­˜</label>
                        <input type="text" id="stockDisplay" readonly placeholder="é€‰æ‹©é¢œè‰²åè‡ªåŠ¨æ˜¾ç¤º">
                    </div>
                    <div class="form-group">
                        <label for="quantity">é”€å”®æ•°é‡</label>
                        <input type="number" id="quantity" value="1" min="1">
                    </div>
                    <div id="saleMessage"></div>
                    <button id="generateInvoice" class="success">ç”Ÿæˆé”€å”®å•</button>
                </div>
            </div>
            
            <!-- äº§å“ç®¡ç†é¡µ -->
            <div id="page-products" class="page">
                <div class="card">
                    <h3>äº§å“å‹å·ç®¡ç†</h3>
                    <div id="productsList">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>æ·»åŠ æ–°äº§å“/é¢œè‰²</h3>
                    <div class="form-group">
                        <label for="newModelName">äº§å“å‹å·</label>
                        <input type="text" id="newModelName" placeholder="ä¾‹å¦‚: GQF-PU9048">
                    </div>
                    
                    <!-- é¢œè‰²è§„æ ¼åˆ—è¡¨ -->
                    <div id="colorVariants">
                        <div class="color-variant-item">
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; align-items: end;">
                                <div>
                                    <label>é¢œè‰²åç§°</label>
                                    <input type="text" placeholder="ä¾‹å¦‚: ç™½æ°´é“¶" style="margin-top: 5px;">
                                </div>
                                <div>
                                    <label>ä»·æ ¼(å…ƒ)</label>
                                    <input type="number" value="0" style="margin-top: 5px;">
                                </div>
                                <div>
                                    <label>åº“å­˜</label>
                                    <input type="number" value="0" style="margin-top: 5px;">
                                </div>
                                <div>
                                    <label>&nbsp;</label>
                                    <button class="danger remove-color" style="width: auto; padding: 10px; margin-top: 5px;">åˆ é™¤</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button id="addColorBtn" class="secondary" style="margin-bottom: 15px;">â• æ–°å¢é¢œè‰²è§„æ ¼</button>
                    <div id="productMessage"></div>
                    <button class="success" id="saveProductBtn">ä¿å­˜äº§å“</button>
                </div>
            </div>
            
            <!-- å®¢æˆ·ç®¡ç†é¡µ -->
            <div id="page-customers" class="page">
                <div class="card">
                    <h3>å®¢æˆ·åˆ—è¡¨</h3>
                    <div id="customersList">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>æ·»åŠ æ–°å®¢æˆ·</h3>
                    <div class="form-group">
                        <input type="text" id="newCustomerName" placeholder="å®¢æˆ·åç§°">
                    </div>
                    <div id="customerMessage"></div>
                    <button class="success" id="saveCustomerBtn">ä¿å­˜å®¢æˆ·</button>
                </div>
            </div>
            
            <!-- åº“å­˜ç®¡ç†é¡µ -->
            <div id="page-inventory" class="page">
                <div class="card">
                    <h3>åº“å­˜æ“ä½œ</h3>
                    <button class="success" onclick="showPage('scan-demo')">ğŸ“· æ‰«ç æ“ä½œ</button>
                    <button class="secondary" style="margin-top: 10px;">ğŸ“Š åº“å­˜æŠ¥è¡¨</button>
                </div>
                
                <div class="card">
                    <h3>åº“å­˜æ¦‚è§ˆ</h3>
                    <div id="inventoryOverview">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ‰«ç æ¼”ç¤ºé¡µ -->
            <div id="page-scan-demo" class="page">
                <div class="card">
                    <h3>ğŸ“· æ‰«ç æ“ä½œæ¨¡æ‹Ÿ</h3>
                    <p>å‡è®¾æ‚¨æ‰«æäº† <strong>GQF-PU9048 é‡‘å±çŒ«çœ¼</strong> çš„äºŒç»´ç </p>
                    
                    <div style="background: #f0f8ff; padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <h4>GQF-PU9048 é‡‘å±çŒ«çœ¼ - åº“å­˜è°ƒæ•´</h4>
                        <p>è¯·å¡«å†™å„é¢œè‰²çš„å˜æ›´æ•°é‡ï¼ˆæ­£æ•°è¡¨ç¤ºå…¥åº“ï¼Œè´Ÿæ•°è¡¨ç¤ºå‡ºåº“ï¼‰ï¼š</p>
                    </div>
                    
                    <table class="inventory-table">
                        <thead>
                            <tr>
                                <th>é¢œè‰²</th>
                                <th>å½“å‰åº“å­˜</th>
                                <th>å˜æ›´æ•°é‡</th>
                                <th>å¤‡æ³¨</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ç™½æ°´é“¶</td>
                                <td>5</td>
                                <td><input type="number" value="0" class="inventory-input"></td>
                                <td><input type="text" placeholder="å¦‚: é‡‡è´­å…¥åº“" style="padding: 5px; width: 100%;"></td>
                            </tr>
                            <tr>
                                <td>ç´«æ°´é“¶</td>
                                <td>16</td>
                                <td><input type="number" value="0" class="inventory-input"></td>
                                <td><input type="text" placeholder="å¦‚: é”€å”®å‡ºåº“" style="padding: 5px; width: 100%;"></td>
                            </tr>
                            <tr>
                                <td>ç°ç‰‡</td>
                                <td>9</td>
                                <td><input type="number" value="0" class="inventory-input"></td>
                                <td><input type="text" placeholder="å¦‚: ç›˜ç›ˆå…¥åº“" style="padding: 5px; width: 100%;"></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <button class="success" style="margin-top: 15px;">âœ… æäº¤åº“å­˜å˜æ›´</button>
                    <button class="secondary" onclick="showPage('inventory')" style="margin-top: 10px;">â† è¿”å›åº“å­˜ç®¡ç†</button>
                </div>
            </div>
            
            <!-- é”€å”®è®°å½•é¡µ -->
            <div id="page-records" class="page">
                <div class="card">
                    <h3>é”€å”®è®°å½•</h3>
                    <div id="salesRecords">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>æœˆåº¦æ±‡æ€»</h3>
                    <p>æœ¬æœˆæ€»é”€å”®é¢: <strong id="monthlyTotal">0 å…ƒ</strong></p>
                    <p>é”€å”®å•æ•°: <strong id="salesCount">0 ç¬”</strong></p>
                    <button class="secondary">ğŸ“ˆ æŸ¥çœ‹è¯¦ç»†æŠ¥è¡¨</button>
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨å¯¼èˆªæ  -->
        <div class="tab-bar">
            <div class="tab-item active" onclick="showPage('home')">
                <div>ğŸ§¾</div>
                <span>å¼€å•</span>
            </div>
            <div class="tab-item" onclick="showPage('products')">
                <div>ğŸ“¦</div>
                <span>äº§å“</span>
            </div>
            <div class="tab-item" onclick="showPage('customers')">
                <div>ğŸ‘¥</div>
                <span>å®¢æˆ·</span>
            </div>
            <div class="tab-item" onclick="showPage('inventory')">
                <div>ğŸª</div>
                <span>åº“å­˜</span>
            </div>
            <div class="tab-item" onclick="showPage('records')">
                <div>ğŸ“‹</div>
                <span>è®°å½•</span>
            </div>
        </div>
    </div>

    <script>
        // APIé…ç½® - ä½¿ç”¨æ‚¨çš„æ–°URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbxvjX942NdFcecDkUStQpBkdihFEwrATH1yrVaSI97rKC5HPUDDSIltaYhjZT1AY6dZ-g/exec';
        
        // å…¨å±€çŠ¶æ€
        let state = {
            customers: [],
            products: [],
            selectedCustomer: null,
            selectedProduct: null,
            selectedVariant: null
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupEventListeners();
            loadInitialData();
        }

        // é¡µé¢åˆ‡æ¢å‡½æ•°
        function showPage(pageName) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            document.getElementById(`page-${pageName}`).classList.add('active');
            
            // æ›´æ–°æ ‡é¢˜
            const titles = {
                'home': 'é”€å”®å¼€å•',
                'products': 'äº§å“ç®¡ç†',
                'customers': 'å®¢æˆ·ç®¡ç†',
                'records': 'é”€å”®è®°å½•',
                'inventory': 'åº“å­˜ç®¡ç†',
                'scan-demo': 'æ‰«ç æ“ä½œ'
            };
            document.getElementById('pageTitle').textContent = titles[pageName];
            
            // æ›´æ–°åº•éƒ¨å¯¼èˆªæ¿€æ´»çŠ¶æ€
            if (pageName !== 'scan-demo') {
                document.querySelectorAll('.tab-item').forEach(tab => {
                    tab.classList.remove('active');
                });
                // æ‰¾åˆ°å¯¹åº”çš„å¯¼èˆªé¡¹å¹¶æ¿€æ´»
                const tabIndex = ['home', 'products', 'customers', 'inventory', 'records'].indexOf(pageName);
                if (tabIndex !== -1) {
                    document.querySelectorAll('.tab-item')[tabIndex].classList.add('active');
                }
            }
            
            // åŠ è½½é¡µé¢æ•°æ®
            if (pageName === 'products') {
                loadProductsForManagement();
            } else if (pageName === 'customers') {
                loadCustomersForManagement();
            } else if (pageName === 'records') {
                loadSalesRecords();
            } else if (pageName === 'inventory') {
                loadInventoryOverview();
            }
        }

        function setupEventListeners() {
            // é”€å”®å¼€å•é¡µé¢äº‹ä»¶
            document.getElementById('customerSelect').addEventListener('change', handleCustomerChange);
            document.getElementById('modelSelect').addEventListener('change', handleModelChange);
            document.getElementById('variantSelect').addEventListener('change', handleVariantChange);
            document.getElementById('quantity').addEventListener('input', updateSubmitButton);
            document.getElementById('generateInvoice').addEventListener('click', createSale);
            
            // äº§å“ç®¡ç†é¡µé¢äº‹ä»¶
            document.getElementById('addColorBtn').addEventListener('click', addColorVariant);
            document.getElementById('saveProductBtn').addEventListener('click', saveProduct);
            
            // å®¢æˆ·ç®¡ç†é¡µé¢äº‹ä»¶
            document.getElementById('saveCustomerBtn').addEventListener('click', saveCustomer);
            
            // åˆå§‹åˆ é™¤æŒ‰é’®äº‹ä»¶
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-color')) {
                    if (document.querySelectorAll('.color-variant-item').length > 1) {
                        e.target.closest('.color-variant-item').remove();
                    } else {
                        showMessage('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªé¢œè‰²è§„æ ¼', 'error', 'productMessage');
                    }
                }
            });
        }

        async function loadInitialData() {
            try {
                showMessage('æ­£åœ¨è¿æ¥æ•°æ®åº“...', 'info', 'saleMessage');
                await loadCustomers();
                await loadProducts();
                hideMessage('saleMessage');
            } catch (error) {
                showMessage('åˆå§‹åŒ–æ•°æ®å¤±è´¥: ' + error.message, 'error', 'saleMessage');
            }
        }

        // APIè°ƒç”¨å‡½æ•°
        async function apiCall(params = {}) {
            try {
                const url = new URL(API_URL);
                Object.keys(params).forEach(key => {
                    if (params[key] !== undefined && params[key] !== null && params[key] !== '') {
                        url.searchParams.append(key, params[key]);
                    }
                });
                
                console.log('APIè¯·æ±‚:', url.toString());
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
                
            } catch (error) {
                console.error('APIè°ƒç”¨é”™è¯¯:', error);
                throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        async function loadCustomers() {
            try {
                const data = await apiCall({ action: 'getCustomers' });
                if (data.success) {
                    state.customers = data.data;
                    updateCustomerSelect();
                } else {
                    throw new Error(data.error || 'åŠ è½½å®¢æˆ·æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                throw new Error('åŠ è½½å®¢æˆ·åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        async function loadProducts(customerId = '') {
            try {
                const params = { action: 'getProducts' };
                if (customerId) params.customerId = customerId;
                
                const data = await apiCall(params);
                if (data.success) {
                    state.products = data.data;
                    if (!customerId) {
                        updateModelSelect();
                    }
                } else {
                    throw new Error(data.error || 'åŠ è½½äº§å“æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                throw new Error('åŠ è½½äº§å“åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        function updateCustomerSelect() {
            const select = document.getElementById('customerSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©å®¢æˆ·</option>';
            
            state.customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.customer_id;
                option.textContent = customer.name;
                select.appendChild(option);
            });
        }

        function updateModelSelect() {
            const select = document.getElementById('modelSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©äº§å“å‹å·</option>';
            
            // å»é‡äº§å“å‹å·
            const uniqueModels = [...new Set(state.products.map(p => p.model_id))];
            uniqueModels.forEach(modelId => {
                const product = state.products.find(p => p.model_id === modelId);
                const option = document.createElement('option');
                option.value = modelId;
                option.textContent = `${modelId} ${product.model_name}`;
                select.appendChild(option);
            });
        }

        function handleCustomerChange(event) {
            state.selectedCustomer = event.target.value;
            if (state.selectedCustomer) {
                showMessage('æ­£åœ¨åŠ è½½äº§å“ä¿¡æ¯...', 'info', 'saleMessage');
                loadProducts(state.selectedCustomer).then(() => {
                    updateModelSelect();
                    hideMessage('saleMessage');
                }).catch(error => {
                    showMessage(error.message, 'error', 'saleMessage');
                });
            } else {
                resetProductSelection();
            }
        }

        function handleModelChange(event) {
            state.selectedProduct = event.target.value;
            updateVariants();
        }

        function updateVariants() {
            const variants = state.products.filter(p => p.model_id === state.selectedProduct);
            const select = document.getElementById('variantSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©é¢œè‰²è§„æ ¼</option>';
            
            variants.forEach(variant => {
                const option = document.createElement('option');
                option.value = variant.variant_id;
                
                // ä»·æ ¼æ˜¾ç¤º
                let priceText = `${variant.price}å…ƒ`;
                if (variant.price !== variant.standard_price) {
                    priceText = `${variant.price}å…ƒ (ç‰¹ä»·)`;
                }
                
                option.textContent = `${variant.color} - ${priceText}`;
                option.dataset.price = variant.price;
                option.dataset.stock = variant.stock;
                select.appendChild(option);
            });
            
            resetProductInfo();
        }

        function handleVariantChange(event) {
            const selectedOption = event.target.options[event.target.selectedIndex];
            if (selectedOption.value) {
                state.selectedVariant = selectedOption.value;
                document.getElementById('priceDisplay').value = selectedOption.dataset.price + ' å…ƒ';
                document.getElementById('stockDisplay').value = selectedOption.dataset.stock + ' ä¸ª';
            } else {
                resetProductInfo();
            }
            updateSubmitButton();
        }

        function resetProductSelection() {
            document.getElementById('modelSelect').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å®¢æˆ·</option>';
            resetVariants();
        }

        function resetVariants() {
            document.getElementById('variantSelect').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å‹å·</option>';
            resetProductInfo();
        }

        function resetProductInfo() {
            document.getElementById('priceDisplay').value = '';
            document.getElementById('stockDisplay').value = '';
            document.getElementById('quantity').value = 1;
            updateSubmitButton();
        }

        function updateSubmitButton() {
            const quantity = parseInt(document.getElementById('quantity').value);
            const btn = document.getElementById('generateInvoice');
            
            let hasStock = false;
            if (state.selectedVariant) {
                const selectedOption = document.getElementById('variantSelect').options[document.getElementById('variantSelect').selectedIndex];
                const stock = parseInt(selectedOption.dataset.stock);
                hasStock = quantity > 0 && quantity <= stock;
            }
            
            btn.disabled = !(state.selectedCustomer && state.selectedVariant && hasStock);
        }

        async function createSale() {
            const quantity = parseInt(document.getElementById('quantity').value);
            const customerSelect = document.getElementById('customerSelect');
            const variantSelect = document.getElementById('variantSelect');
            const customerName = customerSelect.options[customerSelect.selectedIndex].textContent;
            const variantOption = variantSelect.options[variantSelect.selectedIndex];
            
            const saleData = {
                action: 'createSale',
                data: {
                    customer_id: state.selectedCustomer,
                    customer_name: customerName,
                    variant_id: state.selectedVariant,
                    quantity: quantity,
                    unit_price: parseFloat(variantOption.dataset.price)
                }
            };
            
            try {
                const btn = document.getElementById('generateInvoice');
                btn.disabled = true;
                btn.textContent = 'å¼€å•ä¸­...';
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(saleData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`å¼€å•æˆåŠŸï¼é”€å”®å•å·: ${result.sale_id}`, 'success', 'saleMessage');
                    // é‡æ–°åŠ è½½äº§å“ä¿¡æ¯æ›´æ–°åº“å­˜æ˜¾ç¤º
                    await loadProducts(state.selectedCustomer);
                    updateModelSelect();
                    // é‡ç½®è¡¨å•
                    document.getElementById('quantity').value = 1;
                    updateSubmitButton();
                } else {
                    throw new Error(result.error || 'å¼€å•å¤±è´¥');
                }
            } catch (error) {
                showMessage('å¼€å•å¤±è´¥: ' + error.message, 'error', 'saleMessage');
            } finally {
                const btn = document.getElementById('generateInvoice');
                btn.disabled = false;
                btn.textContent = 'ç”Ÿæˆé”€å”®å•';
                updateSubmitButton();
            }
        }

        // äº§å“ç®¡ç†åŠŸèƒ½
        function addColorVariant() {
            const colorVariants = document.getElementById('colorVariants');
            const newVariant = document.createElement('div');
            newVariant.className = 'color-variant-item';
            newVariant.innerHTML = `
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; align-items: end;">
                    <div>
                        <label>é¢œè‰²åç§°</label>
                        <input type="text" placeholder="ä¾‹å¦‚: ç™½æ°´é“¶" style="margin-top: 5px;">
                    </div>
                    <div>
                        <label>ä»·æ ¼(å…ƒ)</label>
                        <input type="number" value="0" style="margin-top: 5px;">
                    </div>
                    <div>
                        <label>åº“å­˜</label>
                        <input type="number" value="0" style="margin-top: 5px;">
                    </div>
                    <div>
                        <label>&nbsp;</label>
                        <button class="danger remove-color" style="width: auto; padding: 10px; margin-top: 5px;">åˆ é™¤</button>
                    </div>
                </div>
            `;
            colorVariants.appendChild(newVariant);
        }

        async function saveProduct() {
            const modelName = document.getElementById('newModelName').value.trim();
            if (!modelName) {
                showMessage('è¯·è¾“å…¥äº§å“å‹å·åç§°', 'error', 'productMessage');
                return;
            }
            
            const colorVariants = document.querySelectorAll('.color-variant-item');
            const variants = [];
            
            for (let item of colorVariants) {
                const colorInput = item.querySelector('input[type="text"]');
                const priceInput = item.querySelector('input[type="number"]:nth-of-type(1)');
                const stockInput = item.querySelector('input[type="number"]:nth-of-type(2)');
                
                const color = colorInput.value.trim();
                const price = parseFloat(priceInput.value) || 0;
                const stock = parseInt(stockInput.value) || 0;
                
                if (!color) {
                    showMessage('è¯·å¡«å†™æ‰€æœ‰é¢œè‰²åç§°', 'error', 'productMessage');
                    return;
                }
                
                variants.push({ color, price, stock });
            }
            
            const productData = {
                action: 'addProduct',
                data: {
                    modelName: modelName,
                    variants: variants
                }
            };
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(productData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`äº§å“æ·»åŠ æˆåŠŸï¼å‹å·ID: ${result.model_id}`, 'success', 'productMessage');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('newModelName').value = '';
                    document.querySelectorAll('.color-variant-item').forEach(item => {
                        if (item !== document.querySelector('.color-variant-item')) {
                            item.remove();
                        }
                    });
                    // é‡ç½®ç¬¬ä¸€ä¸ªé¢œè‰²è§„æ ¼
                    const firstItem = document.querySelector('.color-variant-item');
                    firstItem.querySelector('input[type="text"]').value = '';
                    firstItem.querySelector('input[type="number"]:nth-of-type(1)').value = '0';
                    firstItem.querySelector('input[type="number"]:nth-of-type(2)').value = '0';
                    
                    // é‡æ–°åŠ è½½äº§å“åˆ—è¡¨
                    loadProductsForManagement();
                } else {
                    throw new Error(result.error || 'äº§å“æ·»åŠ å¤±è´¥');
                }
            } catch (error) {
                showMessage('äº§å“æ·»åŠ å¤±è´¥: ' + error.message, 'error', 'productMessage');
            }
        }

        async function saveCustomer() {
            const customerName = document.getElementById('newCustomerName').value.trim();
            if (!customerName) {
                showMessage('è¯·è¾“å…¥å®¢æˆ·åç§°', 'error', 'customerMessage');
                return;
            }
            
            const customerData = {
                action: 'addCustomer',
                data: {
                    customerName: customerName
                }
            };
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(customerData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`å®¢æˆ·æ·»åŠ æˆåŠŸï¼å®¢æˆ·ID: ${result.customer_id}`, 'success', 'customerMessage');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('newCustomerName').value = '';
                    // é‡æ–°åŠ è½½å®¢æˆ·åˆ—è¡¨
                    loadCustomersForManagement();
                    // æ›´æ–°é”€å”®é¡µé¢çš„å®¢æˆ·ä¸‹æ‹‰æ¡†
                    await loadCustomers();
                } else {
                    throw new Error(result.error || 'å®¢æˆ·æ·»åŠ å¤±è´¥');
                }
            } catch (error) {
                showMessage('å®¢æˆ·æ·»åŠ å¤±è´¥: ' + error.message, 'error', 'customerMessage');
            }
        }

        async function loadProductsForManagement() {
            try {
                document.getElementById('productsList').innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        åŠ è½½äº§å“æ•°æ®...
                    </div>
                `;
                
                const data = await apiCall({ action: 'getAllProducts' });
                
                if (data.success) {
                    let html = '';
                    
                    if (data.data.length === 0) {
                        html = '<p>æš‚æ— äº§å“æ•°æ®</p>';
                    } else {
                        data.data.forEach(model => {
                            html += `
                                <div class="model-group">
                                    <div class="model-header">
                                        <span>${model.model_id} ${model.model_name}</span>
                                        <span>ğŸ“¦</span>
                                    </div>
                                    <div class="model-variants">
                            `;
                            
                            model.variants.forEach(variant => {
                                html += `
                                    <div class="variant-item">
                                        <div class="variant-info">
                                            <strong>${variant.color}</strong>
                                            <div style="font-size: 0.9rem; color: #666;">
                                                ä»·æ ¼: ${variant.price}å…ƒ | åº“å­˜: <span class="stock-badge">${variant.stock}</span>
                                            </div>
                                        </div>
                                        <div class="variant-actions">
                                            <button class="secondary" style="padding: 5px 10px;">ç¼–è¾‘</button>
                                            <button class="danger" style="padding: 5px 10px;">åˆ é™¤</button>
                                        </div>
                                    </div>
                                `;
                            });
                            
                            html += `
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    document.getElementById('productsList').innerHTML = html;
                } else {
                    throw new Error(data.error || 'åŠ è½½äº§å“æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                document.getElementById('productsList').innerHTML = `<p class="error">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }

        async function loadCustomersForManagement() {
            try {
                document.getElementById('customersList').innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        åŠ è½½å®¢æˆ·æ•°æ®...
                    </div>
                `;
                
                const data = await apiCall({ action: 'getCustomers' });
                
                if (data.success) {
                    let html = '';
                    
                    if (data.data.length === 0) {
                        html = '<p>æš‚æ— å®¢æˆ·æ•°æ®</p>';
                    } else {
                        html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                        data.data.forEach(customer => {
                            html += `
                                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${customer.name}</strong>
                                        <div style="font-size: 0.9rem; color: #666;">ID: ${customer.customer_id}</div>
                                    </div>
                                    <button class="danger" style="width: auto; padding: 5px 10px;">åˆ é™¤</button>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    document.getElementById('customersList').innerHTML = html;
                } else {
                    throw new Error(data.error || 'åŠ è½½å®¢æˆ·æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                document.getElementById('customersList').innerHTML = `<p class="error">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }

        async function loadSalesRecords() {
            try {
                document.getElementById('salesRecords').innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        åŠ è½½é”€å”®è®°å½•...
                    </div>
                `;
                
                const data = await apiCall({ action: 'getSalesRecords' });
                
                if (data.success) {
                    let html = '';
                    
                    if (data.data.length === 0) {
                        html = '<p>æš‚æ— é”€å”®è®°å½•</p>';
                    } else {
                        html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                        data.data.forEach(record => {
                            const date = new Date(record.date).toLocaleDateString();
                            html += `
                                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <strong>é”€å”®å•: ${record.sale_id}</strong>
                                        <span>${date}</span>
                                    </div>
                                    <div style="font-size: 0.9rem; color: #666;">
                                        å®¢æˆ·: ${record.customer_id} | äº§å“: ${record.product_id}
                                    </div>
                                    <div style="font-size: 0.9rem;">
                                        æ•°é‡: ${record.quantity} | å•ä»·: ${record.unit_price}å…ƒ | æ€»é¢: <strong>${record.total_amount}å…ƒ</strong>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    document.getElementById('salesRecords').innerHTML = html;
                } else {
                    throw new Error(data.error || 'åŠ è½½é”€å”®è®°å½•å¤±è´¥');
                }
            } catch (error) {
                document.getElementById('salesRecords').innerHTML = `<p class="error">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }

        async function loadInventoryOverview() {
            try {
                document.getElementById('inventoryOverview').innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        åŠ è½½åº“å­˜æ•°æ®...
                    </div>
                `;
                
                const data = await apiCall({ action: 'getInventoryOverview' });
                
                if (data.success) {
                    let html = '';
                    
                    if (data.data.length === 0) {
                        html = '<p>æš‚æ— åº“å­˜æ•°æ®</p>';
                    } else {
                        html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                        data.data.forEach(item => {
                            html += `
                                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <strong>${item.model_id} ${item.model_name}</strong>
                                        <span class="stock-badge">${item.stock}ä¸ª</span>
                                    </div>
                                    <div style="font-size: 0.9rem; color: #666;">
                                        è§„æ ¼: ${item.color} | ä»·æ ¼: ${item.price}å…ƒ
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    document.getElementById('inventoryOverview').innerHTML = html;
                } else {
                    throw new Error(data.error || 'åŠ è½½åº“å­˜æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                document.getElementById('inventoryOverview').innerHTML = `<p class="error">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }

        // æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°
        function showMessage(message, type, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            if (type !== 'info') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }

        function hideMessage(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }
    </script>
</body>
</html>
