<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>赛娜眼镜进销存</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* 基础重置和变量定义 */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-bg: #f5f5f5;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-muted: #666666;
            --border-color: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
            padding-bottom: 80px;
        }

        /* 顶部导航 */
        .app-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 15px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .icon-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.1rem;
            padding: 5px;
            cursor: pointer;
        }

        /* 主内容区 */
        .app-main {
            margin-top: 60px;
            padding: 15px;
            min-height: calc(100vh - 140px);
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 底部导航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid var(--border-color);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-muted);
            font-size: 0.8rem;
            padding: 5px 10px;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 80px;
        }

        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        /* 卡片样式 */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
        }

        /* 页面管理 */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
            text-align: left;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: var(--card-bg);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-block {
            width: 100%;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-warning {
            background: var(--warning-color);
            color: #000;
        }

        .btn-danger {
            background: var(--danger-color);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        /* 产品选择按钮 */
        .product-select-btn {
            background: var(--light-bg);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .product-select-btn:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        .product-select-btn i {
            font-size: 2rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .selected-product {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
        }

        .selected-product h4 {
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .selected-product p {
            color: var(--text-muted);
            margin-bottom: 3px;
            font-size: 0.9rem;
        }

        /* 颜色选择 */
        .color-selection {
            margin-top: 15px;
        }

        .color-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .color-option {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .color-option.selected {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        /* 销售表单样式 */
        .sale-form {
            margin-top: 10px;
        }

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .item-list {
            margin-top: 20px;
        }

        .item-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-info h4 {
            margin-bottom: 5px;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qty-btn {
            background: #ddd;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
        }

        .total-section {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* 客户欠款显示 */
        .customer-balance {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .balance-warning {
            color: #856404;
            font-weight: 500;
        }

        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-body {
            padding: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        /* 产品选择网格 */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .product-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .product-card.selected {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        .product-image {
            width: 60px;
            height: 60px;
            background: #f0f0f0;
            border-radius: 6px;
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--text-muted);
        }

        .product-name {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .product-price {
            font-size: 0.8rem;
            color: var(--success-color);
            font-weight: 600;
        }

        .product-stock {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* 小票样式 */
        .receipt {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px dashed #333;
        }

        .receipt-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .receipt-info {
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .receipt-info div {
            margin-bottom: 3px;
        }

        .receipt-items {
            width: 100%;
            margin-bottom: 10px;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .receipt-item-name {
            flex: 2;
        }

        .receipt-item-details {
            flex: 1;
            text-align: right;
        }

        .receipt-divider {
            border-top: 1px dashed #333;
            margin: 10px 0;
        }

        .receipt-total {
            text-align: right;
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 10px;
        }

        .receipt-footer {
            text-align: center;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #333;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .receipt-balance {
            background: #fff3cd;
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        /* 价格提示 */
        .price-note {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .special-price {
            color: var(--success-color);
            font-weight: 500;
        }

        /* 消息提示 */
        .message {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* 调试信息 */
        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* 工具类 */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-success { color: var(--success-color); }
        .text-danger { color: var(--danger-color); }
        .text-warning { color: var(--warning-color); }
        .mt-1 { margin-top: 5px; }
        .mt-2 { margin-top: 10px; }
        .mb-1 { margin-bottom: 5px; }
        .mb-2 { margin-bottom: 10px; }
        .hidden { display: none; }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .app-main {
                padding: 10px;
            }
            
            .card {
                padding: 12px;
            }
            
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        @media (max-width: 480px) {
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <header class="app-header">
        <div class="header-content">
            <h1 class="app-title" id="pageTitle">扫码出入库</h1>
            <div class="header-actions">
                <button class="icon-btn" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="app-main">
        <!-- 加载状态 -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>系统初始化中...</p>
            <div id="initDebug" class="debug-info"></div>
        </div>
        
        <!-- 动态内容区 -->
        <div id="content" style="display: none;">
            <!-- 扫码出入库页面 -->
            <div id="scan-page" class="page active">
                <div class="card">
                    <div class="scan-section">
                        <div class="feature-icon">
                            <i class="fas fa-qrcode" style="font-size: 3rem; color: var(--primary-color);"></i>
                        </div>
                        <h2>扫码快速出入库</h2>
                        <p style="color: var(--text-muted); margin: 10px 0;">扫描产品二维码快速处理网店订单</p>
                        
                        <button class="btn btn-block" id="startScan">
                            <i class="fas fa-camera"></i>开始扫码
                        </button>
                    </div>

                    <div class="manual-input">
                        <h3 style="margin-bottom: 15px;">手动输入</h3>
                        
                        <!-- 产品选择 -->
                        <div class="product-select-btn" id="scanProductSelectBtn">
                            <i class="fas fa-plus-circle"></i>
                            <div>选择产品系列</div>
                        </div>

                        <!-- 选中的产品显示 -->
                        <div id="scanSelectedProduct" class="selected-product hidden">
                            <h4 id="scanProductName"></h4>
                            <p id="scanProductColor"></p>
                            <p id="scanProductPrice"></p>
                        </div>

                        <!-- 颜色选择 -->
                        <div class="color-selection" id="scanColorSelection" style="display: none;">
                            <label class="form-label">选择颜色</label>
                            <div class="color-options" id="scanColorOptions">
                                <!-- 颜色选项将通过JS动态生成 -->
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">数量</label>
                            <input type="number" class="form-input" id="scanQuantity" value="1" min="1">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">操作类型</label>
                            <select class="form-select" id="scanType">
                                <option value="out">销售出库</option>
                                <option value="in">采购入库</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-block" id="confirmScan">
                            <i class="fas fa-check"></i>确认操作
                        </button>
                    </div>
                </div>

                <div id="scanMessage"></div>
            </div>

            <!-- 线下销售页面 -->
            <div id="sale-page" class="page">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">线下销售出库</h3>
                        <button class="btn btn-warning" onclick="app.useTestData()" style="padding: 8px 12px;">
                            <i class="fas fa-vial"></i>测试数据
                        </button>
                    </div>
                    
                    <div class="sale-form">
                        <!-- 客户选择与欠款显示 -->
                        <div class="form-group">
                            <label class="form-label">选择客户</label>
                            <select class="form-select" id="customerSelect">
                                <option value="">请选择客户...</option>
                            </select>
                            <div id="customerBalance" class="customer-balance hidden">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span class="balance-warning">该客户有待收款金额: ¥<span id="balanceAmount">0</span></span>
                            </div>
                        </div>

                        <!-- 产品选择 -->
                        <div class="product-select-btn" id="saleProductSelectBtn">
                            <i class="fas fa-plus-circle"></i>
                            <div>点击选择产品</div>
                        </div>

                        <!-- 选中的产品显示 -->
                        <div id="saleSelectedProduct" class="selected-product hidden">
                            <h4 id="saleProductName"></h4>
                            <p id="saleProductColor"></p>
                            <p id="saleProductPrice"></p>
                            <p id="saleProductStock"></p>
                            <div id="priceNote" class="price-note"></div>
                        </div>

                        <!-- 颜色选择 -->
                        <div class="color-selection" id="saleColorSelection" style="display: none;">
                            <label class="form-label">选择颜色</label>
                            <div class="color-options" id="saleColorOptions">
                                <!-- 颜色选项将通过JS动态生成 -->
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">数量</label>
                                <input type="number" class="form-input" id="saleQuantity" value="1" min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">单价</label>
                                <input type="number" class="form-input" id="unitPrice" placeholder="输入单价">
                                <div class="price-note">可手动修改为客户专属价格</div>
                            </div>
                        </div>

                        <button class="btn btn-block" id="addItemBtn">
                            <i class="fas fa-plus"></i>添加到销售单
                        </button>
                    </div>

                    <!-- 销售商品清单 -->
                    <div class="item-list" id="saleItems" style="display: none;">
                        <h4>销售商品清单</h4>
                        <div id="itemsList"></div>
                        
                        <div class="total-section">
                            总计: ¥<span id="totalAmount">0</span>
                        </div>
                        
                        <button class="btn btn-success btn-block" id="confirmSale">
                            <i class="fas fa-check-circle"></i>确认销售出库
                        </button>
                    </div>
                </div>

                <div id="saleMessage"></div>

                <!-- 销售单预览 -->
                <div id="invoicePreview" class="card" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">销售单预览</h3>
                        <button class="btn" id="downloadInvoice">
                            <i class="fas fa-download"></i>下载销售单
                        </button>
                    </div>
                    <div id="invoiceContent"></div>
                </div>
            </div>

            <!-- 数据查看页面 -->
            <div id="data-page" class="page">
                <div class="card">
                    <div class="feature-icon" style="text-align: center; font-size: 2rem; color: var(--primary-color); margin-bottom: 15px;">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h3 style="text-align: center;">数据查看</h3>
                    <p style="text-align: center; color: var(--text-muted); margin-bottom: 20px;">销售记录、库存查询等功能</p>
                    <div class="status-badge" style="background: #fff3cd; color: #856404; padding: 8px 12px; border-radius: 6px; text-align: center;">
                        功能开发中
                    </div>
                </div>
            </div>

            <!-- 基础数据页面 -->
            <div id="base-page" class="page">
                <div class="card">
                    <div class="feature-icon" style="text-align: center; font-size: 2rem; color: var(--primary-color); margin-bottom: 15px;">
                        <i class="fas fa-cog"></i>
                    </div>
                    <h3 style="text-align: center;">基础数据管理</h3>
                    <p style="text-align: center; color: var(--text-muted); margin-bottom: 20px;">产品、客户管理等设置</p>
                    <div class="status-badge" style="background: #fff3cd; color: #856404; padding: 8px 12px; border-radius: 6px; text-align: center;">
                        功能开发中
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 产品选择弹窗 -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>选择产品系列</h3>
                <button class="close-btn" id="closeProductModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="product-grid" id="modalProductGrid">
                    <!-- 产品卡片将通过JS动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 底部导航 -->
    <nav class="bottom-nav">
        <a href="#scan" class="nav-item active" data-page="scan">
            <i class="fas fa-qrcode"></i>
            <span>扫码出入库</span>
        </a>
        <a href="#sale" class="nav-item" data-page="sale">
            <i class="fas fa-receipt"></i>
            <span>线下销售</span>
        </a>
        <a href="#data" class="nav-item" data-page="data">
            <i class="fas fa-chart-bar"></i>
            <span>数据查看</span>
        </a>
        <a href="#base" class="nav-item" data-page="base">
            <i class="fas fa-cog"></i>
            <span>基础数据</span>
        </a>
    </nav>

    <script>
        // API配置
const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbzk28_Sa2LdS0ztE-Wze3YOmcWOoDuZtfpWCcAOO-nTWm8ZPslzEEd_NHVg7HUot0fyHw/exec';        
        class App {
            constructor() {
                this.currentPage = 'scan';
                this.saleItems = [];
                this.productVariants = {};
                this.products = [];
                this.customers = [];
                this.salesRecords = [];
                this.selectedProduct = null;
                this.selectedVariant = null;
                this.useTestMode = false;
                this.productModalSource = null;
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.hideLoading();
                this.loadInitialData();
            }
            
            bindEvents() {
                // 底部导航点击事件
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = item.getAttribute('data-page');
                        this.switchPage(page);
                    });
                });
                
                // 扫码页面事件
                document.getElementById('startScan').addEventListener('click', () => {
                    this.startScan();
                });
                
                document.getElementById('confirmScan').addEventListener('click', () => {
                    this.confirmScanOperation();
                });

                document.getElementById('scanProductSelectBtn').addEventListener('click', () => {
                    this.openProductModal('scan');
                });
                
                // 销售页面事件
                document.getElementById('customerSelect').addEventListener('change', (e) => {
    this.clearSaleForm();
    this.updateCustomerBalance(e.target.value);
    // 如果已选择产品，重新显示颜色选项以更新价格
    if (this.selectedProduct) {
        this.showColorSelection('sale');
    }
});
                
                document.getElementById('saleProductSelectBtn').addEventListener('click', () => {
                    this.openProductModal('sale');
                });
                
                document.getElementById('saleQuantity').addEventListener('change', () => {
                    this.updateItemTotal();
                });
                
                document.getElementById('addItemBtn').addEventListener('click', () => {
                    this.addSaleItem();
                });
                
                document.getElementById('confirmSale').addEventListener('click', () => {
                    this.confirmSale();
                });

                document.getElementById('downloadInvoice').addEventListener('click', () => {
                    this.downloadInvoice();
                });

                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.refreshData();
                });

                // 弹窗事件
                document.getElementById('closeProductModal').addEventListener('click', () => {
                    this.closeProductModal();
                });

                // 点击弹窗外部关闭
                document.getElementById('productModal').addEventListener('click', (e) => {
                    if (e.target.id === 'productModal') {
                        this.closeProductModal();
                    }
                });
            }

            // 打开产品选择弹窗
            openProductModal(source) {
                this.productModalSource = source;
                this.renderProductModal();
                document.getElementById('productModal').classList.add('show');
            }

            // 关闭产品选择弹窗
            closeProductModal() {
                document.getElementById('productModal').classList.remove('show');
                this.productModalSource = null;
            }

            // 渲染产品选择弹窗
            renderProductModal() {
                const container = document.getElementById('modalProductGrid');
                container.innerHTML = '';
                
                this.products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.dataset.modelId = product.model_id;
                    productCard.innerHTML = `
                        <div class="product-image">
                            <i class="fas fa-glasses"></i>
                        </div>
                        <div class="product-name">${product.model_name}</div>
                        <div class="product-stock">点击选择</div>
                    `;
                    
                    productCard.addEventListener('click', () => {
                        this.selectProductInModal(product.model_id);
                    });
                    
                    container.appendChild(productCard);
                });
            }

            // 在弹窗中选择产品
            selectProductInModal(modelId) {
                this.selectedProduct = this.products.find(p => p.model_id === modelId);
                this.closeProductModal();
                
                // 根据来源更新对应的界面
                if (this.productModalSource === 'scan') {
                    this.updateScanProductDisplay();
                } else if (this.productModalSource === 'sale') {
                    this.updateSaleProductDisplay();
                }
                
                // 显示颜色选择
                this.showColorSelection(this.productModalSource);
            }

            // 更新扫码页面的产品显示
            updateScanProductDisplay() {
                const container = document.getElementById('scanSelectedProduct');
                const productName = document.getElementById('scanProductName');
                
                // 显示选中产品区域，隐藏选择按钮
                container.classList.remove('hidden');
                document.getElementById('scanProductSelectBtn').style.display = 'none';
                productName.textContent = this.selectedProduct.model_name;
                
                // 重置颜色选择
                document.getElementById('scanProductColor').textContent = '';
                document.getElementById('scanProductPrice').textContent = '';
                this.selectedVariant = null;
            }

            // 更新销售页面的产品显示
            updateSaleProductDisplay() {
                const container = document.getElementById('saleSelectedProduct');
                const productName = document.getElementById('saleProductName');
                
                // 显示选中产品区域，隐藏选择按钮
                container.classList.remove('hidden');
                document.getElementById('saleProductSelectBtn').style.display = 'none';
                productName.textContent = this.selectedProduct.model_name;
                
                // 重置颜色选择
                document.getElementById('saleProductColor').textContent = '';
                document.getElementById('saleProductPrice').textContent = '';
                document.getElementById('saleProductStock').textContent = '';
                document.getElementById('unitPrice').value = '';
                document.getElementById('priceNote').innerHTML = '';
                this.selectedVariant = null;
            }


            // 显示颜色选择
async showColorSelection(source) {
    const colorSelection = source === 'scan' ? 
        document.getElementById('scanColorSelection') : 
        document.getElementById('saleColorSelection');
    
    const colorOptions = source === 'scan' ? 
        document.getElementById('scanColorOptions') : 
        document.getElementById('saleColorOptions');
    
    colorSelection.style.display = 'block';
    colorOptions.innerHTML = '';
    
    const variants = this.productVariants[this.selectedProduct.model_id] || [];
    
    // 获取当前选择的客户ID
    const customerId = document.getElementById('customerSelect').value;
    
    for (const variant of variants) {
        // 获取客户专属价格
        let displayPrice = variant.price;
        if (customerId && source === 'sale') {
            const customerPrice = await this.getCustomerPrice(customerId, variant.variant_id);
            if (customerPrice !== null) {
                displayPrice = customerPrice;
            }
        }
        
        const colorOption = document.createElement('div');
        colorOption.className = 'color-option';
        colorOption.dataset.variantId = variant.variant_id;
        colorOption.innerHTML = `
            ${variant.color} 
            <span style="font-size: 0.8rem; color: #666;">
                (库存: ${variant.stock}, ¥${displayPrice})
            </span>
        `;
        
        colorOption.addEventListener('click', () => {
            this.selectVariant(variant.variant_id, source);
        });
        
        colorOptions.appendChild(colorOption);
    }
}

            // 选择颜色变体
async selectVariant(variantId, source) {
    // 更新选中状态
    const colorOptions = source === 'scan' ? 
        document.getElementById('scanColorOptions') : 
        document.getElementById('saleColorOptions');
    
    document.querySelectorAll('.color-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelector(`.color-option[data-variant-id="${variantId}"]`).classList.add('selected');
    
    this.selectedVariant = this.findVariantById(variantId);
    
    // 更新显示
    if (source === 'scan') {
        document.getElementById('scanProductColor').textContent = `颜色: ${this.selectedVariant.color}`;
        document.getElementById('scanProductPrice').textContent = `价格: ¥${this.selectedVariant.price}`;
    } else if (source === 'sale') {
        document.getElementById('saleProductColor').textContent = `颜色: ${this.selectedVariant.color}`;
        document.getElementById('saleProductStock').textContent = `库存: ${this.selectedVariant.stock}`;
        
        // 重要：自动填充单价（优先客户专属价格）
        await this.updateProductPrice();
    }
}

           // 更新产品价格（优先客户专属价格）
async updateProductPrice() {
    if (!this.selectedVariant) return;

    const customerId = document.getElementById('customerSelect').value;
    let finalPrice = this.selectedVariant.price;
    let priceNote = '标准价格';

    // 如果有选择客户，尝试获取专属价格
    if (customerId) {
        const customerPrice = await this.getCustomerPrice(customerId, this.selectedVariant.variant_id);
        if (customerPrice !== null) {
            finalPrice = customerPrice;
            priceNote = `<span class="special-price">客户专属价格</span>`;
        }
    }

    // 更新显示和单价输入框
    document.getElementById('saleProductPrice').textContent = `价格: ¥${finalPrice}`;
    document.getElementById('unitPrice').value = finalPrice;  // 这行确保单价输入框有值
    document.getElementById('priceNote').innerHTML = priceNote;
}

            // 获取客户专属价格
            async getCustomerPrice(customerId, variantId) {
                try {
                    const response = await fetch(`${API_BASE_URL}?action=getCustomerPrice&customer_id=${customerId}&variant_id=${variantId}`);
                    const data = await response.json();
                    return data.success ? data.data : null;
                } catch (error) {
                    console.error('获取客户价格失败:', error);
                    return null;
                }
            }

            // 使用测试数据
            useTestData() {
                this.useTestMode = true;
                this.addTestCustomers();
                this.addTestProducts();
                this.loadTestSalesRecords();
                this.showMessage('saleMessage', '已切换到测试模式，使用模拟数据', 'success');
            }
            
            async refreshData() {
                this.showMessage('saleMessage', '重新加载数据中...', 'success');
                await this.loadInitialData();
            }
            
            switchPage(page) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-page="${page}"]`).classList.add('active');
                
                this.showPage(page);
                this.currentPage = page;
                this.updatePageTitle(page);
            }
            
            showPage(page) {
                document.querySelectorAll('.page').forEach(pageEl => {
                    pageEl.classList.remove('active');
                });
                
                const targetPage = document.getElementById(`${page}-page`);
                if (targetPage) {
                    targetPage.classList.add('active');
                }
            }
            
            updatePageTitle(page) {
                const titles = {
                    'scan': '扫码出入库',
                    'sale': '线下销售', 
                    'data': '数据查看',
                    'base': '基础数据'
                };
                document.getElementById('pageTitle').textContent = titles[page] || '赛娜眼镜进销存';
            }
            
            hideLoading() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            }
            
            async loadInitialData() {
                const debugInfo = document.getElementById('initDebug');
                debugInfo.innerHTML = '开始加载初始数据...';
                
                try {
                    await this.loadCustomers();
                    await this.loadProducts();
                    await this.loadSalesRecords();
                    debugInfo.innerHTML = '数据加载完成！';
                } catch (error) {
                    debugInfo.innerHTML = `数据加载失败: ${error.message}`;
                    this.useTestData();
                    this.showMessage('scanMessage', '使用测试数据模式', 'warning');
                    this.showMessage('saleMessage', '使用测试数据模式', 'warning');
                }
            }
            
            async loadCustomers() {
                try {
                    const response = await fetch(`${API_BASE_URL}?action=getCustomers&t=${Date.now()}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.customers = data.data;
                        const select = document.getElementById('customerSelect');
                        select.innerHTML = '<option value="">请选择客户...</option>';
                        
                        data.data.forEach(customer => {
                            const option = document.createElement('option');
                            option.value = customer.customer_id;
                            option.textContent = customer.name;
                            select.appendChild(option);
                        });
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    console.error('加载客户失败:', error);
                    throw error;
                }
            }

            addTestCustomers() {
                this.customers = [
                    { customer_id: 'C001', name: '张三贸易' },
                    { customer_id: 'C002', name: '李四光学' },
                    { customer_id: 'C003', name: '王五眼镜店' },
                    { customer_id: 'C004', name: '网店客户' }
                ];
                
                const select = document.getElementById('customerSelect');
                select.innerHTML = '<option value="">请选择客户...</option>';
                this.customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.customer_id;
                    option.textContent = customer.name;
                    select.appendChild(option);
                });
            }
            
            async loadProducts() {
                try {
                    const response = await fetch(`${API_BASE_URL}?action=getProducts&t=${Date.now()}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.products = data.data;
                        
                        // 加载所有变体
                        for (const product of this.products) {
                            await this.loadProductVariants(product.model_id);
                        }
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    console.error('加载产品失败:', error);
                    throw error;
                }
            }

            addTestProducts() {
                this.products = [
                    { model_id: 'M001', model_name: '经典金属系列' },
                    { model_id: 'M002', model_name: '时尚塑胶系列' },
                    { model_id: 'M003', model_name: '运动休闲系列' }
                ];
                
                // 添加测试变体数据
                this.productVariants = {
                    'M001': [
                        { variant_id: 'V001', model_id: 'M001', color: '黑色', price: 299, stock: 50, product_image: '' },
                        { variant_id: 'V002', model_id: 'M001', color: '银色', price: 299, stock: 30, product_image: '' }
                    ],
                    'M002': [
                        { variant_id: 'V003', model_id: 'M002', color: '棕色', price: 199, stock: 25, product_image: '' }
                    ],
                    'M003': [
                        { variant_id: 'V004', model_id: 'M003', color: '蓝色', price: 399, stock: 40, product_image: '' }
                    ]
                };
            }

            async loadProductVariants(modelId) {
                try {
                    const response = await fetch(`${API_BASE_URL}?action=getProductVariants&model_id=${modelId}&t=${Date.now()}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        if (!this.productVariants[modelId]) {
                            this.productVariants[modelId] = [];
                        }
                        this.productVariants[modelId] = data.data;
                    }
                } catch (error) {
                    console.error(`加载产品变体失败 (${modelId}):`, error);
                }
            }

            findVariantById(variantId) {
                for (const modelId in this.productVariants) {
                    const variant = this.productVariants[modelId].find(v => v.variant_id === variantId);
                    if (variant) return variant;
                }
                return null;
            }

            async loadSalesRecords() {
                try {
                    const response = await fetch(`${API_BASE_URL}?action=getSalesRecords&t=${Date.now()}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.salesRecords = data.data;
                    }
                } catch (error) {
                    console.error('加载销售记录失败:', error);
                    // 不抛出错误，因为销售记录不是关键数据
                }
            }

            loadTestSalesRecords() {
                this.salesRecords = [
                    { sale_id: 'S001', customer_id: 'C001', total_amount: 598, status: '待收款' },
                    { sale_id: 'S002', customer_id: 'C001', total_amount: 897, status: '待收款' },
                    { sale_id: 'S003', customer_id: 'C002', total_amount: 199, status: '待收款' }
                ];
            }

            // 清空销售表单
            clearSaleForm() {
                this.saleItems = [];
                this.updateSaleItemsDisplay();
                this.selectedProduct = null;
                this.selectedVariant = null;
                
                // 重置产品选择
                document.getElementById('saleSelectedProduct').classList.add('hidden');
                document.getElementById('saleProductSelectBtn').style.display = 'block';
                document.getElementById('saleColorSelection').style.display = 'none';
                document.getElementById('saleQuantity').value = 1;
                document.getElementById('unitPrice').value = '';
                document.getElementById('priceNote').innerHTML = '';
                
                this.showMessage('saleMessage', '已清空销售清单', 'success');
            }

            updateCustomerBalance(customerId) {
                const balanceElement = document.getElementById('customerBalance');
                const balanceAmount = document.getElementById('balanceAmount');
                
                if (!customerId) {
                    balanceElement.classList.add('hidden');
                    return;
                }
                
                const pendingAmount = this.calculatePendingAmount(customerId);
                
                if (pendingAmount > 0) {
                    balanceAmount.textContent = pendingAmount.toFixed(2);
                    balanceElement.classList.remove('hidden');
                } else {
                    balanceElement.classList.add('hidden');
                }
            }

            calculatePendingAmount(customerId) {
                return this.salesRecords
                    .filter(record => record.customer_id === customerId && record.status === '待收款')
                    .reduce((sum, record) => sum + record.total_amount, 0);
            }

            updateItemTotal() {
                // 如果需要实时计算总价可以在这里实现
            }
            
            addSaleItem() {
                const customerId = document.getElementById('customerSelect').value;
                const quantity = parseInt(document.getElementById('saleQuantity').value);
                const unitPrice = parseFloat(document.getElementById('unitPrice').value);
                
                if (!customerId) {
                    this.showMessage('saleMessage', '请选择客户', 'error');
                    return;
                }

                if (!this.selectedVariant) {
                    this.showMessage('saleMessage', '请选择产品颜色', 'error');
                    return;
                }

                if (!quantity || quantity < 1) {
                    this.showMessage('saleMessage', '请输入正确的数量', 'error');
                    return;
                }

                if (!unitPrice || unitPrice < 0) {
                    this.showMessage('saleMessage', '请输入正确的单价', 'error');
                    return;
                }

                if (this.selectedVariant.stock < quantity) {
                    this.showMessage('saleMessage', `库存不足，当前库存: ${this.selectedVariant.stock}`, 'error');
                    return;
                }
                
                const item = {
                    customerId,
                    variantId: this.selectedVariant.variant_id,
                    variantName: `${this.selectedProduct.model_name} - ${this.selectedVariant.color}`,
                    quantity,
                    unitPrice: unitPrice,  // 使用实际输入的价格
                    total: quantity * unitPrice
                };
                
                this.saleItems.push(item);
                this.updateSaleItemsDisplay();
                this.showMessage('saleMessage', '商品已添加到销售单', 'success');
                
                // 重置数量
                document.getElementById('saleQuantity').value = 1;
            }
            
            updateSaleItemsDisplay() {
                const itemsList = document.getElementById('itemsList');
                const totalAmount = document.getElementById('totalAmount');
                const saleItemsSection = document.getElementById('saleItems');
                
                itemsList.innerHTML = '';
                let total = 0;
                
                this.saleItems.forEach((item, index) => {
                    total += item.total;
                    
                    const itemCard = document.createElement('div');
                    itemCard.className = 'item-card';
                    itemCard.innerHTML = `
                        <div class="item-info">
                            <h4>${item.variantName}</h4>
                            <p>数量: ${item.quantity} × ¥${item.unitPrice}</p>
                        </div>
                        <div class="item-actions">
                            <span>¥${item.total}</span>
                            <button class="qty-btn" onclick="app.removeSaleItem(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    itemsList.appendChild(itemCard);
                });
                
                totalAmount.textContent = total.toFixed(2);
                saleItemsSection.style.display = this.saleItems.length > 0 ? 'block' : 'none';
            }
            
            removeSaleItem(index) {
                this.saleItems.splice(index, 1);
                this.updateSaleItemsDisplay();
            }
            
            async confirmSale() {
                if (this.saleItems.length === 0) {
                    this.showMessage('saleMessage', '请添加销售商品', 'error');
                    return;
                }

                const customerId = document.getElementById('customerSelect').value;
                const customer = this.customers.find(c => c.customer_id === customerId);

                if (this.useTestMode) {
                    // 测试模式 - 模拟成功
                    this.showMessage('saleMessage', '测试模式: 销售出库成功！', 'success');
                    this.generateReceipt(customer.name);
                    this.clearSaleForm();
                    return;
                }

                try {
                    // 为每个商品创建销售记录
                    for (const item of this.saleItems) {
                        const saleData = {
                            customer_id: item.customerId,
                            variant_id: item.variantId,
                            quantity: item.quantity,
                            operator: '销售员'
                        };

                        // 构建URL参数 - 确保参数正确传递
                        const params = new URLSearchParams();
                        params.append('action', 'createSale');
                        params.append('customer_id', saleData.customer_id);
                        params.append('variant_id', saleData.variant_id);
                        params.append('quantity', saleData.quantity.toString());
                        params.append('operator', saleData.operator);

                        console.log('销售参数:', params.toString());

                        const response = await fetch(`${API_BASE_URL}?${params}`);
                        const result = await response.json();
                        
                        if (!result.success) {
                            throw new Error(result.message || `销售失败: ${item.variantName}`);
                        }
                    }

                    this.showMessage('saleMessage', '销售出库成功！', 'success');
                    this.generateReceipt(customer.name);
                    this.clearSaleForm();
                    
                    // 重新加载数据
                    await this.loadSalesRecords();
                    
                } catch (error) {
                    console.error('销售失败:', error);
                    this.showMessage('saleMessage', '销售失败: ' + error.message, 'error');
                }
            }

            generateReceipt(customerName) {
                const invoiceContent = document.getElementById('invoiceContent');
                const invoicePreview = document.getElementById('invoicePreview');
                const now = new Date();
                const invoiceNumber = 'SN' + now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0') + String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');

                let itemsHTML = '';
                let totalAmount = 0;

                this.saleItems.forEach(item => {
                    totalAmount += item.total;
                    itemsHTML += `
                        <div class="receipt-item">
                            <div class="receipt-item-name">${item.variantName}</div>
                            <div class="receipt-item-details">${item.quantity} × ¥${item.unitPrice}</div>
                        </div>
                        <div class="receipt-item">
                            <div class="receipt-item-name"></div>
                            <div class="receipt-item-details">¥${item.total}</div>
                        </div>
                    `;
                });

                const customerId = document.getElementById('customerSelect').value;
                const pendingAmount = this.calculatePendingAmount(customerId);

                invoiceContent.innerHTML = `
                    <div class="receipt" id="receiptToDownload">
                        <div class="receipt-header">
                            <div class="receipt-title">赛娜眼镜</div>
                            <div>销售单据</div>
                        </div>
                        
                        <div class="receipt-info">
                            <div>单号: ${invoiceNumber}</div>
                            <div>日期: ${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}</div>
                            <div>时间: ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}</div>
                        </div>
                        
                        <div class="receipt-info">
                            <div>客户: ${customerName}</div>
                        </div>
                        
                        <div class="receipt-divider"></div>
                        
                        <div class="receipt-items">
                            ${itemsHTML}
                        </div>
                        
                        <div class="receipt-divider"></div>
                        
                        <div class="receipt-total">
                            合计: ¥${totalAmount.toFixed(2)}
                        </div>
                        
                        ${pendingAmount > 0 ? `
                        <div class="receipt-balance">
                            <div>累计待收款: ¥${pendingAmount.toFixed(2)}</div>
                            <div>本次后累计: ¥${(pendingAmount + totalAmount).toFixed(2)}</div>
                        </div>
                        ` : ''}
                        
                        <div class="receipt-footer">
                            <div>感谢您的惠顾！</div>
                            <div>赛娜眼镜 - 品质保证</div>
                        </div>
                    </div>
                `;

                invoicePreview.style.display = 'block';
            }

            async downloadInvoice() {
                const receiptElement = document.getElementById('receiptToDownload');
                
                try {
                    const canvas = await html2canvas(receiptElement, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff'
                    });
                    
                    const link = document.createElement('a');
                    link.download = `赛娜眼镜销售单_${new Date().getTime()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    this.showMessage('saleMessage', '销售单下载成功', 'success');
                } catch (error) {
                    console.error('下载销售单失败:', error);
                    this.showMessage('saleMessage', '下载失败: ' + error.message, 'error');
                }
            }
            
            startScan() {
                alert('扫码功能开发中...\n\n请使用手动输入功能');
            }
            
            async confirmScanOperation() {
                if (!this.selectedVariant) {
                    this.showMessage('scanMessage', '请选择产品颜色', 'error');
                    return;
                }

                const quantity = parseInt(document.getElementById('scanQuantity').value);
                const scanType = document.getElementById('scanType').value;
                
                if (!quantity || quantity < 1) {
                    this.showMessage('scanMessage', '请输入正确的数量', 'error');
                    return;
                }

                if (this.selectedVariant.stock < quantity) {
                    this.showMessage('scanMessage', `库存不足，当前库存: ${this.selectedVariant.stock}`, 'error');
                    return;
                }

                try {
                    if (this.useTestMode) {
                        // 测试模式
                        this.showMessage('scanMessage', `测试模式: ${this.selectedVariant.variant_id} 出库成功！`, 'success');
                        this.clearScanForm();
                        return;
                    }

                    if (scanType === 'out') {
                        const scanData = {
                            items: [{
                                variant_id: this.selectedVariant.variant_id,
                                quantity: quantity,
                                unit_price: 0
                            }],
                            operator: "网店客服"
                        };

                        const params = new URLSearchParams();
                        params.append('action', 'createScanSale');
                        params.append('items', JSON.stringify(scanData.items));
                        params.append('operator', scanData.operator);
                        
                        const response = await fetch(`${API_BASE_URL}?${params.toString()}`);
                        const data = await response.json();

                        if (data.success) {
                            this.showMessage('scanMessage', `出库成功！销售单号: ${data.results[0].sale_id}`, 'success');
                            this.clearScanForm();
                        } else {
                            throw new Error(data.message);
                        }
                    } else {
                        this.showMessage('scanMessage', '采购入库功能开发中', 'error');
                    }
                    
                } catch (error) {
                    console.error('操作失败:', error);
                    this.showMessage('scanMessage', '操作失败: ' + error.message, 'error');
                }
            }

            clearScanForm() {
                document.getElementById('scanQuantity').value = 1;
                document.getElementById('scanSelectedProduct').classList.add('hidden');
                document.getElementById('scanProductSelectBtn').style.display = 'block';
                document.getElementById('scanColorSelection').style.display = 'none';
                this.selectedProduct = null;
                this.selectedVariant = null;
            }

            showMessage(containerId, message, type) {
                const container = document.getElementById(containerId);
                container.innerHTML = `<div class="message ${type}">${message}</div>`;
                
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new App();
        });
    </script>
</body>
</html>
