<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>销售开单</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
        }
        
        .app-container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        /* 头部样式 */
        .header {
            background: linear-gradient(135deg, #007AFF, #0056CC);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* 标签页样式 */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #007AFF;
            border-bottom-color: #007AFF;
            background: white;
        }
        
        /* 内容区域 */
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 15px;
        }
        
        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #007AFF;
        }
        
        /* 信息显示 */
        .info-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .info-label {
            color: #666;
        }
        
        .info-value {
            font-weight: 500;
            color: #333;
        }
        
        .stock-warning {
            color: #FF3B30;
        }
        
        .price-special {
            color: #FF9500;
            font-weight: 600;
        }
        
        /* 按钮样式 */
        .btn {
            width: 100%;
            padding: 15px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background: #0056CC;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* 消息提示 */
        .message {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
        }
        
        .success {
            background: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }
        
        .error {
            background: #F8D7DA;
            color: #721C24;
            border: 1px solid #F5C6CB;
        }
        
        .info {
            background: #CCE7FF;
            color: #004085;
            border: 1px solid #B3D9FF;
        }
        
        /* 加载状态 */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 记录列表 */
        .record-list {
            background: white;
        }
        
        .record-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .record-customer {
            font-weight: 500;
            color: #333;
        }
        
        .record-date {
            color: #666;
            font-size: 12px;
        }
        
        .record-details {
            color: #666;
            font-size: 14px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 头部 -->
        <div class="header">
            <h1>销售开单</h1>
            <div class="subtitle">专业库存管理</div>
        </div>
        
        <!-- 标签页 -->
        <div class="tabs">
            <div class="tab active" data-tab="sale">开单</div>
            <div class="tab" data-tab="records">记录</div>
            <div class="tab" data-tab="products">产品</div>
        </div>
        
        <!-- 开单标签页 -->
        <div class="tab-content active" id="sale-tab">
            <div class="form-group">
                <label for="customerSelect">选择客户</label>
                <select id="customerSelect">
                    <option value="">加载中...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="productSelect">选择产品型号</label>
                <select id="productSelect">
                    <option value="">请先选择客户</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="variantSelect">选择颜色规格</label>
                <select id="variantSelect">
                    <option value="">请先选择产品型号</option>
                </select>
            </div>
            
            <div class="info-card">
                <div class="info-row">
                    <span class="info-label">单价：</span>
                    <span class="info-value" id="priceDisplay">- 元</span>
                </div>
                <div class="info-row">
                    <span class="info-label">当前库存：</span>
                    <span class="info-value" id="stockDisplay">- 个</span>
                </div>
            </div>
            
            <div class="form-group">
                <label for="quantityInput">销售数量</label>
                <input type="number" id="quantityInput" min="1" value="1" placeholder="请输入数量">
            </div>
            
            <div id="saleMessage"></div>
            
            <button class="btn" id="submitBtn" disabled>确认开单</button>
        </div>
        
        <!-- 记录标签页 -->
        <div class="tab-content" id="records-tab">
            <div class="empty-state">
                销售记录加载中...
            </div>
        </div>
        
        <!-- 产品标签页 -->
        <div class="tab-content" id="products-tab">
            <div class="empty-state">
                产品库存加载中...
            </div>
        </div>
    </div>

    <script>
        // 配置
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycbz2zTkBCQD-EGnicMcF_7l_2UIJZAnAhYUmYZVB3xE3ZtUBUFctP-k0Y_9HaiXPsh45_g/exec'
        };
        
        // 状态管理
        let state = {
            customers: [],
            products: [],
            selectedCustomer: null,
            selectedProduct: null,
            selectedVariant: null
        };
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        function initializeApp() {
            setupTabNavigation();
            setupEventListeners();
            loadInitialData();
        }
        
        function setupTabNavigation() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有active类
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加active类
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab') + '-tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        function setupEventListeners() {
            // 客户选择变化
            document.getElementById('customerSelect').addEventListener('change', function(e) {
                state.selectedCustomer = e.target.value;
                if (state.selectedCustomer) {
                    loadProducts(state.selectedCustomer);
                } else {
                    resetProductSelection();
                }
            });
            
            // 产品选择变化
            document.getElementById('productSelect').addEventListener('change', function(e) {
                state.selectedProduct = e.target.value;
                updateVariants();
            });
            
            // 规格选择变化
            document.getElementById('variantSelect').addEventListener('change', function(e) {
                state.selectedVariant = e.target.value;
                updateProductInfo();
            });
            
            // 数量输入变化
            document.getElementById('quantityInput').addEventListener('input', function() {
                updateSubmitButton();
            });
            
            // 提交按钮
            document.getElementById('submitBtn').addEventListener('click', createSale);
        }
        
        async function loadInitialData() {
            try {
                showMessage('正在连接数据库...', 'info', 'saleMessage');
                await loadCustomers();
            } catch (error) {
                showMessage('连接失败: ' + error.message, 'error', 'saleMessage');
            }
        }
        
        async function loadCustomers() {
            try {
                const response = await fetch(`${CONFIG.API_URL}?action=getCustomers`);
                const data = await response.json();
                
                if (data.success) {
                    state.customers = data.data;
                    const select = document.getElementById('customerSelect');
                    select.innerHTML = '<option value="">请选择客户</option>';
                    
                    state.customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.customer_id;
                        option.textContent = customer.name;
                        select.appendChild(option);
                    });
                    
                    hideMessage('saleMessage');
                } else {
                    throw new Error(data.error || '加载客户数据失败');
                }
            } catch (error) {
                throw new Error('加载客户列表失败: ' + error.message);
            }
        }
        
        async function loadProducts(customerId) {
            try {
                showMessage('正在加载产品信息...', 'info', 'saleMessage');
                const response = await fetch(`${CONFIG.API_URL}?action=getProducts&customerId=${customerId}`);
                const data = await response.json();
                
                if (data.success) {
                    state.products = data.data;
                    updateProductSelect();
                    hideMessage('saleMessage');
                } else {
                    throw new Error(data.error || '加载产品数据失败');
                }
            } catch (error) {
                showMessage('加载产品失败: ' + error.message, 'error', 'saleMessage');
            }
        }
        
        function updateProductSelect() {
            const select = document.getElementById('productSelect');
            select.innerHTML = '<option value="">请选择产品型号</option>';
            
            // 去重产品型号
            const uniqueModels = [...new Set(state.products.map(p => p.model_id))];
            uniqueModels.forEach(modelId => {
                const product = state.products.find(p => p.model_id === modelId);
                const option = document.createElement('option');
                option.value = modelId;
                option.textContent = `${modelId} ${product.model_name}`;
                select.appendChild(option);
            });
            
            resetVariantSelection();
            resetProductInfo();
        }
        
        function updateVariants() {
            const variants = state.products.filter(p => p.model_id === state.selectedProduct);
            const select = document.getElementById('variantSelect');
            select.innerHTML = '<option value="">请选择颜色规格</option>';
            
            variants.forEach(variant => {
                const option = document.createElement('option');
                option.value = variant.variant_id;
                
                // 价格显示
                let priceText = `${variant.price}元`;
                if (variant.price !== variant.standard_price) {
                    priceText = `${variant.price}元 (特价)`;
                }
                
                option.textContent = `${variant.color} - ${priceText}`;
                option.dataset.variant = JSON.stringify(variant);
                select.appendChild(option);
            });
            
            resetProductInfo();
        }
        
        function updateProductInfo() {
            const select = document.getElementById('variantSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value && selectedOption.dataset.variant) {
                const variant = JSON.parse(selectedOption.dataset.variant);
                
                // 更新价格显示
                const priceDisplay = document.getElementById('priceDisplay');
                if (variant.price !== variant.standard_price) {
                    priceDisplay.textContent = `${variant.price}元 (特价)`;
                    priceDisplay.className = 'info-value price-special';
                } else {
                    priceDisplay.textContent = `${variant.price}元`;
                    priceDisplay.className = 'info-value';
                }
                
                // 更新库存显示
                const stockDisplay = document.getElementById('stockDisplay');
                stockDisplay.textContent = `${variant.stock}个`;
                if (variant.stock < 3) {
                    stockDisplay.className = 'info-value stock-warning';
                } else {
                    stockDisplay.className = 'info-value';
                }
                
                updateSubmitButton();
            }
        }
        
        function updateSubmitButton() {
            const quantity = parseInt(document.getElementById('quantityInput').value);
            const select = document.getElementById('variantSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            let hasStock = false;
            if (selectedOption.value && selectedOption.dataset.variant) {
                const variant = JSON.parse(selectedOption.dataset.variant);
                hasStock = quantity > 0 && quantity <= variant.stock;
            }
            
            const btn = document.getElementById('submitBtn');
            btn.disabled = !(state.selectedCustomer && state.selectedVariant && hasStock);
        }
        
        async function createSale() {
            const quantity = parseInt(document.getElementById('quantityInput').value);
            const select = document.getElementById('variantSelect');
            const variant = JSON.parse(select.options[select.selectedIndex].dataset.variant);
            const customerSelect = document.getElementById('customerSelect');
            const customerName = customerSelect.options[customerSelect.selectedIndex].textContent;
            
            const saleData = {
                action: 'createSale',
                data: {
                    customer_id: state.selectedCustomer,
                    customer_name: customerName,
                    variant_id: state.selectedVariant,
                    quantity: quantity,
                    unit_price: variant.price
                }
            };
            
            try {
                // 禁用按钮并显示加载状态
                const btn = document.getElementById('submitBtn');
                btn.disabled = true;
                btn.textContent = '开单中...';
                
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    body: JSON.stringify(saleData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`开单成功！销售单号: ${result.sale_id}`, 'success', 'saleMessage');
                    // 重新加载产品信息更新库存
                    await loadProducts(state.selectedCustomer);
                    // 重置数量
                    document.getElementById('quantityInput').value = 1;
                } else {
                    throw new Error(result.error || '开单失败');
                }
            } catch (error) {
                showMessage('开单失败: ' + error.message, 'error', 'saleMessage');
            } finally {
                // 恢复按钮状态
                const btn = document.getElementById('submitBtn');
                btn.disabled = false;
                btn.textContent = '确认开单';
                updateSubmitButton();
            }
        }
        
        function resetProductSelection() {
            document.getElementById('productSelect').innerHTML = '<option value="">请先选择客户</option>';
            resetVariantSelection();
        }
        
        function resetVariantSelection() {
            document.getElementById('variantSelect').innerHTML = '<option value="">请先选择产品型号</option>';
            resetProductInfo();
        }
        
        function resetProductInfo() {
            document.getElementById('priceDisplay').textContent = '- 元';
            document.getElementById('stockDisplay').textContent = '- 个';
            document.getElementById('stockDisplay').className = 'info-value';
            document.getElementById('priceDisplay').className = 'info-value';
            document.getElementById('quantityInput').value = 1;
            document.getElementById('submitBtn').disabled = true;
        }
        
        function showMessage(message, type, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            if (type !== 'info') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }
        
        function hideMessage(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }
    </script>
</body>
</html>
